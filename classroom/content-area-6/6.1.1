
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>6.1.1 ‚Äî Data, Information & Knowledge // The Mark Scheme Method¬Æ</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&family=Rajdhani:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --void:#0D1117; --surface:#111820; --panel:rgba(255,255,255,0.04);
  --panel-border:rgba(255,255,255,0.08);
  --green:#39FF14; --green-dim:rgba(57,255,20,0.12); --green-glow:rgba(57,255,20,0.3);
  --gold:#FFD700; --gold-dim:rgba(255,215,0,0.1);
  --red:#FF3B3B; --amber:#FF9500; --purple:#A855F7;
  --text-primary:#E8EDF3; --text-dim:rgba(232,237,243,0.45); --text-dimmer:rgba(232,237,243,0.2);
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;background:var(--void);color:var(--text-primary);font-family:'Rajdhani',sans-serif;overflow:hidden}
body::before{content:'';position:fixed;inset:0;background-image:linear-gradient(rgba(57,255,20,0.022) 1px,transparent 1px),linear-gradient(90deg,rgba(57,255,20,0.022) 1px,transparent 1px);background-size:48px 48px;pointer-events:none;z-index:0}
body::after{content:'';position:fixed;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,0.055) 2px,rgba(0,0,0,0.055) 4px);pointer-events:none;z-index:0}

/* ‚îÄ‚îÄ TOPBAR ‚îÄ‚îÄ */
.topbar{position:fixed;top:0;left:0;right:0;height:48px;background:rgba(13,17,23,0.96);backdrop-filter:blur(20px);border-bottom:1px solid var(--panel-border);display:flex;align-items:center;padding:0 24px;z-index:200;gap:16px}
.topbar-brand{font-family:'Orbitron',monospace;font-size:10px;font-weight:700;letter-spacing:2px;color:var(--green);white-space:nowrap}
.topbar-divider{width:1px;height:20px;background:var(--panel-border);flex-shrink:0}
.topbar-title{font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);letter-spacing:1px;white-space:nowrap}
.topbar-dots{display:flex;gap:5px;align-items:center;margin-left:8px}
.sdot{width:7px;height:7px;border-radius:50%;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.12);transition:all .3s}
.sdot.done{background:var(--green);border-color:var(--green);box-shadow:0 0 5px var(--green-glow)}
.sdot.active{background:var(--gold);border-color:var(--gold);box-shadow:0 0 5px rgba(255,215,0,.4)}
.topbar-progress{flex:1;display:flex;align-items:center;gap:10px}
.pb-track{flex:1;height:2px;background:rgba(255,255,255,0.07);border-radius:1px;overflow:hidden}
.pb-fill{height:100%;background:var(--green);box-shadow:0 0 6px var(--green-glow);transition:width .5s ease;border-radius:1px}
.pb-label{font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);letter-spacing:1px;white-space:nowrap}

/* ‚îÄ‚îÄ XP BAR ‚îÄ‚îÄ */
.xpbar{position:fixed;top:48px;left:0;right:0;height:40px;background:rgba(13,17,23,0.9);backdrop-filter:blur(12px);border-bottom:1px solid rgba(57,255,20,0.1);display:flex;align-items:center;padding:0 24px;gap:20px;z-index:199}
.xp-rank{font-family:'Orbitron',monospace;font-size:9px;font-weight:700;letter-spacing:2px;padding:3px 10px;border-radius:3px;border:1px solid rgba(57,255,20,0.3);color:var(--green);background:rgba(57,255,20,0.07);white-space:nowrap;transition:all .3s}
.xp-track{flex:1;height:4px;background:rgba(255,255,255,0.07);border-radius:2px;overflow:hidden}
.xp-fill{height:100%;background:linear-gradient(90deg,var(--green),#a0ff60);box-shadow:0 0 8px var(--green-glow);transition:width .6s cubic-bezier(.34,1.56,.64,1);border-radius:2px}
.xp-total{font-family:'Orbitron',monospace;font-size:11px;font-weight:700;color:var(--green);letter-spacing:1px;min-width:60px;text-align:right}
.xp-divider{width:1px;height:20px;background:var(--panel-border)}
.streak-display{display:flex;align-items:center;gap:6px}
.streak-icon{font-size:14px;transition:transform .2s}
.streak-count{font-family:'Orbitron',monospace;font-size:11px;font-weight:700;min-width:14px;text-align:center}
.streak-mult{font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:1px;padding:2px 6px;border-radius:3px;background:rgba(255,149,0,0.1);border:1px solid rgba(255,149,0,0.25);color:var(--amber)}
.streak-mult.hot{background:rgba(255,59,59,0.12);border-color:rgba(255,59,59,0.3);color:var(--red);animation:pulse-glow 1s ease infinite}
.secrets-btn{font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:1px;padding:3px 10px;border-radius:3px;background:rgba(168,85,247,0.08);border:1px solid rgba(168,85,247,0.2);color:var(--purple);cursor:pointer;transition:all .2s;position:relative;white-space:nowrap}
.secrets-btn:hover{background:rgba(168,85,247,0.14);border-color:rgba(168,85,247,0.4)}
.secrets-badge{position:absolute;top:-5px;right:-5px;background:var(--red);color:#fff;font-size:8px;width:14px;height:14px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:'Orbitron',monospace;font-weight:700;display:none}
.secrets-badge.show{display:flex}

/* ‚îÄ‚îÄ TIMER ‚îÄ‚îÄ */
.timer-wrap{display:flex;align-items:center;gap:8px}
.timer-ring{width:32px;height:32px;flex-shrink:0}
.timer-ring circle{fill:none;stroke-width:3;transition:stroke-dashoffset .9s linear}
.timer-ring .bg{stroke:rgba(255,255,255,0.08)}
.timer-ring .fg{stroke:var(--green);stroke-dasharray:88;stroke-dashoffset:0;stroke-linecap:round;transform:rotate(-90deg);transform-origin:50% 50%}
.timer-ring.warning .fg{stroke:var(--amber)}
.timer-ring.danger  .fg{stroke:var(--red);animation:pulse-glow .5s ease infinite}
.timer-val{font-family:'Orbitron',monospace;font-size:14px;font-weight:700;color:var(--text-primary);min-width:28px;text-align:center;letter-spacing:1px}
.timer-val.danger{color:var(--red)}

/* ‚îÄ‚îÄ MAIN SPLIT ‚îÄ‚îÄ */
.app{position:fixed;top:88px;left:0;right:0;bottom:60px;display:grid;grid-template-columns:44% 1fr;z-index:1}
.theory-panel{overflow-y:auto;padding:28px 36px 24px;border-right:1px solid var(--panel-border);scrollbar-width:thin;scrollbar-color:rgba(57,255,20,0.15) transparent}
.theory-panel::-webkit-scrollbar{width:3px}
.theory-panel::-webkit-scrollbar-thumb{background:rgba(57,255,20,0.15);border-radius:2px}
.task-panel{overflow-y:auto;padding:28px 36px 24px;scrollbar-width:thin;scrollbar-color:rgba(255,215,0,0.15) transparent}
.task-panel::-webkit-scrollbar{width:3px}
.task-panel::-webkit-scrollbar-thumb{background:rgba(255,215,0,0.15);border-radius:2px}

/* Theory styles */
.step-tag{font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:2px;color:var(--green);margin-bottom:6px;display:block}
.theory-heading{font-family:'Orbitron',monospace;font-size:17px;font-weight:900;color:var(--text-primary);line-height:1.3;margin-bottom:18px;letter-spacing:1px}
.theory-heading span{color:var(--green)}
.theory-body{font-size:14px;font-weight:500;line-height:1.7;color:var(--text-primary)}
.theory-body p{margin-bottom:12px}
.hl-green{color:var(--green);font-weight:600}
.hl-gold{color:var(--gold);font-weight:600}
.hl-red{color:var(--red);font-weight:600}
.hl-amber{color:var(--amber);font-weight:600}
.key-term-box{background:rgba(57,255,20,0.04);border:1px solid rgba(57,255,20,0.18);border-left:3px solid var(--green);border-radius:6px;padding:12px 14px;margin:14px 0}
.key-term-box .kt-label{font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:2px;color:var(--green);margin-bottom:6px;display:block}
.key-term-box .kt-term{font-size:13px;font-weight:700;color:var(--text-primary);margin-bottom:3px}
.key-term-box .kt-def{font-size:12px;font-weight:500;color:var(--text-dim);line-height:1.6}
.formula-box{background:rgba(255,215,0,0.04);border:1px solid rgba(255,215,0,0.18);border-radius:6px;padding:12px 14px;margin:14px 0;text-align:center}
.formula-box .formula-text{font-family:'Share Tech Mono',monospace;font-size:12px;color:var(--gold);letter-spacing:1px;line-height:1.8}
.data-example{font-family:'Share Tech Mono',monospace;font-size:12px;color:var(--gold);background:rgba(255,215,0,0.06);border:1px solid rgba(255,215,0,0.15);border-radius:4px;padding:2px 7px;display:inline-block;margin:2px}
.chain-row{display:flex;align-items:center;gap:6px;margin:10px 0;flex-wrap:wrap}
.chain-item{background:var(--panel);border:1px solid var(--panel-border);border-radius:6px;padding:8px 10px;flex:1;text-align:center;min-width:80px}
.chain-item .ci-label{font-family:'Share Tech Mono',monospace;font-size:8px;letter-spacing:1px;margin-bottom:3px}
.chain-item .ci-val{font-size:11px;font-weight:600;line-height:1.3}
.chain-arrow{color:var(--text-dimmer);font-size:14px;flex-shrink:0}
.dikw-pyramid{display:flex;flex-direction:column;gap:3px;margin:12px auto;max-width:260px}
.dikw-row{border-radius:4px;padding:7px 10px;text-align:center;font-size:11px;font-weight:700;letter-spacing:1px;font-family:'Share Tech Mono',monospace}

/* Task styles */
.task-header-row{display:flex;align-items:center;gap:10px;margin-bottom:16px;flex-wrap:wrap}
.task-type-badge{font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:2px;padding:3px 9px;border-radius:4px;border:1px solid rgba(255,215,0,0.3);color:var(--gold);background:rgba(255,215,0,0.06)}
.task-instruction{font-family:'Orbitron',monospace;font-size:12px;font-weight:700;color:var(--text-primary);letter-spacing:1px}
.xp-pill{font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:1px;padding:2px 8px;border-radius:12px;background:rgba(57,255,20,0.08);border:1px solid rgba(57,255,20,0.2);color:var(--green);margin-left:auto}
.task-question{font-size:15px;font-weight:600;line-height:1.6;color:var(--text-primary);margin-bottom:20px}
.task-question .tq-scenario{font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--text-dim);letter-spacing:1px;margin-bottom:8px;display:block}

/* MCQ */
.mcq-options{display:flex;flex-direction:column;gap:8px;margin-bottom:20px}
.mcq-opt{background:var(--panel);border:1px solid var(--panel-border);border-radius:8px;padding:12px 16px;cursor:pointer;display:flex;align-items:center;gap:12px;font-size:14px;font-weight:500;color:var(--text-primary);transition:all .15s ease;user-select:none}
.mcq-opt:hover:not(.locked){border-color:rgba(255,215,0,0.4);background:rgba(255,215,0,0.04)}
.mcq-opt .opt-letter{font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);min-width:16px;letter-spacing:1px}
.mcq-opt.selected{border-color:rgba(255,215,0,0.5);background:rgba(255,215,0,0.04)}
.mcq-opt.correct{border-color:rgba(57,255,20,0.5);background:rgba(57,255,20,0.07);color:var(--green)}
.mcq-opt.correct .opt-letter{color:var(--green)}
.mcq-opt.wrong{border-color:rgba(255,59,59,0.5);background:rgba(255,59,59,0.07);color:var(--red)}
.mcq-opt.wrong .opt-letter{color:var(--red)}
.mcq-opt.reveal{border-color:rgba(57,255,20,0.25);background:rgba(57,255,20,0.04);color:rgba(57,255,20,0.6)}
.mcq-opt.locked{cursor:default;pointer-events:none}

/* FITB */
.fitb-sentence{font-size:15px;font-weight:600;line-height:2.4;color:var(--text-primary);margin-bottom:20px}
.fitb-input{display:inline-block;background:rgba(255,255,255,0.04);border:none;border-bottom:2px solid var(--gold);padding:2px 8px;font-family:'Share Tech Mono',monospace;font-size:12px;color:var(--gold);width:120px;text-align:center;outline:none;transition:all .2s}
.fitb-input:focus{background:rgba(255,215,0,0.05)}
.fitb-input.correct{border-bottom-color:var(--green);color:var(--green)}
.fitb-input.wrong{border-bottom-color:var(--red);color:var(--red)}

/* DnD */
.dnd-layout{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px}
.dnd-chips-area{background:var(--panel);border:1px solid var(--panel-border);border-radius:8px;padding:14px}
.dnd-chips-title{font-family:'Share Tech Mono',monospace;font-size:8px;letter-spacing:2px;color:var(--text-dim);margin-bottom:10px}
.chips-pool{display:flex;flex-direction:column;gap:7px}
.dnd-chip{background:rgba(255,215,0,0.06);border:1px solid rgba(255,215,0,0.22);border-radius:6px;padding:8px 10px;font-size:12px;font-weight:600;color:var(--gold);cursor:grab;user-select:none;transition:all .15s ease}
.dnd-chip:hover{background:rgba(255,215,0,0.1);border-color:var(--gold)}
.dnd-chip.dragging{opacity:.35}
.dnd-chip.placed{opacity:.25;pointer-events:none}
.dnd-targets{display:flex;flex-direction:column;gap:8px}
.drop-zone{background:var(--panel);border:1px dashed rgba(255,255,255,0.12);border-radius:8px;padding:10px 12px;min-height:58px;transition:all .2s}
.drop-zone.over{border-color:var(--gold);background:rgba(255,215,0,0.04)}
.drop-zone.correct-zone{border-color:var(--green);border-style:solid;background:rgba(57,255,20,0.05)}
.drop-zone.wrong-zone{border-color:var(--red);border-style:solid;background:rgba(255,59,59,0.05)}
.dz-label{font-family:'Share Tech Mono',monospace;font-size:8px;letter-spacing:2px;margin-bottom:4px}
.dz-content{font-size:12px;font-weight:600;min-height:18px;color:var(--text-dim);font-style:italic}
.dz-content.filled{color:var(--text-primary);font-style:normal}

/* Short / Exam */
.short-answer-wrap{margin-bottom:16px}
.short-answer-ta{width:100%;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.1);border-radius:8px;padding:14px;font-family:'Rajdhani',sans-serif;font-size:14px;font-weight:500;color:var(--text-primary);resize:none;outline:none;transition:border-color .2s;min-height:100px}
.short-answer-ta:focus{border-color:rgba(255,215,0,0.3)}
.word-count{font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);text-align:right;margin-top:5px;letter-spacing:1px}
.model-answer-box{background:rgba(57,255,20,0.04);border:1px solid rgba(57,255,20,0.18);border-radius:8px;padding:14px 16px;margin-top:14px;display:none;animation:fade-in .4s ease}
.model-answer-box.visible{display:block}
.model-answer-box .ma-label{font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:2px;color:var(--green);margin-bottom:8px;display:block}
.model-answer-box .ma-text{font-size:13px;font-weight:500;line-height:1.7;color:var(--text-primary)}
.nei-tag{display:inline-block;padding:1px 5px;border-radius:3px;font-size:10px;font-weight:700;font-family:'Share Tech Mono',monospace;margin:0 2px}
.nei-n{background:rgba(255,59,59,0.12);color:var(--red);border:1px solid rgba(255,59,59,0.25)}
.nei-e{background:rgba(255,149,0,0.12);color:var(--amber);border:1px solid rgba(255,149,0,0.25)}
.nei-i{background:rgba(57,255,20,0.08);color:var(--green);border:1px solid rgba(57,255,20,0.22)}

/* Feedback */
.feedback-strip{padding:10px 14px;border-radius:6px;font-size:13px;font-weight:600;margin-bottom:14px;display:none;animation:fade-in .3s ease}
.feedback-strip.show{display:block}
.feedback-strip.ok{background:rgba(57,255,20,0.07);border:1px solid rgba(57,255,20,0.22);color:var(--green)}
.feedback-strip.err{background:rgba(255,59,59,0.07);border:1px solid rgba(255,59,59,0.22);color:var(--text-primary)}
.feedback-strip.info{background:rgba(255,215,0,0.05);border:1px solid rgba(255,215,0,0.18);color:var(--text-primary)}
.ms-pill{display:inline-block;font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:1px;padding:2px 7px;border-radius:20px;background:rgba(255,215,0,0.1);border:1px solid rgba(255,215,0,0.28);color:var(--gold);margin-left:6px;vertical-align:middle}

/* ‚îÄ‚îÄ BOTTOM NAV ‚îÄ‚îÄ */
.bottom-nav{position:fixed;bottom:0;left:0;right:0;height:60px;background:rgba(13,17,23,0.96);backdrop-filter:blur(16px);border-top:1px solid var(--panel-border);display:flex;align-items:center;padding:0 36px;gap:12px;z-index:200}
.btn-prev,.btn-check,.btn-reveal,.btn-next{font-family:'Share Tech Mono',monospace;font-size:10px;letter-spacing:2px;padding:9px 20px;border-radius:6px;cursor:pointer;border:none;transition:all .2s ease}
.btn-prev{background:transparent;border:1px solid var(--panel-border);color:var(--text-dim)}
.btn-prev:hover{border-color:var(--text-dim);color:var(--text-primary)}
.btn-check{background:transparent;border:1px solid rgba(255,215,0,0.38);color:var(--gold)}
.btn-check:hover{background:rgba(255,215,0,0.07)}
.btn-check:disabled{opacity:.3;cursor:not-allowed}
.btn-reveal{background:transparent;border:1px solid rgba(57,255,20,0.38);color:var(--green)}
.btn-reveal:hover{background:rgba(57,255,20,0.07)}
.btn-next{background:var(--green);color:#0D1117;font-weight:700;margin-left:auto;box-shadow:0 0 14px rgba(57,255,20,0.22)}
.btn-next:hover{box-shadow:0 0 26px rgba(57,255,20,0.42);transform:translateY(-1px)}
.btn-next:disabled{background:rgba(255,255,255,0.1);color:var(--text-dim);box-shadow:none;cursor:not-allowed;transform:none}

/* ‚îÄ‚îÄ XP POP ANIMATION ‚îÄ‚îÄ */
.xp-pop{position:fixed;font-family:'Orbitron',monospace;font-weight:900;font-size:18px;color:var(--green);text-shadow:0 0 16px var(--green-glow);pointer-events:none;z-index:9999;animation:xp-float 1.2s ease forwards}
@keyframes xp-float{0%{opacity:1;transform:translateY(0) scale(1)}60%{opacity:1;transform:translateY(-40px) scale(1.1)}100%{opacity:0;transform:translateY(-70px) scale(0.8)}}

/* ‚îÄ‚îÄ RANK UP OVERLAY ‚îÄ‚îÄ */
.rankup-overlay{position:fixed;inset:0;z-index:5000;background:rgba(13,17,23,0.92);backdrop-filter:blur(8px);display:none;align-items:center;justify-content:center;flex-direction:column;text-align:center}
.rankup-overlay.show{display:flex;animation:fade-in .3s ease}
.rankup-icon{font-size:60px;margin-bottom:16px;animation:bounceIn .5s ease}
.rankup-label{font-family:'Share Tech Mono',monospace;font-size:10px;letter-spacing:3px;color:var(--text-dim);margin-bottom:8px}
.rankup-title{font-family:'Orbitron',monospace;font-size:28px;font-weight:900;color:var(--gold);text-shadow:0 0 30px rgba(255,215,0,.5);letter-spacing:3px;margin-bottom:20px}
.rankup-sub{font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--text-dim);letter-spacing:2px}
@keyframes bounceIn{0%{transform:scale(.3)}50%{transform:scale(1.15)}100%{transform:scale(1)}}

/* ‚îÄ‚îÄ SECRETS PANEL ‚îÄ‚îÄ */
.secrets-panel{position:fixed;top:88px;right:0;width:340px;background:rgba(17,14,26,0.97);border-left:1px solid rgba(168,85,247,0.25);border-bottom:1px solid rgba(168,85,247,0.15);z-index:300;padding:20px;transform:translateX(100%);transition:transform .3s ease;max-height:calc(100vh - 150px);overflow-y:auto}
.secrets-panel.open{transform:translateX(0)}
.sp-header{font-family:'Orbitron',monospace;font-size:11px;font-weight:700;color:var(--purple);letter-spacing:2px;margin-bottom:4px}
.sp-sub{font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);letter-spacing:1px;margin-bottom:20px}
.sp-close{position:absolute;top:16px;right:16px;background:none;border:none;color:var(--text-dim);cursor:pointer;font-size:16px;line-height:1}
.sp-close:hover{color:var(--text-primary)}
.secret-card{background:rgba(168,85,247,0.05);border:1px solid rgba(168,85,247,0.18);border-radius:8px;padding:14px;margin-bottom:12px}
.secret-card.locked{background:rgba(255,255,255,0.02);border-color:rgba(255,255,255,0.08);opacity:.5}
.sc-label{font-family:'Share Tech Mono',monospace;font-size:8px;letter-spacing:2px;color:var(--purple);margin-bottom:6px;display:flex;align-items:center;gap:8px}
.sc-lock{color:var(--text-dimmer)}
.sc-unlock-at{color:var(--text-dimmer);margin-left:auto}
.sc-text{font-size:12px;font-weight:500;line-height:1.6;color:var(--text-primary)}

/* ‚îÄ‚îÄ START SCREEN ‚îÄ‚îÄ */
.start-screen{position:fixed;inset:0;z-index:400;background:var(--void);display:flex;align-items:center;justify-content:center;flex-direction:column;text-align:center;padding:32px}
.start-screen.hidden{display:none}
.ss-eyebrow{font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:3px;color:var(--text-dim);margin-bottom:12px}
.ss-title{font-family:'Orbitron',monospace;font-size:32px;font-weight:900;color:var(--text-primary);letter-spacing:2px;margin-bottom:6px}
.ss-title span{color:var(--green)}
.ss-subtitle{font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--text-dim);letter-spacing:2px;margin-bottom:40px}
.ss-card{background:var(--panel);border:1px solid var(--panel-border);border-radius:12px;padding:28px 32px;max-width:480px;width:100%;margin-bottom:24px}
.ss-name-label{font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:2px;color:var(--text-dim);margin-bottom:8px;text-align:left}
.ss-name-input{width:100%;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.12);border-bottom:2px solid var(--gold);border-radius:4px 4px 0 0;padding:10px 14px;font-family:'Share Tech Mono',monospace;font-size:14px;color:var(--gold);outline:none;margin-bottom:24px;transition:border-color .2s}
.ss-name-input:focus{border-bottom-color:var(--green);color:var(--text-primary)}
.ss-toggles{display:flex;flex-direction:column;gap:14px;margin-bottom:8px}
.ss-toggle-row{display:flex;align-items:center;gap:14px}
.toggle-switch{position:relative;width:42px;height:22px;flex-shrink:0}
.toggle-switch input{opacity:0;width:0;height:0}
.toggle-slider{position:absolute;inset:0;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.15);border-radius:22px;cursor:pointer;transition:.3s}
.toggle-slider::before{content:'';position:absolute;height:14px;width:14px;left:3px;top:3px;background:var(--text-dim);border-radius:50%;transition:.3s}
input:checked + .toggle-slider{background:rgba(57,255,20,0.15);border-color:rgba(57,255,20,0.4)}
input:checked + .toggle-slider::before{transform:translateX(20px);background:var(--green)}
.toggle-info{}
.toggle-title{font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--text-primary);letter-spacing:1px}
.toggle-desc{font-size:11px;color:var(--text-dim);margin-top:2px}
.ss-stats{display:flex;gap:16px;margin-bottom:28px;justify-content:center;flex-wrap:wrap}
.ss-stat{background:rgba(255,255,255,0.03);border:1px solid var(--panel-border);border-radius:8px;padding:14px 20px;text-align:center;flex:1;min-width:100px}
.ss-stat-val{font-family:'Orbitron',monospace;font-size:22px;font-weight:900;color:var(--green);margin-bottom:4px}
.ss-stat-label{font-family:'Share Tech Mono',monospace;font-size:8px;letter-spacing:1px;color:var(--text-dim)}
.btn-start{font-family:'Orbitron',monospace;font-size:13px;font-weight:700;letter-spacing:3px;background:var(--green);color:#0D1117;border:none;border-radius:8px;padding:16px 48px;cursor:pointer;box-shadow:0 0 28px rgba(57,255,20,.3);transition:all .2s;width:100%;max-width:480px}
.btn-start:hover{box-shadow:0 0 44px rgba(57,255,20,.5);transform:translateY(-1px)}

/* ‚îÄ‚îÄ COMPLETE SCREEN ‚îÄ‚îÄ */
.complete-screen{position:fixed;inset:0;z-index:350;background:var(--void);display:none;align-items:center;justify-content:center;flex-direction:column;text-align:center;padding:32px;overflow-y:auto}
.complete-screen.show{display:flex;animation:fade-in .5s ease}
.complete-icon{font-size:56px;margin-bottom:16px}
.complete-title{font-family:'Orbitron',monospace;font-size:26px;font-weight:900;color:var(--green);letter-spacing:3px;text-shadow:0 0 28px rgba(57,255,20,.4);margin-bottom:8px}
.complete-sub{font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--text-dim);letter-spacing:2px;margin-bottom:28px}
.complete-stats{display:flex;gap:16px;margin-bottom:28px;flex-wrap:wrap;justify-content:center}
.cstat{background:var(--panel);border:1px solid var(--panel-border);border-radius:10px;padding:18px 24px;text-align:center}
.cstat-val{font-family:'Orbitron',monospace;font-size:28px;font-weight:900;color:var(--green);margin-bottom:4px}
.cstat-label{font-family:'Share Tech Mono',monospace;font-size:8px;letter-spacing:1px;color:var(--text-dim)}
.complete-rank-badge{background:rgba(255,215,0,0.07);border:1px solid rgba(255,215,0,0.28);border-radius:10px;padding:16px 24px;margin-bottom:24px;display:inline-block}
.crb-label{font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:2px;color:var(--text-dim);margin-bottom:6px}
.crb-val{font-family:'Orbitron',monospace;font-size:20px;font-weight:900;color:var(--gold);letter-spacing:2px}
.leaderboard-opt{background:var(--panel);border:1px solid var(--panel-border);border-radius:10px;padding:20px 24px;max-width:440px;width:100%;margin-bottom:20px}
.lb-title{font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:2px;color:var(--text-dim);margin-bottom:12px}
.lb-submit-row{display:flex;gap:10px;align-items:center}
.lb-name-input{flex:1;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.1);border-bottom:2px solid var(--gold);border-radius:4px 4px 0 0;padding:8px 12px;font-family:'Share Tech Mono',monospace;font-size:12px;color:var(--gold);outline:none}
.lb-submit-btn{font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:2px;padding:8px 16px;background:rgba(57,255,20,0.1);border:1px solid rgba(57,255,20,0.35);color:var(--green);border-radius:5px;cursor:pointer;white-space:nowrap;transition:all .2s}
.lb-submit-btn:hover{background:rgba(57,255,20,0.18)}
.lb-submitted{font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--green);letter-spacing:1px;display:none}
.lb-table{margin-top:14px;width:100%}
.lb-row{display:flex;align-items:center;gap:12px;padding:7px 0;border-bottom:1px solid var(--panel-border);font-size:12px}
.lb-pos{font-family:'Orbitron',monospace;font-size:11px;font-weight:700;color:var(--text-dim);min-width:22px}
.lb-pos.top{color:var(--gold)}
.lb-name{flex:1;font-weight:600}
.lb-xp{font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--green)}
.lb-rank-text{font-family:'Share Tech Mono',monospace;font-size:8px;letter-spacing:1px;color:var(--text-dim)}
.complete-actions{display:flex;gap:12px;flex-wrap:wrap;justify-content:center}
.btn-action{font-family:'Share Tech Mono',monospace;font-size:10px;letter-spacing:2px;padding:10px 22px;border-radius:6px;cursor:pointer;transition:all .2s}
.btn-action.green-btn{background:transparent;border:1px solid rgba(57,255,20,0.38);color:var(--green)}
.btn-action.green-btn:hover{background:rgba(57,255,20,0.08)}
.btn-action.gold-btn{background:transparent;border:1px solid rgba(255,215,0,0.38);color:var(--gold)}
.btn-action.gold-btn:hover{background:rgba(255,215,0,0.08)}

@keyframes fade-in{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
@keyframes pulse-glow{0%,100%{opacity:1}50%{opacity:.6}}
.step-enter{animation:fade-in .32s ease forwards}

/* ‚îÄ‚îÄ BADGE INTERRUPT OVERLAY ‚îÄ‚îÄ */
.badge-interrupt{position:fixed;inset:0;z-index:8000;background:rgba(13,17,23,0.94);backdrop-filter:blur(10px);display:none;align-items:center;justify-content:center;flex-direction:column;text-align:center;padding:32px;cursor:pointer}
.badge-interrupt.show{display:flex}
.bi-pre{font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:3px;color:var(--text-dim);margin-bottom:16px;animation:fade-in .4s ease .1s both}
.bi-card{background:var(--panel);border-radius:16px;padding:32px 40px;max-width:380px;width:100%;animation:badge-flip .5s ease forwards;transform-style:preserve-3d}
.bi-card.common{border:1px solid rgba(57,255,20,0.35);box-shadow:0 0 40px rgba(57,255,20,0.15),inset 0 1px 0 rgba(57,255,20,0.1)}
.bi-card.rare{border:1px solid rgba(255,215,0,0.4);box-shadow:0 0 40px rgba(255,215,0,0.18),inset 0 1px 0 rgba(255,215,0,0.1)}
.bi-card.legendary{border:1px solid rgba(168,85,247,0.45);box-shadow:0 0 50px rgba(168,85,247,0.22),inset 0 1px 0 rgba(168,85,247,0.12)}
.bi-icon{font-size:58px;margin-bottom:12px;display:block;animation:badge-bounce .6s ease .3s both}
.bi-rarity{font-family:'Share Tech Mono',monospace;font-size:8px;letter-spacing:3px;padding:3px 10px;border-radius:3px;margin-bottom:10px;display:inline-block}
.bi-rarity.common{background:rgba(57,255,20,0.08);border:1px solid rgba(57,255,20,0.25);color:var(--green)}
.bi-rarity.rare{background:rgba(255,215,0,0.08);border:1px solid rgba(255,215,0,0.3);color:var(--gold)}
.bi-rarity.legendary{background:rgba(168,85,247,0.1);border:1px solid rgba(168,85,247,0.35);color:var(--purple)}
.bi-name{font-family:'Orbitron',monospace;font-size:22px;font-weight:900;letter-spacing:2px;margin-bottom:8px}
.bi-name.common{color:var(--green);text-shadow:0 0 20px rgba(57,255,20,.4)}
.bi-name.rare{color:var(--gold);text-shadow:0 0 20px rgba(255,215,0,.4)}
.bi-name.legendary{color:var(--purple);text-shadow:0 0 24px rgba(168,85,247,.45)}
.bi-desc{font-size:13px;font-weight:500;color:var(--text-dim);line-height:1.6;margin-bottom:14px}
.bi-cat{font-family:'Share Tech Mono',monospace;font-size:8px;letter-spacing:2px;color:var(--text-dimmer)}
.bi-dismiss{font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:2px;color:var(--text-dimmer);margin-top:20px;animation:fade-in .4s ease 1.5s both}
.bi-timer-bar{width:200px;height:2px;background:rgba(255,255,255,0.08);border-radius:1px;margin:12px auto 0;overflow:hidden}
.bi-timer-fill{height:100%;border-radius:1px;animation:bi-drain 3s linear forwards}
.bi-timer-fill.common{background:var(--green)}
.bi-timer-fill.rare{background:var(--gold)}
.bi-timer-fill.legendary{background:var(--purple)}
@keyframes badge-flip{0%{opacity:0;transform:rotateY(-90deg) scale(.8)}60%{transform:rotateY(10deg) scale(1.04)}100%{opacity:1;transform:rotateY(0deg) scale(1)}}
@keyframes badge-bounce{0%{transform:scale(0)}60%{transform:scale(1.2)}100%{transform:scale(1)}}
@keyframes bi-drain{from{width:100%}to{width:0%}}

/* ‚îÄ‚îÄ BADGE CABINET (end screen) ‚îÄ‚îÄ */
.badge-cabinet{width:100%;max-width:600px;margin:0 auto 24px}
.bc-title{font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:2px;color:var(--text-dim);margin-bottom:14px;text-align:left}
.bc-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
@media(max-width:540px){.bc-grid{grid-template-columns:repeat(3,1fr)}}
.bc-item{background:var(--panel);border:1px solid var(--panel-border);border-radius:10px;padding:14px 8px;text-align:center;transition:all .3s;position:relative}
.bc-item.earned.common{border-color:rgba(57,255,20,0.3);background:rgba(57,255,20,0.05);box-shadow:0 0 12px rgba(57,255,20,0.1)}
.bc-item.earned.rare{border-color:rgba(255,215,0,0.35);background:rgba(255,215,0,0.05);box-shadow:0 0 12px rgba(255,215,0,0.1)}
.bc-item.earned.legendary{border-color:rgba(168,85,247,0.4);background:rgba(168,85,247,0.06);box-shadow:0 0 16px rgba(168,85,247,0.12)}
.bc-item.locked{opacity:.45;filter:grayscale(0.6)}
.bc-icon{font-size:26px;margin-bottom:6px;display:block}
.bc-item.locked .bc-icon{filter:grayscale(1);opacity:.4}
.bc-name{font-family:'Share Tech Mono',monospace;font-size:8px;letter-spacing:1px;line-height:1.3}
.bc-item.earned.common .bc-name{color:var(--green)}
.bc-item.earned.rare .bc-name{color:var(--gold)}
.bc-item.earned.legendary .bc-name{color:var(--purple)}
.bc-item.locked .bc-name{color:var(--text-dimmer)}
.bc-cat{font-size:9px;color:var(--text-dimmer);margin-top:3px;font-family:'Share Tech Mono',monospace;font-size:7px;letter-spacing:1px}
.bc-new-dot{position:absolute;top:6px;right:6px;width:7px;height:7px;border-radius:50%;background:var(--red);box-shadow:0 0 6px rgba(255,59,59,.6)}
</style>
</head>
<body>

<!-- ‚ïê‚ïê START SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="start-screen" id="start-screen">
  <div class="ss-eyebrow">THE MARK SCHEME METHOD¬Æ // CLASSROOM MODE</div>
  <div class="ss-title">CONTENT AREA <span>6.1.1</span></div>
  <div class="ss-subtitle">‚ñ∏ DATA // INFORMATION // KNOWLEDGE</div>

  <div class="ss-stats">
    <div class="ss-stat"><div class="ss-stat-val">6</div><div class="ss-stat-label">STEPS</div></div>
    <div class="ss-stat"><div class="ss-stat-val">600</div><div class="ss-stat-label">MAX XP</div></div>
    <div class="ss-stat"><div class="ss-stat-val">5</div><div class="ss-stat-label">RANKS</div></div>
    <div class="ss-stat"><div class="ss-stat-val">3</div><div class="ss-stat-label">SECRETS</div></div>
  </div>

  <div class="ss-card">
    <div class="ss-name-label">‚ñ∏ YOUR CODENAME (optional ‚Äî used for leaderboard)</div>
    <input class="ss-name-input" id="ss-name" placeholder="e.g. DataSpecialist_01" maxlength="24" autocomplete="off">

    <div class="ss-toggles">
      <div class="ss-toggle-row">
        <label class="toggle-switch">
          <input type="checkbox" id="timer-toggle">
          <span class="toggle-slider"></span>
        </label>
        <div class="toggle-info">
          <div class="toggle-title">‚è± CHALLENGE MODE</div>
          <div class="toggle-desc">45s per question ‚Äî earn speed bonus XP for time remaining</div>
        </div>
      </div>
      <div class="ss-toggle-row">
        <label class="toggle-switch">
          <input type="checkbox" id="lb-toggle" checked>
          <span class="toggle-slider"></span>
        </label>
        <div class="toggle-info">
          <div class="toggle-title">üèÜ CLASS LEADERBOARD</div>
          <div class="toggle-desc">Your final score will be visible on the class board</div>
        </div>
      </div>
    </div>
  </div>

  <button class="btn-start" onclick="startLesson()">‚ü∂ BEGIN MISSION</button>
</div>

<!-- ‚ïê‚ïê TOPBAR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<nav class="topbar" id="topbar" style="display:none">
  <div class="topbar-brand">MSM¬Æ</div>
  <div class="topbar-divider"></div>
  <div class="topbar-title">6.1.1 // DATA ¬∑ INFO ¬∑ KNOWLEDGE</div>
  <div class="topbar-progress" style="margin-left:12px">
    <div class="topbar-dots" id="step-dots"></div>
    <div class="pb-track"><div class="pb-fill" id="pb-fill" style="width:0%"></div></div>
    <div class="pb-label" id="pb-label">1/6</div>
  </div>
</nav>

<!-- ‚ïê‚ïê XP BAR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="xpbar" id="xpbar" style="display:none">
  <div class="xp-rank" id="xp-rank">CADET</div>
  <div class="xp-track"><div class="xp-fill" id="xp-fill" style="width:0%"></div></div>
  <div class="xp-total" id="xp-total">0 XP</div>
  <div class="xp-divider"></div>
  <div class="streak-display">
    <div class="streak-icon" id="streak-icon">üî•</div>
    <div class="streak-count" id="streak-count" style="color:var(--text-dim)">0</div>
    <div class="streak-mult" id="streak-mult">√ó1.0</div>
  </div>
  <div class="xp-divider"></div>
  <div class="timer-wrap" id="timer-wrap" style="display:none">
    <svg class="timer-ring" id="timer-ring" viewBox="0 0 32 32">
      <circle class="bg" cx="16" cy="16" r="14"/>
      <circle class="fg" id="timer-arc" cx="16" cy="16" r="14"/>
    </svg>
    <div class="timer-val" id="timer-val">45</div>
  </div>
  <div class="xp-divider" id="timer-divider" style="display:none"></div>
  <button class="secrets-btn" onclick="toggleSecrets()">
    üîí EXAMINER SECRETS
    <span class="secrets-badge" id="secrets-badge">!</span>
  </button>
</div>

<!-- ‚ïê‚ïê SECRETS PANEL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="secrets-panel" id="secrets-panel">
  <div class="sp-header">EXAMINER SECRETS</div>
  <div class="sp-sub">‚ñ∏ UNLOCK BY EARNING XP // 3 TOTAL</div>
  <button class="sp-close" onclick="toggleSecrets()">‚úï</button>
  <div id="secrets-list"></div>
</div>

<!-- ‚ïê‚ïê MAIN APP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="app" id="app" style="display:none">
  <div class="theory-panel" id="theory-panel"></div>
  <div class="task-panel"   id="task-panel"></div>
</div>

<!-- ‚ïê‚ïê BOTTOM NAV ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="bottom-nav" id="bottom-nav" style="display:none">
  <button class="btn-prev"   id="btn-prev"   onclick="prevStep()">‚Üê BACK</button>
  <button class="btn-check"  id="btn-check"  onclick="checkAnswer()">CHECK ANSWER</button>
  <button class="btn-reveal" id="btn-reveal" onclick="revealModel()" style="display:none">REVEAL MODEL ANSWER</button>
  <button class="btn-next"   id="btn-next"   onclick="nextStep()" disabled>CONTINUE ‚Üí</button>
</div>

<!-- ‚ïê‚ïê BADGE INTERRUPT OVERLAY ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="badge-interrupt" id="badge-interrupt" onclick="dismissBadge()">
  <div class="bi-pre">‚ñ∏ BADGE UNLOCKED</div>
  <div class="bi-card" id="bi-card">
    <span class="bi-icon" id="bi-icon">üéñÔ∏è</span>
    <div class="bi-rarity" id="bi-rarity">COMMON</div>
    <div class="bi-name"   id="bi-name">BADGE</div>
    <div class="bi-desc"   id="bi-desc">Description</div>
    <div class="bi-cat"    id="bi-cat">COMPLETION</div>
    <div class="bi-timer-bar"><div class="bi-timer-fill" id="bi-timer-fill"></div></div>
  </div>
  <div class="bi-dismiss">TAP ANYWHERE TO CONTINUE</div>
</div>

<!-- ‚ïê‚ïê RANK UP OVERLAY ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="rankup-overlay" id="rankup-overlay">
  <div class="rankup-icon" id="rankup-icon">‚≠ê</div>
  <div class="rankup-label">RANK UP</div>
  <div class="rankup-title" id="rankup-title">ANALYST</div>
  <div class="rankup-sub" id="rankup-sub">KEEP GOING ‚Äî 2 MORE RANKS TO UNLOCK</div>
</div>

<!-- ‚ïê‚ïê COMPLETE SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="complete-screen" id="complete-screen">
  <div class="complete-icon">üèÜ</div>
  <div class="complete-title">MISSION COMPLETE</div>
  <div class="complete-sub">‚ñ∏ CONTENT AREA 6.1.1 // ALL STEPS CLEARED</div>
  <div class="complete-stats">
    <div class="cstat"><div class="cstat-val" id="cs-xp">0</div><div class="cstat-label">TOTAL XP</div></div>
    <div class="cstat"><div class="cstat-val" id="cs-correct">0/6</div><div class="cstat-label">CORRECT</div></div>
    <div class="cstat"><div class="cstat-val" id="cs-streak">0</div><div class="cstat-label">BEST STREAK</div></div>
    <div class="cstat" id="cs-speed-wrap" style="display:none"><div class="cstat-val" id="cs-speed">+0</div><div class="cstat-label">SPEED XP</div></div>
  </div>
  <div class="complete-rank-badge">
    <div class="crb-label">‚ñ∏ FINAL RANK</div>
    <div class="crb-val" id="cs-rank">CADET</div>
  </div>
  <div class="leaderboard-opt" id="leaderboard-section">
    <div class="lb-title">‚ñ∏ CLASS LEADERBOARD</div>
    <div class="lb-submit-row" id="lb-submit-row">
      <input class="lb-name-input" id="lb-name" placeholder="Your codename‚Ä¶" maxlength="24">
      <button class="lb-submit-btn" onclick="submitScore()">SUBMIT SCORE</button>
    </div>
    <div class="lb-submitted" id="lb-submitted">‚úì SCORE SUBMITTED ‚Äî LOADING BOARD‚Ä¶</div>
    <div class="lb-table" id="lb-table"></div>
  </div>
  <div class="badge-cabinet" id="badge-cabinet">
    <div class="bc-title">‚ñ∏ BADGE COLLECTION // 12 AVAILABLE</div>
    <div class="bc-grid" id="bc-grid"></div>
  </div>
  <div class="complete-actions">
    <button class="btn-action green-btn" onclick="restartLesson()">‚Ü∫ RESTART</button>
    <a href="index.html"><button class="btn-action gold-btn">‚ü∂ EXAM PRACTICE</button></a>
  </div>
</div>

<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   FIREBASE ‚Äî class leaderboard
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const FB_URL = 'https://mark-scheme-method-3efe9-default-rtdb.firebaseio.com/classroom_611';

async function fbGet() {
  try {
    const r = await fetch(`${FB_URL}.json`);
    return r.ok ? await r.json() : null;
  } catch { return null; }
}

async function fbPush(entry) {
  try {
    await fetch(`${FB_URL}.json`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(entry)
    });
  } catch {}
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   RANKS & SECRETS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const RANKS = [
  { name:'CADET',           min:0,   max:149,  icon:'üéñÔ∏è' },
  { name:'ANALYST',         min:150, max:299,  icon:'üìä' },
  { name:'SPECIALIST',      min:300, max:449,  icon:'‚ö°' },
  { name:'SENIOR ANALYST',  min:450, max:599,  icon:'üî¨' },
  { name:'INSIGHT ARCHITECT', min:600, max:Infinity, icon:'üß†' },
];

const SECRETS = [
  {
    unlockAt: 200,
    label: 'EXAMINER SECRET #1 ‚Äî THE MISSING MARK',
    text: 'Lead Examiner Reports show that students almost always earn marks for Data (naming the term) and Information (explaining what it means) ‚Äî but consistently miss the Impact mark by not stating the business outcome. This is the most common reason for scoring 2/3 instead of 3/3.'
  },
  {
    unlockAt: 400,
    label: 'EXAMINER SECRET #2 ‚Äî VAGUE IMPACT = 0 MARKS',
    text: '"The business benefits" scores zero. "The business can increase efficiency" scores zero. Examiners require a specific, measurable or concrete outcome. Compare: ‚úó "improves operations" vs ‚úì "reduces delivery costs by routing drivers around traffic, saving an average of 12 minutes per journey".'
  },
  {
    unlockAt: 600,
    label: 'EXAMINER SECRET #3 ‚Äî DIKW IN PAST PAPERS',
    text: 'The DIKW hierarchy has appeared in 4 of the last 6 series of T-Level Digital core assessments. Wisdom is always at the top and is always defined as "the ability to USE knowledge to perform an action with good judgement". Students who confuse Knowledge and Wisdom lose the mark every time.'
  }
];

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   STEP DATA
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const STEPS = [
  {
    theory:`<span class="step-tag">STEP 01 // CONTENT AREA 6.1.1</span>
<h2 class="theory-heading">What is <span>Data</span>?</h2>
<div class="theory-body">
<p><span class="hl-red">Data</span> is raw facts and figures that have <strong>no meaning on their own</strong>. It has not been processed or given context.</p>
<div class="key-term-box"><span class="kt-label">‚ñ∏ KEY TERM</span><div class="kt-term">Data</div><div class="kt-def">Unprocessed raw facts and figures before they have been given structure, context or meaning.</div></div>
<p>Examples of data:</p>
<p><span class="data-example">NAT23%7</span> <span class="data-example">56GHS56</span> <span class="data-example">51.5074, -0.1278</span> <span class="data-example">102.4</span></p>
<p>These are just random strings. <strong>They have no meaning yet.</strong></p>
<p>Data can be <span class="hl-green">qualitative</span> (non-numerical) or <span class="hl-gold">quantitative</span> (numerical).</p>
</div>`,
    task:{type:'mcq',badge:'MULTIPLE CHOICE',instruction:'SELECT THE CORRECT ANSWER',xp:100,
      question:'A temperature sensor records <span class="data-example">102.4</span> at 09:00. What type of value is this?',
      options:['Information ‚Äî it tells us the temperature is dangerously high','Data ‚Äî a raw number with no context or meaning yet','Knowledge ‚Äî the system can act on it to trigger an alert','A report generated by the warehouse management system'],
      correct:1,
      fb_ok:'‚úì Correct. 102.4 is just a raw number ‚Äî no context, no structure, no meaning. That\'s data.',
      fb_err:'‚úó Not quite. 102.4 is raw ‚Äî no context tells us what it means or why it matters yet.'}
  },
  {
    theory:`<span class="step-tag">STEP 02 // CONTENT AREA 6.1.1</span>
<h2 class="theory-heading">What is <span>Information</span>?</h2>
<div class="theory-body">
<p><span class="hl-gold">Information</span> is created when data is processed. It is data that has been given <strong>structure, context and meaning</strong>.</p>
<div class="formula-box"><div class="formula-text">Information = Data + Structure + Context + Meaning</div></div>
<p>Take <span class="data-example">102.4</span>. Once processed:</p>
<div class="key-term-box" style="border-color:rgba(255,215,0,0.3);background:rgba(255,215,0,0.04)"><span class="kt-label" style="color:var(--gold)">‚ñ∏ EXAMPLE</span><div class="kt-def">"The server room is at <strong>102.4¬∞F</strong> ‚Äî above the safe threshold of 80¬∞F."</div></div>
<p>Now the number has <span class="hl-gold">structure</span> (¬∞F), <span class="hl-gold">context</span> (server room) and <span class="hl-gold">meaning</span> (dangerously hot).</p>
<div class="key-term-box"><span class="kt-label">‚ñ∏ KEY TERM</span><div class="kt-term">Information</div><div class="kt-def">Data that has been processed, given structure and context, so it now carries meaning.</div></div>
</div>`,
    task:{type:'fitb',badge:'FILL IN THE BLANK',instruction:'COMPLETE THE FORMULA',xp:100,
      question:'Complete both blanks in the data-to-information formula.',
      blanks:[
        {before:'Information = Data + ',after:' + Context + Meaning',answer:'structure',alt:['struct']},
        {before:'Information = Data + Structure + ',after:' + Meaning',answer:'context',alt:['ctx']}
      ],
      fb_ok:'‚úì Correct ‚Äî Structure + Context + Meaning transforms raw data into something meaningful.',
      fb_err:'‚úó Not quite. The formula is: Information = Data + Structure + Context + Meaning.'}
  },
  {
    theory:`<span class="step-tag">STEP 03 // CONTENT AREA 6.1.1</span>
<h2 class="theory-heading">What is <span>Knowledge</span>?</h2>
<div class="theory-body">
<p><span class="hl-green">Knowledge</span> is information that has been processed, linked and stored ‚Äî enabling decisions and actions.</p>
<div class="key-term-box"><span class="kt-label">‚ñ∏ DEFINITION (BBC, 2022)</span><div class="kt-def">"The ability to understand information and form judgements, opinions and decisions based on that understanding."</div></div>
<p>Knowledge answers: <em>"What do I DO with this?"</em></p>
<div class="chain-row">
<div class="chain-item"><div class="ci-label" style="color:var(--red)">DATA</div><div class="ci-val" style="color:var(--text-dim)">102.4</div></div>
<div class="chain-arrow">‚Üí</div>
<div class="chain-item"><div class="ci-label" style="color:var(--gold)">INFORMATION</div><div class="ci-val" style="color:var(--text-dim)">Server overheating</div></div>
<div class="chain-arrow">‚Üí</div>
<div class="chain-item"><div class="ci-label" style="color:var(--green)">KNOWLEDGE</div><div class="ci-val" style="color:var(--text-dim)">Shut down server</div></div>
</div>
<p>The <span class="hl-green">business impact</span> ‚Äî the action or outcome ‚Äî is always the Knowledge layer. This is the mark most students miss.</p>
</div>`,
    task:{type:'short',badge:'SHORT ANSWER',instruction:'ANSWER ‚Äî THEN REVEAL MODEL',xp:100,
      question:'A delivery company\'s GPS records <span class="data-example">51.5074, -0.1278</span>.<br><br>In your own words, explain the difference between this being data, information and knowledge in this scenario.',
      model:`<span class="nei-tag nei-n">[DATA]</span> <strong>51.5074, -0.1278</strong> ‚Äî raw GPS coordinates. Just numbers; no context yet.<br><br><span class="nei-tag nei-e">[INFORMATION]</span> Processed by the navigation system: <strong>"Oxford Circus, London"</strong> ‚Äî a meaningful location the operator understands.<br><br><span class="nei-tag nei-i">[KNOWLEDGE]</span> The system acts: <strong>"Turn left in 200m ‚Äî 4 minutes faster."</strong> Actionable instruction with a business outcome: time saved, efficiency gained.`}
  },
  {
    theory:`<span class="step-tag">STEP 04 // CONTENT AREA 6.1.1</span>
<h2 class="theory-heading">The <span>D ‚Üí I ‚Üí K</span> Chain</h2>
<div class="theory-body">
<p>Data, information and knowledge form a chain ‚Äî each stage <strong>adds value</strong>:</p>
<div class="formula-box"><div class="formula-text">Data  ‚Üí  Information  ‚Üí  Knowledge</div></div>
<p>The <strong>DIKW pyramid</strong> extends this to include Wisdom at the top:</p>
<div class="dikw-pyramid">
<div class="dikw-row" style="background:rgba(57,255,20,0.08);border:1px solid rgba(57,255,20,0.2);color:var(--green);width:58%;margin:0 auto">WISDOM</div>
<div class="dikw-row" style="background:rgba(57,255,20,0.05);border:1px solid rgba(57,255,20,0.13);color:rgba(57,255,20,.7);width:74%;margin:0 auto">KNOWLEDGE</div>
<div class="dikw-row" style="background:rgba(255,215,0,0.05);border:1px solid rgba(255,215,0,0.18);color:var(--gold);width:87%;margin:0 auto">INFORMATION</div>
<div class="dikw-row" style="background:rgba(255,59,59,0.05);border:1px solid rgba(255,59,59,0.18);color:var(--red);width:100%">DATA</div>
</div>
<p>Each level upwards adds value. Examiners want you to explain <strong>what value is added</strong> ‚Äî especially from Information to Knowledge.</p>
</div>`,
    task:{type:'dnd',badge:'DRAG & DROP',instruction:'DRAG EACH ITEM TO THE CORRECT LEVEL',xp:100,
      question:'An e-commerce site analyses customer data. Drag each item into the correct DIKW level.',
      chips:[
        {id:'c1',text:'"Customer purchased 3 times in December"',answer:'information'},
        {id:'c2',text:'purchase_id: 4471, qty: 2, date: 24/12',answer:'data'},
        {id:'c3',text:'Send targeted Christmas voucher to this customer',answer:'knowledge'}
      ],
      zones:[
        {id:'data',label:'DATA',color:'var(--red)',hint:'Raw transaction record'},
        {id:'information',label:'INFORMATION',color:'var(--gold)',hint:'Processed with context'},
        {id:'knowledge',label:'KNOWLEDGE',color:'var(--green)',hint:'Actionable business decision'}
      ],
      fb_ok:'‚úì Correct ‚Äî raw records = data; processed purchase history = information; targeted action from insight = knowledge.',
      fb_err:'‚úó Not quite. Data = raw records. Information = processed + context. Knowledge = the business action or decision.'}
  },
  {
    theory:`<span class="step-tag">STEP 05 // CONTENT AREA 6.1.1</span>
<h2 class="theory-heading">Why Organisations <span>Need Data</span></h2>
<div class="theory-body">
<p>Data is <strong>"an organisation's most valuable asset"</strong>. Without it, organisations cannot make informed decisions.</p>
<div class="chain-row" style="flex-wrap:wrap;gap:7px">
<div class="chain-item" style="min-width:120px"><div class="ci-label" style="color:var(--green)">ANALYSE</div><div class="ci-val" style="font-size:10px">Market trends & patterns</div></div>
<div class="chain-item" style="min-width:120px"><div class="ci-label" style="color:var(--gold)">MONITOR</div><div class="ci-val" style="font-size:10px">System & user performance</div></div>
<div class="chain-item" style="min-width:120px"><div class="ci-label" style="color:var(--amber)">INFORM</div><div class="ci-val" style="font-size:10px">Strategic, tactical & operational decisions</div></div>
<div class="chain-item" style="min-width:120px"><div class="ci-label" style="color:var(--red)">TARGET</div><div class="ci-val" style="font-size:10px">Marketing at specific customers</div></div>
</div>
<div class="key-term-box" style="border-color:rgba(255,215,0,0.3);background:rgba(255,215,0,0.04)"><span class="kt-label" style="color:var(--gold)">‚ñ∏ EXAMINER INSIGHT</span><div class="kt-def">Questions almost always ask you to explain <strong>why</strong> data adds value. Always finish with the business outcome ‚Äî that is the Knowledge layer.</div></div>
</div>`,
    task:{type:'mcq',badge:'MULTIPLE CHOICE',instruction:'SELECT THE CORRECT ANSWER',xp:100,
      question:'A retailer analyses 3 years of sales data and sees chocolate sales spike every February. Which option best represents the <strong>Knowledge</strong> layer?',
      options:['The raw daily sales figures recorded in the database','\"Chocolate sales rose 34% every February for 3 years\"','Increase chocolate stock levels in January to prevent stockouts and maximise February revenue','A spreadsheet showing monthly revenue by product category'],
      correct:2,
      fb_ok:'‚úì Correct. Knowledge = the actionable business decision. Options A and D are data; B is information.',
      fb_err:'‚úó Not quite. Knowledge = the action or decision made using the information. Which option tells the business what to DO?'}
  },
  {
    theory:`<span class="step-tag">STEP 06 // CONTENT AREA 6.1.1 // EXAM PRACTICE</span>
<h2 class="theory-heading">The <span>N.E.I.</span> Method</h2>
<div class="theory-body">
<p>Apply everything to a real exam question using N.E.I.:</p>
<div class="chain-row">
<div class="chain-item" style="border-color:rgba(255,59,59,0.3)"><div class="ci-label" style="color:var(--red)">N ‚Äî NAME</div><div class="ci-val" style="font-size:10px">Identify the technical term</div></div>
<div class="chain-item" style="border-color:rgba(255,149,0,0.3)"><div class="ci-label" style="color:var(--amber)">E ‚Äî EXPLAIN</div><div class="ci-val" style="font-size:10px">Describe how it works</div></div>
<div class="chain-item" style="border-color:rgba(57,255,20,0.3)"><div class="ci-label" style="color:var(--green)">I ‚Äî IMPACT</div><div class="ci-val" style="font-size:10px">State the business outcome</div></div>
</div>
<div class="key-term-box" style="border-color:rgba(255,215,0,0.3);background:rgba(255,215,0,0.04)"><span class="kt-label" style="color:var(--gold)">‚ñ∏ WHAT EXAMINERS SAY</span><div class="kt-def">Students identify the right term (N) and sometimes explain it (E) ‚Äî but fail to state the <strong>business impact (I)</strong>. That is the mark most students lose.</div></div>
<p>The <span class="hl-green">Impact</span> = the <strong>Knowledge layer</strong> ‚Äî what the business gains, saves, avoids or achieves.</p>
</div>`,
    task:{type:'exam',badge:'EXAM QUESTION',instruction:'WRITE YOUR ANSWER ‚Äî THEN REVEAL MODEL',xp:100,
      question:'A logistics company uses GPS tracking data from its delivery vehicles.<br><br><strong>Explain one way this data adds value to the business. <span class="ms-pill">3 MARKS</span></strong>',
      model:`<span class="nei-tag nei-n">[N]</span> <strong>GPS tracking</strong> monitors the real-time location of each delivery vehicle.<br><br><span class="nei-tag nei-e">[E]</span> <strong>The raw coordinates are processed</strong> into meaningful information ‚Äî showing each vehicle's position, estimated arrival times and any delays.<br><br><span class="nei-tag nei-i">[I]</span> <strong>This enables the business to dynamically reroute drivers</strong> around traffic, <strong>reducing delivery times and fuel costs</strong>, improving customer satisfaction and operational efficiency.`}
  }
];

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   STATE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let currentStep   = 0;
let stepUnlocked  = new Array(STEPS.length).fill(false);
let totalXP       = 0;
let currentStreak = 0;
let bestStreak    = 0;
let totalSpeedXP  = 0;
let correctCount  = 0;
let currentRankIdx = 0;
let secretsNewCount = 0;
let playerName    = '';
let timerMode     = false;
let lbOptIn       = true;
let timerInterval = null;
let timerSeconds  = 0;
let mcqSelected   = -1;
let dndState      = {};

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   START
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function startLesson() {
  playerName = document.getElementById('ss-name').value.trim() || 'SPECIALIST';
  timerMode  = document.getElementById('timer-toggle').checked;
  lbOptIn    = document.getElementById('lb-toggle').checked;

  document.getElementById('start-screen').classList.add('hidden');
  document.getElementById('topbar').style.display = 'flex';
  document.getElementById('xpbar').style.display  = 'flex';
  document.getElementById('app').style.display     = 'grid';
  document.getElementById('bottom-nav').style.display = 'flex';

  if (timerMode) {
    document.getElementById('timer-wrap').style.display = 'flex';
    document.getElementById('timer-divider').style.display = 'block';
  }

  buildDots();
  renderSecrets();
  renderStep(0);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   DOTS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function buildDots() {
  const c = document.getElementById('step-dots');
  c.innerHTML = '';
  STEPS.forEach((_,i) => {
    const d = document.createElement('div');
    d.className = 'sdot' + (i === 0 ? ' active' : '');
    d.id = `sdot-${i}`;
    c.appendChild(d);
  });
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   RENDER STEP
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderStep(idx) {
  currentStep = idx;
  stopTimer();
  mcqSelected = -1;

  const step = STEPS[idx];
  const tp = document.getElementById('theory-panel');
  const pp = document.getElementById('task-panel');

  tp.innerHTML = step.theory;
  tp.classList.add('step-enter'); setTimeout(() => tp.classList.remove('step-enter'), 400);
  tp.scrollTop = 0;

  pp.innerHTML = buildTaskHTML(step.task);
  pp.classList.add('step-enter'); setTimeout(() => pp.classList.remove('step-enter'), 400);
  pp.scrollTop = 0;

  if (step.task.type === 'dnd') { dndState = {}; STEPS[idx].task.chips.forEach(c => dndState[c.id] = null); attachDnD(step.task); }
  if (step.task.type === 'short' || step.task.type === 'exam') attachWordCount();
  if (timerMode && step.task.type !== 'short' && step.task.type !== 'exam') startTimer(45);
  if (timerMode && (step.task.type === 'short' || step.task.type === 'exam')) startTimer(180);

  const btnPrev   = document.getElementById('btn-prev');
  const btnCheck  = document.getElementById('btn-check');
  const btnReveal = document.getElementById('btn-reveal');
  const btnNext   = document.getElementById('btn-next');

  btnPrev.style.display = idx === 0 ? 'none' : 'inline-block';
  const isWritten = step.task.type === 'short' || step.task.type === 'exam';
  btnReveal.style.display = isWritten ? 'inline-block' : 'none';
  btnCheck.style.display  = isWritten ? 'none' : 'inline-block';
  btnCheck.disabled = (step.task.type === 'dnd');
  btnNext.disabled  = !stepUnlocked[idx];

  updateProgress();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   BUILD TASK HTML
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function buildTaskHTML(task) {
  let html = `
    <div class="task-header-row">
      <span class="task-type-badge">${task.badge}</span>
      <span class="task-instruction">${task.instruction}</span>
      ${task.xp ? `<span class="xp-pill">+${task.xp} XP</span>` : ''}
    </div>
    <div class="task-question">${task.question.replace(/\n/g,'<br>')}</div>
    <div id="task-feedback" class="feedback-strip"></div>`;

  if (task.type === 'mcq') {
    html += '<div class="mcq-options" id="mcq-options">';
    ['A','B','C','D'].forEach((l,i) => {
      html += `<div class="mcq-opt" id="opt-${i}" onclick="selectMCQ(${i})"><span class="opt-letter">${l}</span>${task.options[i]}</div>`;
    });
    html += '</div>';
  } else if (task.type === 'fitb') {
    html += '<div class="fitb-sentence">';
    task.blanks.forEach((b,i) => {
      html += `${b.before}<input class="fitb-input" id="blank-${i}" placeholder="???" autocomplete="off" spellcheck="false">${b.after}`;
    });
    html += '</div>';
  } else if (task.type === 'dnd') {
    html += '<div class="dnd-layout"><div class="dnd-chips-area"><div class="dnd-chips-title">// DRAG THESE //</div><div class="chips-pool" id="chips-pool">';
    task.chips.forEach(c => { html += `<div class="dnd-chip" id="${c.id}" draggable="true">${c.text}</div>`; });
    html += '</div></div><div class="dnd-targets" id="dnd-targets">';
    task.zones.forEach(z => {
      html += `<div class="drop-zone" id="zone-${z.id}" data-zone="${z.id}"><div class="dz-label" style="color:${z.color}">${z.label}</div><div class="dz-content" id="dzc-${z.id}">${z.hint}</div></div>`;
    });
    html += '</div></div>';
  } else if (task.type === 'short' || task.type === 'exam') {
    html += `<div class="short-answer-wrap"><textarea class="short-answer-ta" id="short-ta" placeholder="Write your answer here‚Ä¶" rows="5"></textarea><div class="word-count" id="wc">0 WORDS</div></div>
    <div class="model-answer-box" id="model-box"><span class="ma-label">‚ñ∏ MODEL ANSWER // MARK SCHEME</span><div class="ma-text">${task.model}</div></div>`;
  }
  return html;
}

function attachWordCount() {
  setTimeout(() => {
    const ta = document.getElementById('short-ta');
    if (ta) ta.addEventListener('input', () => {
      const w = ta.value.trim().split(/\s+/).filter(x=>x).length;
      const el = document.getElementById('wc');
      if (el) el.textContent = `${w} WORD${w!==1?'S':''}`;
    });
  }, 100);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MCQ SELECT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function selectMCQ(idx) {
  if (document.getElementById('btn-check').disabled) return;
  mcqSelected = idx;
  document.querySelectorAll('.mcq-opt').forEach((o,i) => {
    o.classList.remove('selected');
    if (i === idx) o.classList.add('selected');
  });
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   CHECK ANSWER
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function checkAnswer() {
  const task = STEPS[currentStep].task;
  let passed = false;
  let speedBonus = 0;
  if (timerMode && timerSeconds > 0) speedBonus = Math.floor(timerSeconds / (task.type==='short'||task.type==='exam' ? 180 : 45) * 50);
  stopTimer();

  if (task.type === 'mcq') {
    if (mcqSelected === -1) return;
    passed = (mcqSelected === task.correct);
    const opts = document.querySelectorAll('.mcq-opt');
    opts.forEach(o => o.classList.add('locked'));
    opts[mcqSelected].classList.add(passed ? 'correct' : 'wrong');
    if (!passed) opts[task.correct].classList.add('reveal');
    showFeedback(passed ? task.fb_ok : task.fb_err, passed ? 'ok' : 'err');
  } else if (task.type === 'fitb') {
    let allRight = true;
    task.blanks.forEach((b,i) => {
      const inp = document.getElementById(`blank-${i}`);
      if (!inp) return;
      const val = inp.value.trim().toLowerCase();
      const ok  = val === b.answer || (b.alt && b.alt.includes(val));
      inp.classList.add(ok ? 'correct' : 'wrong');
      inp.disabled = true;
      if (!ok) { allRight = false; inp.value = b.answer; }
    });
    passed = allRight;
    showFeedback(passed ? task.fb_ok : task.fb_err, passed ? 'ok' : 'err');
  } else if (task.type === 'dnd') {
    let allRight = true;
    task.chips.forEach(c => {
      const placed = dndState[c.id];
      if (placed === c.answer) {
        document.getElementById(`zone-${placed}`)?.classList.add('correct-zone');
      } else {
        allRight = false;
        document.getElementById(`zone-${placed}`)?.classList.add('wrong-zone');
        document.getElementById(`zone-${c.answer}`)?.classList.add('correct-zone');
      }
    });
    passed = allRight;
    document.querySelectorAll('.dnd-chip').forEach(ch => { ch.setAttribute('draggable','false'); ch.style.cursor='default'; });
    showFeedback(passed ? task.fb_ok : task.fb_err, passed ? 'ok' : 'err');
  }

  document.getElementById('btn-check').disabled = true;

  if (passed) {
    correctCount++;
    awardXP(task.xp, speedBonus, true);
  } else {
    breakStreak();
  }
  if (passed) unlockNext();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   REVEAL MODEL ANSWER
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function revealModel() {
  stopTimer();
  document.getElementById('model-box')?.classList.add('visible');
  awardXP(30, 0, false);
  unlockNext();
  showFeedback('Model answer revealed. Did your answer include an [I] Impact statement?','info');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   XP ENGINE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function getStreakMult() {
  if (currentStreak >= 4) return 2.5;
  if (currentStreak >= 3) return 2.0;
  if (currentStreak >= 2) return 1.5;
  return 1.0;
}

function awardXP(base, speedBonus, updateStreak) {
  if (updateStreak) {
    currentStreak++;
    if (currentStreak > bestStreak) bestStreak = currentStreak;
  }
  const mult   = updateStreak ? getStreakMult() : 1;
  const earned = Math.round(base * mult) + speedBonus;
  totalXP     += earned;
  totalSpeedXP += speedBonus;

  // XP pop
  popXP(`+${earned} XP${speedBonus > 0 ? ' ‚ö°' : ''}${mult > 1 ? ` √ó${mult}` : ''}`);

  updateXPBar();
  updateStreakUI();
  checkRankUp();
  checkSecrets();
}

function breakStreak() {
  currentStreak = 0;
  updateStreakUI();
}

function updateXPBar() {
  const rank = getRank(totalXP);
  const next = RANKS[rank.idx + 1];
  const pct  = next
    ? ((totalXP - rank.min) / (next.min - rank.min) * 100)
    : 100;

  document.getElementById('xp-fill').style.width  = Math.min(100, pct) + '%';
  document.getElementById('xp-total').textContent  = totalXP + ' XP';
  const rankEl = document.getElementById('xp-rank');
  rankEl.textContent = rank.name;
}

function updateStreakUI() {
  const mult   = getStreakMult();
  const sCount = document.getElementById('streak-count');
  const sIcon  = document.getElementById('streak-icon');
  const sMult  = document.getElementById('streak-mult');
  sCount.textContent = currentStreak;
  sCount.style.color = currentStreak > 0 ? 'var(--green)' : 'var(--text-dim)';
  sIcon.textContent  = currentStreak >= 3 ? 'üî•' : (currentStreak > 0 ? '‚ú®' : 'üí§');
  if (currentStreak >= 3) sIcon.style.transform = 'scale(1.2)'; else sIcon.style.transform = '';
  sMult.textContent = `√ó${mult.toFixed(1)}`;
  sMult.className   = 'streak-mult' + (mult >= 2 ? ' hot' : '');
}

function getRank(xp) {
  let r = RANKS[0];
  RANKS.forEach((rank, i) => { if (xp >= rank.min) { r = rank; r = {...rank, idx: i}; } });
  return r;
}

function checkRankUp() {
  const rank = getRank(totalXP);
  if (rank.idx > currentRankIdx) {
    currentRankIdx = rank.idx;
    showRankUp(rank);
  }
}

function showRankUp(rank) {
  const overlay = document.getElementById('rankup-overlay');
  const remaining = RANKS.length - 1 - rank.idx;
  document.getElementById('rankup-icon').textContent  = rank.icon;
  document.getElementById('rankup-title').textContent = rank.name;
  document.getElementById('rankup-sub').textContent   =
    remaining > 0 ? `${remaining} MORE RANK${remaining>1?'S':''} TO UNLOCK` : 'TOP RANK ACHIEVED ‚Äî INSIGHT ARCHITECT';
  overlay.classList.add('show');
  setTimeout(() => overlay.classList.remove('show'), 2200);
}

function popXP(text) {
  const el = document.createElement('div');
  el.className = 'xp-pop';
  el.textContent = text;
  el.style.left = (50 + Math.random() * 20 - 10) + '%';
  el.style.top  = '100px';
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 1300);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SECRETS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function checkSecrets() {
  let newUnlocks = 0;
  SECRETS.forEach(s => {
    if (totalXP >= s.unlockAt) newUnlocks++;
  });
  const prev = parseInt(document.getElementById('secrets-badge').dataset.count || '0');
  if (newUnlocks > prev) {
    secretsNewCount = newUnlocks - prev;
    const badge = document.getElementById('secrets-badge');
    badge.textContent = secretsNewCount;
    badge.classList.add('show');
    document.getElementById('secrets-badge').dataset.count = newUnlocks;
    renderSecrets();
  }
}

function renderSecrets() {
  const list = document.getElementById('secrets-list');
  list.innerHTML = '';
  SECRETS.forEach(s => {
    const unlocked = totalXP >= s.unlockAt;
    const card = document.createElement('div');
    card.className = 'secret-card' + (unlocked ? '' : ' locked');
    card.innerHTML = unlocked
      ? `<div class="sc-label">üîì ${s.label}</div><div class="sc-text">${s.text}</div>`
      : `<div class="sc-label"><span class="sc-lock">üîí</span> LOCKED <span class="sc-unlock-at">UNLOCK AT ${s.unlockAt} XP</span></div><div class="sc-text" style="color:var(--text-dimmer)">Earn more XP to reveal this examiner insight.</div>`;
    list.appendChild(card);
  });
}

function toggleSecrets() {
  const panel = document.getElementById('secrets-panel');
  panel.classList.toggle('open');
  if (panel.classList.contains('open')) {
    document.getElementById('secrets-badge').classList.remove('show');
    document.getElementById('secrets-badge').dataset.count = SECRETS.filter(s => totalXP >= s.unlockAt).length;
    renderSecrets();
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   TIMER
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function startTimer(seconds) {
  if (!timerMode) return;
  timerSeconds = seconds;
  updateTimerUI();
  timerInterval = setInterval(() => {
    timerSeconds--;
    updateTimerUI();
    if (timerSeconds <= 0) {
      stopTimer();
      timeUp();
    }
  }, 1000);
}

function stopTimer() {
  if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
}

function updateTimerUI() {
  const total   = STEPS[currentStep]?.task?.type === 'short' || STEPS[currentStep]?.task?.type === 'exam' ? 180 : 45;
  const ring    = document.getElementById('timer-ring');
  const arc     = document.getElementById('timer-arc');
  const val     = document.getElementById('timer-val');
  const circ    = 88;
  const offset  = circ - (timerSeconds / total) * circ;
  if (arc)  arc.style.strokeDashoffset = offset;
  if (val)  val.textContent = timerSeconds > 99 ? Math.ceil(timerSeconds/60) + 'm' : timerSeconds;

  ring?.classList.remove('warning','danger');
  val?.classList.remove('danger');
  if (timerSeconds <= 10) { ring?.classList.add('danger'); val?.classList.add('danger'); }
  else if (timerSeconds <= 20) { ring?.classList.add('warning'); }
}

function timeUp() {
  showFeedback('‚è± Time\'s up! No XP awarded for this question.','err');
  document.getElementById('btn-check').disabled = true;
  document.querySelectorAll('.mcq-opt').forEach(o => o.classList.add('locked'));
  if (STEPS[currentStep].task.type === 'mcq' && STEPS[currentStep].task.correct !== undefined) {
    document.querySelectorAll('.mcq-opt')[STEPS[currentStep].task.correct]?.classList.add('reveal');
  }
  breakStreak();
  unlockNext();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   DRAG AND DROP
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function attachDnD(task) {
  document.querySelectorAll('.dnd-chip').forEach(chip => {
    chip.addEventListener('dragstart', e => { e.dataTransfer.setData('chipId', chip.id); chip.classList.add('dragging'); });
    chip.addEventListener('dragend', () => chip.classList.remove('dragging'));
    let touchChip = null;
    chip.addEventListener('touchstart', () => { touchChip = chip; chip.classList.add('dragging'); }, { passive: true });
    chip.addEventListener('touchend', e => {
      if (!touchChip) return;
      const t = e.changedTouches[0];
      const el = document.elementFromPoint(t.clientX, t.clientY);
      const zone = el?.closest('.drop-zone');
      if (zone) placeChip(touchChip.id, zone.dataset.zone, task);
      touchChip.classList.remove('dragging'); touchChip = null;
    }, { passive: true });
  });
  document.querySelectorAll('.drop-zone').forEach(zone => {
    zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('over'); });
    zone.addEventListener('dragleave', () => zone.classList.remove('over'));
    zone.addEventListener('drop', e => {
      e.preventDefault(); zone.classList.remove('over');
      placeChip(e.dataTransfer.getData('chipId'), zone.dataset.zone, task);
    });
  });
}

function placeChip(chipId, zoneId, task) {
  const chip = document.getElementById(chipId);
  if (!chip) return;
  Object.keys(dndState).forEach(cid => { if (dndState[cid] === zoneId) dndState[cid] = null; });
  dndState[chipId] = zoneId;
  const zc = document.getElementById(`dzc-${zoneId}`);
  if (zc) { zc.textContent = chip.textContent; zc.classList.add('filled'); }
  chip.classList.add('placed');
  const allPlaced = Object.values(dndState).every(v => v !== null);
  if (allPlaced) document.getElementById('btn-check').disabled = false;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   PROGRESS + NAV
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function updateProgress() {
  const pct = (currentStep / STEPS.length) * 100;
  document.getElementById('pb-fill').style.width = pct + '%';
  document.getElementById('pb-label').textContent = `${currentStep+1}/${STEPS.length}`;
  document.querySelectorAll('.sdot').forEach((d,i) => {
    d.className = 'sdot';
    if (i < currentStep) d.classList.add('done');
    else if (i === currentStep) d.classList.add('active');
  });
}

function showFeedback(msg, type) {
  const fb = document.getElementById('task-feedback');
  if (!fb) return;
  fb.className = `feedback-strip show ${type}`;
  fb.innerHTML = msg;
}

function unlockNext() {
  stepUnlocked[currentStep] = true;
  document.getElementById('btn-next').disabled = false;
}

function nextStep() {
  if (currentStep < STEPS.length - 1) {
    renderStep(currentStep + 1);
  } else {
    showComplete();
  }
}

function prevStep() {
  if (currentStep > 0) renderStep(currentStep - 1);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   COMPLETE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function showComplete() {
  stopTimer();
  document.getElementById('app').style.display       = 'none';
  document.getElementById('bottom-nav').style.display = 'none';
  document.getElementById('complete-screen').classList.add('show');

  const rank = getRank(totalXP);
  document.getElementById('cs-xp').textContent      = totalXP;
  document.getElementById('cs-correct').textContent  = `${correctCount}/${STEPS.length}`;
  document.getElementById('cs-streak').textContent   = bestStreak;
  document.getElementById('cs-rank').textContent     = rank.name;

  if (totalSpeedXP > 0) {
    document.getElementById('cs-speed-wrap').style.display = 'block';
    document.getElementById('cs-speed').textContent = `+${totalSpeedXP}`;
  }

  // Pre-fill leaderboard name
  if (lbOptIn && playerName) document.getElementById('lb-name').value = playerName;
  if (!lbOptIn) document.getElementById('leaderboard-section').style.display = 'none';

  // Save personal best
  const pb = parseInt(localStorage.getItem('msm_611_pb') || '0');
  if (totalXP > pb) localStorage.setItem('msm_611_pb', totalXP);

  document.getElementById('pb-fill').style.width  = '100%';
  document.getElementById('pb-label').textContent = 'COMPLETE';
  document.querySelectorAll('.sdot').forEach(d => d.className = 'sdot done');

  loadLeaderboard();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   LEADERBOARD
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function submitScore() {
  const name = document.getElementById('lb-name').value.trim() || 'ANONYMOUS';
  const rank = getRank(totalXP);
  await fbPush({ name, xp: totalXP, rank: rank.name, ts: Date.now() });
  document.getElementById('lb-submit-row').style.display = 'none';
  document.getElementById('lb-submitted').style.display  = 'block';
  setTimeout(loadLeaderboard, 800);
}

async function loadLeaderboard() {
  const data = await fbGet();
  if (!data) return;
  const entries = Object.values(data)
    .sort((a,b) => b.xp - a.xp)
    .slice(0, 10);

  const table = document.getElementById('lb-table');
  if (!entries.length) { table.innerHTML = '<div style="font-size:12px;color:var(--text-dim);font-family:Share Tech Mono,monospace;letter-spacing:1px;padding:8px 0">No scores yet ‚Äî be the first!</div>'; return; }

  table.innerHTML = entries.map((e,i) => `
    <div class="lb-row">
      <div class="lb-pos ${i<3?'top':''}">${i===0?'ü•á':i===1?'ü•à':i===2?'ü•â':i+1}</div>
      <div class="lb-name">${e.name}</div>
      <div class="lb-xp">${e.xp} XP</div>
      <div class="lb-rank-text">${e.rank}</div>
    </div>`).join('');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   BADGE DEFINITIONS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const BADGES = [
  // COMPLETION
  { id:'first_contact',     icon:'üéñÔ∏è', name:'FIRST CONTACT',       rarity:'common',    category:'COMPLETION',
    desc:'Complete the lesson for the first time. Every Insight Architect starts here.' },
  { id:'full_debrief',      icon:'üìã', name:'FULL DEBRIEF',         rarity:'rare',      category:'COMPLETION',
    desc:'Complete all 6 steps in a single session without abandoning the lesson.' },
  // PERFORMANCE
  { id:'flawless_protocol', icon:'‚ö°', name:'FLAWLESS PROTOCOL',    rarity:'legendary', category:'PERFORMANCE',
    desc:'Zero wrong answers on all auto-graded questions. Pure accuracy.' },
  { id:'speed_operator',    icon:'‚è±Ô∏è', name:'SPEED OPERATOR',       rarity:'rare',      category:'PERFORMANCE',
    desc:'Answer 3 or more timed questions with over 20 seconds remaining.' },
  { id:'overclock',         icon:'üî•', name:'OVERCLOCK',            rarity:'rare',      category:'PERFORMANCE',
    desc:'Build a streak of 5 correct answers in a row ‚Äî hitting the √ó2.5 multiplier.' },
  { id:'max_intel',         icon:'üíé', name:'MAX INTEL',            rarity:'legendary', category:'PERFORMANCE',
    desc:'Finish the lesson with 550 XP or more. Near-perfect execution.' },
  // BEHAVIOUR
  { id:'chain_reaction',    icon:'‚õìÔ∏è', name:'CHAIN REACTION',       rarity:'common',    category:'BEHAVIOUR',
    desc:'Get 3 correct answers in a row. Momentum is everything.' },
  { id:'knowledge_seeker',  icon:'üîç', name:'KNOWLEDGE SEEKER',     rarity:'common',    category:'BEHAVIOUR',
    desc:'Reveal a model answer. Examining the mark scheme is how professionals think.' },
  { id:'second_pass',       icon:'üîÑ', name:'SECOND PASS',          rarity:'rare',      category:'BEHAVIOUR',
    desc:'Restart and complete the lesson a second time. Mastery takes repetition.' },
  // MASTERY
  { id:'data_mind',         icon:'üìä', name:'DATA MIND',            rarity:'common',    category:'MASTERY',
    desc:'Correctly categorise the Data layer in the drag-and-drop mission.' },
  { id:'impact_expert',     icon:'üéØ', name:'IMPACT EXPERT',        rarity:'rare',      category:'MASTERY',
    desc:'Reveal both model answers ‚Äî the full N.E.I. mark scheme exposed.' },
  { id:'insight_architect', icon:'üß†', name:'INSIGHT ARCHITECT',    rarity:'legendary', category:'MASTERY',
    desc:'Reach the top rank. You think exactly the way examiners want you to think.' },
];

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   BADGE STATE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let earnedBadges     = new Set();
let badgeQueue       = [];          // queue for sequential mid-lesson reveals
let badgeShowing     = false;
let badgeDismissTimer = null;
let wrongAnswerCount = 0;           // track for FLAWLESS
let speedAnswerCount = 0;           // track for SPEED_OPERATOR (>20s left)
let modelsRevealed   = new Set();   // track which step indices revealed model

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   BADGE ENGINE ‚Äî AWARD
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function tryAwardBadge(id) {
  if (earnedBadges.has(id)) return;
  const badge = BADGES.find(b => b.id === id);
  if (!badge) return;
  earnedBadges.add(id);

  // Save to localStorage
  const saved = JSON.parse(localStorage.getItem('msm_611_badges') || '[]');
  if (!saved.includes(id)) { saved.push(id); localStorage.setItem('msm_611_badges', JSON.stringify(saved)); }

  // Queue the interrupt overlay
  badgeQueue.push(badge);
  if (!badgeShowing) processBadgeQueue();
}

function processBadgeQueue() {
  if (!badgeQueue.length) { badgeShowing = false; return; }
  badgeShowing = true;
  const badge = badgeQueue.shift();
  showBadgeInterrupt(badge);
}

function showBadgeInterrupt(badge) {
  // Pause timer during reveal
  if (timerInterval) { clearInterval(timerInterval); }

  const overlay   = document.getElementById('badge-interrupt');
  const card      = document.getElementById('bi-card');
  const iconEl    = document.getElementById('bi-icon');
  const rarityEl  = document.getElementById('bi-rarity');
  const nameEl    = document.getElementById('bi-name');
  const descEl    = document.getElementById('bi-desc');
  const catEl     = document.getElementById('bi-cat');
  const timerFill = document.getElementById('bi-timer-fill');

  // Reset animation by replacing element
  const newFill = timerFill.cloneNode();
  timerFill.parentNode.replaceChild(newFill, timerFill);

  card.className      = `bi-card ${badge.rarity}`;
  iconEl.textContent  = badge.icon;
  rarityEl.className  = `bi-rarity ${badge.rarity}`;
  rarityEl.textContent = badge.rarity.toUpperCase();
  nameEl.className    = `bi-name ${badge.rarity}`;
  nameEl.textContent  = badge.name;
  descEl.textContent  = badge.desc;
  catEl.textContent   = badge.category;
  newFill.className   = `bi-timer-fill ${badge.rarity}`;

  overlay.classList.add('show');

  // Auto-dismiss after 3s
  badgeDismissTimer = setTimeout(() => dismissBadge(), 3100);
}

function dismissBadge() {
  clearTimeout(badgeDismissTimer);

  const overlay = document.getElementById('badge-interrupt');
  overlay.classList.remove('show');

  // Resume timer if mid-lesson
  if (timerMode && timerSeconds > 0 && !stepUnlocked[currentStep]) {
    timerInterval = setInterval(() => {
      timerSeconds--;
      updateTimerUI();
      if (timerSeconds <= 0) { stopTimer(); timeUp(); }
    }, 1000);
  }

  // Small delay then process next in queue
  setTimeout(() => processBadgeQueue(), 350);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   BADGE CHECKS ‚Äî called at key moments
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function checkBadgesOnCorrect() {
  // CHAIN REACTION ‚Äî streak hits 3
  if (currentStreak >= 3) tryAwardBadge('chain_reaction');
  // OVERCLOCK ‚Äî streak hits 5
  if (currentStreak >= 5) tryAwardBadge('overclock');
}

function checkBadgesOnWrong() {
  wrongAnswerCount++;
}

function checkBadgesOnSpeedAnswer() {
  // Called when a timed question is answered with >20s left
  if (timerMode && timerSeconds > 20) {
    speedAnswerCount++;
    if (speedAnswerCount >= 3) tryAwardBadge('speed_operator');
  }
}

function checkBadgesOnDnD() {
  // DATA MIND ‚Äî correct data chip placed in data zone
  tryAwardBadge('data_mind');
}

function checkBadgesOnModelReveal(stepIdx) {
  modelsRevealed.add(stepIdx);
  tryAwardBadge('knowledge_seeker');
  // IMPACT EXPERT ‚Äî both written steps (2 and 5) revealed
  if (modelsRevealed.has(2) && modelsRevealed.has(5)) tryAwardBadge('impact_expert');
}

function checkBadgesOnComplete() {
  // FIRST CONTACT
  tryAwardBadge('first_contact');
  // FULL DEBRIEF ‚Äî all steps unlocked
  if (stepUnlocked.every(Boolean)) tryAwardBadge('full_debrief');
  // FLAWLESS PROTOCOL ‚Äî no wrong answers
  if (wrongAnswerCount === 0) tryAwardBadge('flawless_protocol');
  // MAX INTEL
  if (totalXP >= 550) tryAwardBadge('max_intel');
  // INSIGHT ARCHITECT ‚Äî top rank
  if (totalXP >= 600) tryAwardBadge('insight_architect');
  // SECOND PASS
  const completions = parseInt(localStorage.getItem('msm_611_completions') || '0') + 1;
  localStorage.setItem('msm_611_completions', completions);
  if (completions >= 2) tryAwardBadge('second_pass');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   BADGE CABINET RENDER (end screen)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderBadgeCabinet() {
  const grid = document.getElementById('bc-grid');
  if (!grid) return;

  // Merge session earned + previously saved
  const savedArr  = JSON.parse(localStorage.getItem('msm_611_badges') || '[]');
  const allEarned = new Set([...earnedBadges, ...savedArr]);

  grid.innerHTML = '';
  BADGES.forEach(badge => {
    const isEarned  = allEarned.has(badge.id);
    const isNew     = earnedBadges.has(badge.id);
    const item      = document.createElement('div');
    item.className  = `bc-item ${isEarned ? 'earned ' + badge.rarity : 'locked'}`;
    item.title      = isEarned ? badge.desc : 'Locked ‚Äî keep playing to unlock';
    item.innerHTML  = `
      ${isNew ? '<div class="bc-new-dot"></div>' : ''}
      <span class="bc-icon">${isEarned ? badge.icon : 'üîí'}</span>
      <div class="bc-name">${isEarned ? badge.name : '???'}</div>
      <div class="bc-cat">${badge.category}</div>`;
    grid.appendChild(item);
  });

  const earned = allEarned.size;
  document.querySelector('.bc-title').textContent = `‚ñ∏ BADGE COLLECTION // ${earned}/12 UNLOCKED`;
}

/* ‚îÄ‚îÄ Patch into existing checkAnswer to add badge checks ‚îÄ‚îÄ */
const _origCheckAnswer = checkAnswer;
checkAnswer = function() {
  const task = STEPS[currentStep].task;
  const wasWrong = wrongAnswerCount;

  _origCheckAnswer();

  // Detect if it was correct by checking if next button got enabled
  const nextEnabled = !document.getElementById('btn-next').disabled;
  const nowWrong    = wrongAnswerCount;

  if (nextEnabled && nowWrong === wasWrong) {
    // Correct answer
    checkBadgesOnCorrect();
    checkBadgesOnSpeedAnswer();
    if (task.type === 'dnd' && currentStep === 3) checkBadgesOnDnD();
  }
}

/* ‚îÄ‚îÄ Patch revealModel ‚îÄ‚îÄ */
const _origRevealModel = revealModel;
revealModel = function() {
  _origRevealModel();
  checkBadgesOnModelReveal(currentStep);
}

/* ‚îÄ‚îÄ Patch showComplete ‚îÄ‚îÄ */
const _origShowComplete = showComplete;
showComplete = function() {
  _origShowComplete();
  checkBadgesOnComplete();
  // Render cabinet after queue (slight delay so badge overlays show first)
  setTimeout(renderBadgeCabinet, 400);
}

/* ‚îÄ‚îÄ Patch checkAnswer to count wrong answers ‚îÄ‚îÄ */
const _origAwardXP = awardXP;
// Track wrong answers via breakStreak patch
const _origBreakStreak = breakStreak;
breakStreak = function() {
  wrongAnswerCount++;
  _origBreakStreak();
}

function restartLesson() {
  stopTimer();
  currentStep = 0; stepUnlocked = new Array(STEPS.length).fill(false);
  totalXP = 0; currentStreak = 0; bestStreak = 0; totalSpeedXP = 0;
  correctCount = 0; currentRankIdx = 0; secretsNewCount = 0; dndState = {};
  earnedBadges = new Set(); badgeQueue = []; badgeShowing = false;
  wrongAnswerCount = 0; speedAnswerCount = 0; modelsRevealed = new Set();

  document.getElementById('complete-screen').classList.remove('show');
  document.getElementById('app').style.display        = 'grid';
  document.getElementById('bottom-nav').style.display = 'flex';
  document.getElementById('xp-fill').style.width      = '0%';
  document.getElementById('xp-total').textContent     = '0 XP';

  renderSecrets();
  updateStreakUI();
  renderStep(0);
}
</script>
</body>
</html>


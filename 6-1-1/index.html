<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The Mark Scheme Method® — Specialist Training</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;700;900&family=Share+Tech+Mono&family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --void: #0D1117;
    --void-2: #0a0e13;
    --panel: rgba(255,255,255,0.05);
    --panel-border: rgba(255,255,255,0.08);
    --green: #39FF14;
    --green-dim: rgba(57,255,20,0.15);
    --green-glow: rgba(57,255,20,0.4);
    --gold: #FFD700;
    --gold-dim: rgba(255,215,0,0.15);
    --gold-glow: rgba(255,215,0,0.4);
    --red: #FF3B3B;
    --amber: #FF9500;
    --text-primary: #E8EDF3;
    --text-dim: rgba(232,237,243,0.5);
    --text-ghost: rgba(232,237,243,0.2);
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Rajdhani', sans-serif;
    background: var(--void);
    color: var(--text-primary);
    min-height: 100vh;
    overflow-x: hidden;
    cursor: default;
  }

  /* ── GRID BACKGROUND ── */
  body::before {
    content: '';
    position: fixed; inset: 0;
    background-image:
      linear-gradient(rgba(57,255,20,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(57,255,20,0.03) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }

  /* ── SCANLINE ── */
  body::after {
    content: '';
    position: fixed; inset: 0;
    background: repeating-linear-gradient(
      0deg, transparent, transparent 2px,
      rgba(0,0,0,0.08) 2px, rgba(0,0,0,0.08) 4px
    );
    pointer-events: none;
    z-index: 1;
  }

  /* ── TOP NAV ── */
  .topbar {
    position: fixed; top: 0; left: 0; right: 0;
    height: 56px;
    background: rgba(13,17,23,0.9);
    backdrop-filter: blur(20px);
    border-bottom: 1px solid var(--panel-border);
    display: flex; align-items: center; justify-content: space-between;
    padding: 0 32px;
    z-index: 100;
  }

  .logo {
    font-family: 'Orbitron', monospace;
    font-size: 13px;
    font-weight: 700;
    letter-spacing: 3px;
    color: var(--green);
    text-shadow: 0 0 20px var(--green-glow);
  }

  .logo span { color: var(--gold); }

  .progress-bar-wrap {
    display: flex; align-items: center; gap: 12px;
  }

  .step-dots {
    display: flex; gap: 8px;
  }

  .step-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    border: 1px solid var(--text-ghost);
    background: transparent;
    transition: all 0.3s;
  }

  .step-dot.done { background: var(--green); border-color: var(--green); box-shadow: 0 0 8px var(--green-glow); }
  .step-dot.active { background: var(--gold); border-color: var(--gold); box-shadow: 0 0 8px var(--gold-glow); animation: pulse-dot 1.5s ease-in-out infinite; }

  @keyframes pulse-dot {
    0%,100% { transform: scale(1); }
    50% { transform: scale(1.3); }
  }

  .sys-status {
    font-family: 'Share Tech Mono', monospace;
    font-size: 11px;
    color: var(--green);
    opacity: 0.7;
  }

  /* ── SCENE CONTAINER ── */
  .scene {
    display: none;
    min-height: 100vh;
    padding: 80px 24px 40px;
    position: relative;
    z-index: 2;
    animation: scene-in 0.6s ease-out;
  }

  .scene.active { display: flex; flex-direction: column; align-items: center; justify-content: flex-start; }

  @keyframes scene-in {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* ── GLASS PANEL ── */
  .glass {
    background: var(--panel);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid var(--panel-border);
    border-radius: 16px;
  }

  .glass-gold {
    background: rgba(255,215,0,0.05);
    backdrop-filter: blur(12px);
    border: 1px solid rgba(255,215,0,0.2);
    border-radius: 16px;
  }

  .glass-green {
    background: rgba(57,255,20,0.05);
    backdrop-filter: blur(12px);
    border: 1px solid rgba(57,255,20,0.2);
    border-radius: 16px;
  }

  /* ── SCENE 1: BRIEFING ── */
  .briefing-container {
    max-width: 900px;
    width: 100%;
    margin-top: 20px;
  }

  .mission-header {
    text-align: center;
    margin-bottom: 40px;
  }

  .mission-tag {
    font-family: 'Share Tech Mono', monospace;
    font-size: 11px;
    letter-spacing: 4px;
    color: var(--gold);
    margin-bottom: 12px;
    display: block;
    animation: fade-in 0.8s ease 0.2s both;
  }

  .mission-title {
    font-family: 'Orbitron', monospace;
    font-size: clamp(28px, 5vw, 48px);
    font-weight: 900;
    line-height: 1.1;
    color: var(--text-primary);
    animation: fade-in 0.8s ease 0.4s both;
  }

  .mission-title .green { color: var(--green); text-shadow: 0 0 30px var(--green-glow); }
  .mission-title .gold { color: var(--gold); text-shadow: 0 0 30px var(--gold-glow); }

  @keyframes fade-in {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .avatar-briefing {
    display: grid;
    grid-template-columns: 220px 1fr;
    gap: 32px;
    align-items: center;
    animation: fade-in 0.8s ease 0.6s both;
  }

  @media (max-width: 700px) {
    .avatar-briefing { grid-template-columns: 1fr; }
  }

  .avatar-card {
    padding: 24px;
    text-align: center;
    position: relative;
    overflow: hidden;
  }

  .avatar-card::before {
    content: '';
    position: absolute; inset: 0;
    background: radial-gradient(circle at 50% 30%, rgba(57,255,20,0.1), transparent 70%);
  }

  .avatar-figure {
    width: 120px; height: 120px;
    margin: 0 auto 16px;
    border-radius: 50%;
    border: 2px solid var(--green);
    box-shadow: 0 0 30px var(--green-glow), inset 0 0 30px rgba(57,255,20,0.1);
    display: flex; align-items: center; justify-content: center;
    font-size: 60px;
    background: radial-gradient(circle, rgba(57,255,20,0.15), transparent);
    animation: avatar-pulse 3s ease-in-out infinite;
  }

  @keyframes avatar-pulse {
    0%,100% { box-shadow: 0 0 30px var(--green-glow), inset 0 0 30px rgba(57,255,20,0.1); }
    50% { box-shadow: 0 0 60px var(--green-glow), inset 0 0 40px rgba(57,255,20,0.2); }
  }

  .avatar-name {
    font-family: 'Orbitron', monospace;
    font-size: 12px;
    font-weight: 700;
    color: var(--green);
    letter-spacing: 2px;
  }

  .avatar-title {
    font-family: 'Share Tech Mono', monospace;
    font-size: 10px;
    color: var(--text-dim);
    letter-spacing: 1px;
    margin-top: 4px;
  }

  .briefing-panel {
    padding: 32px;
    position: relative;
  }

  .terminal-label {
    font-family: 'Share Tech Mono', monospace;
    font-size: 10px;
    color: var(--green);
    letter-spacing: 2px;
    margin-bottom: 20px;
    display: flex; align-items: center; gap: 8px;
  }

  .terminal-label::before {
    content: '';
    width: 6px; height: 6px;
    border-radius: 50%;
    background: var(--green);
    box-shadow: 0 0 10px var(--green-glow);
    animation: blink 1s step-end infinite;
  }

  @keyframes blink { 0%,100% { opacity: 1; } 50% { opacity: 0; } }

  .briefing-text {
    font-family: 'Share Tech Mono', monospace;
    font-size: 14px;
    line-height: 1.8;
    color: var(--text-primary);
  }

  .briefing-text .highlight-green { color: var(--green); }
  .briefing-text .highlight-gold { color: var(--gold); }
  .briefing-text .highlight-red { color: var(--red); }

  .nei-trio {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 12px;
    margin-top: 28px;
  }

  @media (max-width: 600px) { .nei-trio { grid-template-columns: 1fr; } }

  .nei-card {
    padding: 16px;
    border-radius: 12px;
    text-align: center;
  }

  .nei-letter {
    font-family: 'Orbitron', monospace;
    font-size: 28px;
    font-weight: 900;
    margin-bottom: 6px;
  }

  .nei-label {
    font-family: 'Share Tech Mono', monospace;
    font-size: 10px;
    letter-spacing: 2px;
    margin-bottom: 8px;
    opacity: 0.7;
  }

  .nei-desc {
    font-size: 13px;
    color: var(--text-dim);
    line-height: 1.4;
  }

  .n-card { border-color: rgba(255,59,59,0.3); background: rgba(255,59,59,0.05); }
  .n-card .nei-letter { color: var(--red); text-shadow: 0 0 20px rgba(255,59,59,0.5); }
  .e-card { border-color: rgba(255,149,0,0.3); background: rgba(255,149,0,0.05); }
  .e-card .nei-letter { color: var(--amber); text-shadow: 0 0 20px rgba(255,149,0,0.5); }
  .i-card { border-color: rgba(57,255,20,0.3); background: rgba(57,255,20,0.05); }
  .i-card .nei-letter { color: var(--green); text-shadow: 0 0 20px var(--green-glow); }

  /* ── BUTTONS ── */
  .btn-primary {
    font-family: 'Orbitron', monospace;
    font-size: 13px;
    font-weight: 700;
    letter-spacing: 3px;
    padding: 16px 40px;
    background: transparent;
    border: 2px solid var(--green);
    color: var(--green);
    border-radius: 4px;
    cursor: pointer;
    position: relative;
    overflow: hidden;
    transition: all 0.3s;
    text-transform: uppercase;
  }

  .btn-primary::before {
    content: '';
    position: absolute; inset: 0;
    background: var(--green);
    transform: translateX(-100%);
    transition: transform 0.3s ease;
  }

  .btn-primary:hover::before { transform: translateX(0); }
  .btn-primary:hover { color: var(--void); }
  .btn-primary span { position: relative; z-index: 1; }

  .btn-gold {
    font-family: 'Orbitron', monospace;
    font-size: 12px;
    font-weight: 700;
    letter-spacing: 2px;
    padding: 14px 32px;
    background: transparent;
    border: 2px solid var(--gold);
    color: var(--gold);
    border-radius: 4px;
    cursor: pointer;
    position: relative;
    overflow: hidden;
    transition: all 0.3s;
  }

  .btn-gold::before {
    content: '';
    position: absolute; inset: 0;
    background: var(--gold);
    transform: translateX(-100%);
    transition: transform 0.3s;
  }

  .btn-gold:hover::before { transform: translateX(0); }
  .btn-gold:hover { color: var(--void); }
  .btn-gold span { position: relative; z-index: 1; }

  .btn-ghost {
    font-family: 'Rajdhani', sans-serif;
    font-size: 14px;
    font-weight: 600;
    letter-spacing: 1px;
    padding: 12px 28px;
    background: transparent;
    border: 1px solid var(--panel-border);
    color: var(--text-dim);
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.3s;
  }

  .btn-ghost:hover { border-color: var(--text-dim); color: var(--text-primary); }

  .btn-row {
    display: flex; gap: 16px; justify-content: center;
    margin-top: 40px;
    flex-wrap: wrap;
  }

  /* ── SCENE 2: DRAG & DROP ── */
  .dd-container {
    max-width: 860px; width: 100%;
    margin-top: 20px;
  }

  .scene-label {
    font-family: 'Share Tech Mono', monospace;
    font-size: 11px;
    color: var(--gold);
    letter-spacing: 4px;
    text-align: center;
    margin-bottom: 8px;
    display: block;
    animation: fade-in 0.5s ease both;
  }

  .scene-headline {
    font-family: 'Orbitron', monospace;
    font-size: clamp(20px, 4vw, 32px);
    font-weight: 700;
    text-align: center;
    margin-bottom: 8px;
    animation: fade-in 0.5s ease 0.1s both;
  }

  .scene-sub {
    font-size: 15px;
    color: var(--text-dim);
    text-align: center;
    margin-bottom: 36px;
    animation: fade-in 0.5s ease 0.2s both;
    max-width: 600px;
  }

  .dd-area {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 32px;
    animation: fade-in 0.5s ease 0.3s both;
  }

  @media (max-width: 650px) { .dd-area { grid-template-columns: 1fr; } }

  .dd-chips-area {
    padding: 24px;
  }

  .dd-chips-title {
    font-family: 'Share Tech Mono', monospace;
    font-size: 11px;
    letter-spacing: 3px;
    color: var(--text-dim);
    margin-bottom: 16px;
  }

  .chips-pool {
    display: flex;
    flex-direction: column;
    gap: 10px;
    min-height: 140px;
  }

  .data-chip {
    font-family: 'Share Tech Mono', monospace;
    font-size: 14px;
    padding: 12px 18px;
    border-radius: 8px;
    border: 1px solid var(--panel-border);
    background: rgba(255,255,255,0.04);
    cursor: grab;
    transition: all 0.2s;
    user-select: none;
    display: flex; align-items: center; gap: 10px;
  }

  .data-chip::before { content: '⣿'; font-size: 10px; opacity: 0.3; }
  .data-chip:hover { border-color: var(--gold); color: var(--gold); transform: translateX(4px); }
  .data-chip.dragging { opacity: 0.4; transform: scale(0.95); }

  .dd-targets {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .drop-zone {
    padding: 18px 20px;
    border-radius: 12px;
    border: 1px dashed var(--panel-border);
    min-height: 68px;
    display: flex;
    align-items: center;
    gap: 14px;
    transition: all 0.2s;
    position: relative;
  }

  .drop-zone.over {
    border-color: var(--gold);
    background: rgba(255,215,0,0.05);
  }

  .drop-zone.correct {
    border-color: var(--green) !important;
    background: rgba(57,255,20,0.07) !important;
    border-style: solid !important;
  }

  .drop-zone.incorrect {
    border-color: var(--red) !important;
    background: rgba(255,59,59,0.07) !important;
    border-style: solid !important;
    animation: shake 0.4s ease;
  }

  @keyframes shake {
    0%,100% { transform: translateX(0); }
    25% { transform: translateX(-8px); }
    75% { transform: translateX(8px); }
  }

  .dz-badge {
    font-family: 'Orbitron', monospace;
    font-size: 11px;
    font-weight: 700;
    padding: 4px 10px;
    border-radius: 4px;
    white-space: nowrap;
    flex-shrink: 0;
  }

  .dz-label {
    font-size: 14px;
    color: var(--text-dim);
    flex: 1;
  }

  .dz-answer {
    font-family: 'Share Tech Mono', monospace;
    font-size: 13px;
  }

  .dz-empty { font-style: italic; opacity: 0.4; }

  .dd-feedback {
    margin-top: 20px;
    padding: 16px 20px;
    border-radius: 12px;
    font-family: 'Share Tech Mono', monospace;
    font-size: 13px;
    display: none;
  }

  .dd-feedback.show { display: block; animation: fade-in 0.4s ease both; }
  .dd-feedback.success { border: 1px solid var(--green); background: rgba(57,255,20,0.07); color: var(--green); }
  .dd-feedback.error { border: 1px solid var(--red); background: rgba(255,59,59,0.07); color: var(--red); }

  /* ── SCENE 3: MISSION / TERMINAL ── */
  .mission-layout {
    max-width: 1000px; width: 100%;
    display: grid;
    grid-template-columns: 1fr 220px;
    gap: 24px;
    margin-top: 20px;
    align-items: flex-start;
  }

  @media (max-width: 750px) { .mission-layout { grid-template-columns: 1fr; } }

  .terminal-panel {
    padding: 0;
    overflow: hidden;
  }

  .terminal-header {
    display: flex; align-items: center; gap: 8px;
    padding: 14px 20px;
    background: rgba(57,255,20,0.05);
    border-bottom: 1px solid var(--panel-border);
  }

  .terminal-dots {
    display: flex; gap: 6px;
  }

  .tdot {
    width: 10px; height: 10px;
    border-radius: 50%;
  }
  .tdot.r { background: #ff5f56; }
  .tdot.y { background: #ffbd2e; }
  .tdot.g { background: var(--green); }

  .terminal-path {
    font-family: 'Share Tech Mono', monospace;
    font-size: 11px;
    color: var(--text-dim);
    margin-left: 8px;
  }

  .question-block {
    padding: 24px;
    border-bottom: 1px solid var(--panel-border);
  }

  .q-tag {
    font-family: 'Share Tech Mono', monospace;
    font-size: 10px;
    letter-spacing: 3px;
    color: var(--gold);
    margin-bottom: 10px;
  }

  .q-text {
    font-family: 'Rajdhani', sans-serif;
    font-size: 16px;
    font-weight: 600;
    line-height: 1.6;
    color: var(--text-primary);
  }

  .q-marks {
    display: inline-block;
    font-family: 'Orbitron', monospace;
    font-size: 11px;
    color: var(--gold);
    border: 1px solid rgba(255,215,0,0.4);
    border-radius: 4px;
    padding: 2px 8px;
    margin-left: 8px;
  }

  .answer-area {
    padding: 20px;
  }

  .answer-textarea {
    width: 100%;
    min-height: 160px;
    background: rgba(57,255,20,0.03);
    border: 1px solid rgba(57,255,20,0.2);
    border-radius: 8px;
    color: var(--text-primary);
    font-family: 'Rajdhani', sans-serif;
    font-size: 16px;
    font-weight: 500;
    line-height: 1.7;
    padding: 16px;
    resize: vertical;
    outline: none;
    transition: border-color 0.2s;
  }

  .answer-textarea:focus {
    border-color: var(--green);
    box-shadow: 0 0 0 3px rgba(57,255,20,0.08);
  }

  .answer-textarea::placeholder { color: var(--text-ghost); }

  .char-count {
    font-family: 'Share Tech Mono', monospace;
    font-size: 11px;
    color: var(--text-dim);
    text-align: right;
    margin-top: 8px;
  }

  /* ── METHOD RIBBON / HUD ── */
  .method-ribbon {
    padding: 24px 16px;
    display: flex;
    flex-direction: column;
    gap: 16px;
    position: sticky;
    top: 80px;
  }

  .ribbon-title {
    font-family: 'Orbitron', monospace;
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 3px;
    color: var(--text-dim);
    text-align: center;
  }

  .nei-hud-item {
    padding: 16px 12px;
    border-radius: 10px;
    text-align: center;
    border: 1px solid;
    transition: all 0.4s;
    opacity: 0.35;
  }

  .nei-hud-item.active-n { opacity: 1; border-color: rgba(255,59,59,0.5); background: rgba(255,59,59,0.08); }
  .nei-hud-item.active-e { opacity: 1; border-color: rgba(255,149,0,0.5); background: rgba(255,149,0,0.08); }
  .nei-hud-item.active-i { opacity: 1; border-color: rgba(57,255,20,0.5); background: rgba(57,255,20,0.08); }

  .hud-letter {
    font-family: 'Orbitron', monospace;
    font-size: 24px;
    font-weight: 900;
    display: block;
    margin-bottom: 4px;
  }

  .hud-n { border-color: rgba(255,59,59,0.2); }
  .hud-n .hud-letter { color: var(--red); }
  .hud-e { border-color: rgba(255,149,0,0.2); }
  .hud-e .hud-letter { color: var(--amber); }
  .hud-i { border-color: rgba(57,255,20,0.2); }
  .hud-i .hud-letter { color: var(--green); }
  @keyframes hud-glitch { 0%{filter:invert(0) brightness(1)} 20%{filter:invert(1) brightness(2)} 40%{filter:invert(0) brightness(1)} 60%{filter:invert(1) brightness(2)} 80%{filter:invert(0) brightness(1)} 100%{filter:invert(0) brightness(1)} }

  /* ── ACE v2: PROGRESS BAR ── */
  .energy-bar-wrap { display:flex; align-items:center; gap:10px; margin-top:10px; }
  .energy-bar-track { flex:1; height:8px; background:rgba(255,255,255,0.06); border-radius:4px; overflow:hidden; border:1px solid rgba(255,255,255,0.08); }
  .energy-bar-fill { height:100%; width:0%; border-radius:4px; transition:width 0.3s ease, background 0.4s ease; }
  .energy-bar-fill.eb-red   { background:var(--red);   box-shadow:none; }
  .energy-bar-fill.eb-amber { background:var(--amber); animation:bar-pulse 1.2s ease infinite; }
  .energy-bar-fill.eb-green { background:var(--green); animation:bar-flash 0.6s ease forwards; }
  @keyframes bar-pulse { 0%,100%{opacity:1} 50%{opacity:0.55} }
  @keyframes bar-flash { 0%{box-shadow:none} 50%{box-shadow:0 0 18px rgba(57,255,20,0.7)} 100%{box-shadow:0 0 10px rgba(57,255,20,0.4)} }
  .energy-bar-label { font-family:'Share Tech Mono',monospace; font-size:11px; min-width:160px; transition:color 0.4s; }

  /* ── ACE v2: IMPACT PULSE on [I] HUD panel ── */
  @keyframes impact-pulse { 0%,100%{box-shadow:0 0 0 rgba(57,255,20,0)} 50%{box-shadow:0 0 14px rgba(57,255,20,0.5)} }

  /* ── ACE v2: REBOOT OVERLAY ── */
  #reboot-overlay { display:none; position:fixed; inset:0; z-index:9999; background:#0D1117; flex-direction:column; align-items:center; justify-content:center; font-family:'Orbitron',monospace; }
  #reboot-overlay .rb-line1 { font-size:clamp(11px,2vw,14px); color:var(--red); letter-spacing:4px; opacity:0; transition:opacity 0.3s; text-align:center; padding:0 20px; }
  #reboot-overlay .rb-line2 { font-size:clamp(16px,3.5vw,30px); font-weight:900; color:var(--green); letter-spacing:5px; margin-top:16px; opacity:0; transition:opacity 0.4s; text-align:center; padding:0 20px; }
  #reboot-overlay .rb-bar-wrap { max-width:400px; width:90%; margin-top:32px; }
  #reboot-overlay .rb-bar { height:3px; width:0%; background:var(--green); box-shadow:0 0 12px rgba(57,255,20,0.6); transition:none; }

  /* ═══════════════════════════════════════════════════
     KNOWLEDGE CHECK OVERLAY
  ═══════════════════════════════════════════════════ */
  #kc-overlay {
    position: fixed; inset: 0; z-index: 2000;
    background: rgba(13,17,23,0.96);
    backdrop-filter: blur(16px);
    display: none;
    align-items: center;
    justify-content: center;
    padding: 24px;
    overflow-y: auto;
  }
  #kc-overlay.active { display: flex; }

  .kc-panel {
    width: 100%; max-width: 680px;
    background: rgba(255,255,255,0.04);
    border: 1px solid rgba(57,255,20,0.2);
    border-radius: 12px;
    padding: 36px 40px;
    position: relative;
    box-shadow: 0 0 60px rgba(57,255,20,0.06);
  }
  .kc-panel .corner-tl {
    position:absolute; top:0; left:0; width:18px; height:18px;
    border-top:2px solid var(--green); border-left:2px solid var(--green); border-radius:12px 0 0 0;
  }
  .kc-panel .corner-br {
    position:absolute; bottom:0; right:0; width:18px; height:18px;
    border-bottom:2px solid var(--green); border-right:2px solid var(--green); border-radius:0 0 12px 0;
  }
  .kc-header {
    display: flex; align-items: center; gap: 14px;
    margin-bottom: 6px;
  }
  .kc-avatar { font-size: 28px; }
  .kc-header-text {}
  .kc-title {
    font-family: 'Orbitron', monospace; font-size: 13px;
    font-weight: 700; color: var(--green); letter-spacing: 2px;
    text-transform: uppercase;
  }
  .kc-sub {
    font-family: 'Share Tech Mono', monospace; font-size: 10px;
    color: var(--text-dim); letter-spacing: 1px; margin-top: 3px;
  }
  .kc-divider {
    border: none; border-top: 1px solid rgba(255,255,255,0.06);
    margin: 18px 0 24px;
  }
  .kc-progress-row {
    display: flex; align-items: center; gap: 12px; margin-bottom: 28px;
  }
  .kc-pips { display: flex; gap: 6px; }
  .kc-pip {
    width: 28px; height: 4px; border-radius: 2px;
    background: rgba(255,255,255,0.1);
    transition: background 0.3s ease, box-shadow 0.3s ease;
  }
  .kc-pip.done  { background: var(--green); box-shadow: 0 0 8px rgba(57,255,20,0.5); }
  .kc-pip.active { background: var(--gold); box-shadow: 0 0 8px rgba(255,215,0,0.5); animation: pulse-dot 1.2s ease infinite; }
  .kc-pip.wrong  { background: var(--red); box-shadow: 0 0 8px rgba(255,59,59,0.5); }
  .kc-q-counter {
    font-family: 'Share Tech Mono', monospace; font-size: 10px;
    color: var(--text-dim); letter-spacing: 1px; margin-left: auto;
  }

  .kc-question {
    font-family: 'Rajdhani', sans-serif; font-size: 17px; font-weight: 600;
    color: var(--text-primary); line-height: 1.5; margin-bottom: 20px;
  }
  .kc-question .kc-q-label {
    font-family: 'Share Tech Mono', monospace; font-size: 10px;
    color: var(--gold); letter-spacing: 2px; display: block; margin-bottom: 8px;
  }

  .kc-options { display: flex; flex-direction: column; gap: 10px; margin-bottom: 24px; }
  .kc-option {
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 8px; padding: 13px 16px;
    cursor: pointer; display: flex; align-items: center; gap: 12px;
    font-family: 'Rajdhani', sans-serif; font-size: 15px; font-weight: 500;
    color: var(--text-primary); transition: all 0.15s ease;
    user-select: none;
  }
  .kc-option:hover:not(.kc-answered) {
    border-color: rgba(255,215,0,0.35);
    background: rgba(255,215,0,0.04);
    color: var(--gold);
  }
  .kc-option .kc-opt-letter {
    font-family: 'Share Tech Mono', monospace; font-size: 11px;
    letter-spacing: 1px; color: var(--text-dim); min-width: 18px;
  }
  .kc-option.correct {
    border-color: rgba(57,255,20,0.5); background: rgba(57,255,20,0.07);
    color: var(--green);
  }
  .kc-option.correct .kc-opt-letter { color: var(--green); }
  .kc-option.wrong {
    border-color: rgba(255,59,59,0.5); background: rgba(255,59,59,0.07);
    color: var(--red);
  }
  .kc-option.wrong .kc-opt-letter { color: var(--red); }
  .kc-option.reveal-correct {
    border-color: rgba(57,255,20,0.3); background: rgba(57,255,20,0.04);
    color: rgba(57,255,20,0.6);
  }
  .kc-option.kc-answered { cursor: default; pointer-events: none; }

  .kc-instant-feedback {
    font-family: 'Rajdhani', sans-serif; font-size: 14px; font-weight: 500;
    line-height: 1.5; padding: 12px 16px; border-radius: 6px;
    margin-bottom: 20px; display: none;
    animation: fade-in 0.3s ease;
  }
  .kc-instant-feedback.correct-fb {
    background: rgba(57,255,20,0.07); border: 1px solid rgba(57,255,20,0.25);
    color: var(--green); display: block;
  }
  .kc-instant-feedback.wrong-fb {
    background: rgba(255,59,59,0.07); border: 1px solid rgba(255,59,59,0.25);
    color: var(--text-primary); display: block;
  }

  .kc-next-btn {
    font-family: 'Share Tech Mono', monospace; font-size: 11px;
    letter-spacing: 2px; background: transparent;
    border: 1px solid rgba(57,255,20,0.4); color: var(--green);
    border-radius: 6px; padding: 10px 24px; cursor: pointer;
    transition: all 0.2s ease; display: none;
  }
  .kc-next-btn.visible { display: inline-block; }
  .kc-next-btn:hover { background: rgba(57,255,20,0.08); border-color: var(--green); }

  /* RESULT SCREEN */
  .kc-result { display: none; text-align: center; }
  .kc-result.active { display: block; }
  .kc-result-icon { font-size: 52px; margin-bottom: 16px; }
  .kc-result-title {
    font-family: 'Orbitron', monospace; font-size: 18px; font-weight: 900;
    letter-spacing: 3px; margin-bottom: 8px;
  }
  .kc-result-title.pass { color: var(--green); text-shadow: 0 0 20px rgba(57,255,20,0.5); }
  .kc-result-title.fail { color: var(--gold); text-shadow: 0 0 20px rgba(255,215,0,0.4); }
  .kc-result-score {
    font-family: 'Share Tech Mono', monospace; font-size: 12px;
    color: var(--text-dim); letter-spacing: 2px; margin-bottom: 24px;
  }
  .kc-result-score span { color: var(--text-primary); }

  /* Targeted explanation cards */
  .kc-remediation { margin-bottom: 28px; }
  .kc-remediation-title {
    font-family: 'Share Tech Mono', monospace; font-size: 10px;
    letter-spacing: 2px; color: var(--gold); margin-bottom: 14px;
  }
  .kc-remedy-card {
    background: rgba(255,215,0,0.04); border: 1px solid rgba(255,215,0,0.2);
    border-radius: 8px; padding: 16px 18px; margin-bottom: 10px;
    text-align: left;
  }
  .kc-remedy-card .remedy-q {
    font-family: 'Share Tech Mono', monospace; font-size: 10px;
    color: var(--gold); letter-spacing: 1px; margin-bottom: 8px;
  }
  .kc-remedy-card .remedy-text {
    font-family: 'Rajdhani', sans-serif; font-size: 14px; font-weight: 500;
    color: var(--text-primary); line-height: 1.6;
  }
  .kc-remedy-card .remedy-text strong { color: var(--green); }

  .kc-proceed-btn {
    font-family: 'Orbitron', monospace; font-size: 11px; font-weight: 700;
    letter-spacing: 2px; background: var(--green); color: #0D1117;
    border: none; border-radius: 6px; padding: 14px 32px;
    cursor: pointer; transition: all 0.2s ease;
    box-shadow: 0 0 20px rgba(57,255,20,0.3);
  }
  .kc-proceed-btn:hover { box-shadow: 0 0 32px rgba(57,255,20,0.5); transform: translateY(-1px); }
  .kc-proceed-btn.gold-btn {
    background: var(--gold); color: #0D1117;
    box-shadow: 0 0 20px rgba(255,215,0,0.3);
  }
  .kc-proceed-btn.gold-btn:hover { box-shadow: 0 0 32px rgba(255,215,0,0.5); }

  .hud-label {
    font-family: 'Share Tech Mono', monospace;
    font-size: 10px;
    letter-spacing: 2px;
    color: var(--text-dim);
    margin-bottom: 6px;
  }

  .hud-hint {
    font-size: 12px;
    color: var(--text-dim);
    line-height: 1.4;
  }

  .hud-check {
    font-family: 'Share Tech Mono', monospace;
    font-size: 10px;
    margin-top: 8px;
    padding: 4px 8px;
    border-radius: 4px;
    display: none;
  }

  .hud-check.ok { display: block; background: rgba(57,255,20,0.15); color: var(--green); }
  .hud-check.warn { display: block; background: rgba(255,59,59,0.15); color: var(--red); }

  /* ── SCENE 4: SELF-CALIBRATION ── */
  .calibration-layout {
    max-width: 960px; width: 100%;
    margin-top: 20px;
    display: grid;
    grid-template-columns: 1fr 280px;
    gap: 24px;
    align-items: flex-start;
  }

  @media (max-width: 800px) { .calibration-layout { grid-template-columns: 1fr; } }

  .cal-main { display: flex; flex-direction: column; gap: 20px; }

  .model-answer-panel { padding: 24px; }
  .ma-title {
    font-family: 'Share Tech Mono', monospace;
    font-size: 11px;
    letter-spacing: 3px;
    color: var(--gold);
    margin-bottom: 16px;
  }

  .ma-text {
    font-size: 15px;
    line-height: 1.8;
    font-weight: 500;
  }

  .ma-n { background: rgba(255,59,59,0.25); color: #ffaaaa; border-radius: 3px; padding: 1px 4px; }
  .ma-e { background: rgba(255,149,0,0.25); color: #ffcc88; border-radius: 3px; padding: 1px 4px; }
  .ma-i { background: rgba(57,255,20,0.2); color: #aaff88; border-radius: 3px; padding: 1px 4px; }

  .ma-legend {
    display: flex; gap: 16px; margin-top: 16px; flex-wrap: wrap;
  }

  .legend-item {
    display: flex; align-items: center; gap: 6px;
    font-family: 'Share Tech Mono', monospace;
    font-size: 11px;
  }

  .legend-dot {
    width: 10px; height: 10px;
    border-radius: 2px;
  }

  /* ── HIGHLIGHTER TOOLBAR ── */
  .highlight-toolbar {
    padding: 20px;
    position: sticky;
    top: 80px;
  }

  .toolbar-title {
    font-family: 'Orbitron', monospace;
    font-size: 11px;
    letter-spacing: 2px;
    color: var(--text-dim);
    margin-bottom: 20px;
    text-align: center;
  }

  .hl-btn {
    width: 100%;
    padding: 14px 16px;
    border-radius: 10px;
    border: 1px solid;
    background: transparent;
    cursor: pointer;
    font-family: 'Orbitron', monospace;
    font-size: 12px;
    font-weight: 700;
    letter-spacing: 2px;
    display: flex;
    align-items: center;
    gap: 10px;
    transition: all 0.2s;
    margin-bottom: 10px;
  }

  .hl-btn.active { transform: translateX(4px); }

  .hl-n { border-color: rgba(255,59,59,0.4); color: var(--red); }
  .hl-n:hover, .hl-n.active { background: rgba(255,59,59,0.15); border-color: var(--red); }
  .hl-e { border-color: rgba(255,149,0,0.4); color: var(--amber); }
  .hl-e:hover, .hl-e.active { background: rgba(255,149,0,0.15); border-color: var(--amber); }
  .hl-i { border-color: rgba(57,255,20,0.4); color: var(--green); }
  .hl-i:hover, .hl-i.active { background: rgba(57,255,20,0.15); border-color: var(--green); }

  .hl-icon { font-size: 18px; }

  .hl-instructions {
    font-family: 'Share Tech Mono', monospace;
    font-size: 11px;
    color: var(--text-dim);
    line-height: 1.6;
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid var(--panel-border);
  }

  .student-answer-area { padding: 24px; }
  .sa-title {
    font-family: 'Share Tech Mono', monospace;
    font-size: 11px;
    letter-spacing: 3px;
    color: var(--text-dim);
    margin-bottom: 16px;
  }

  #student-display {
    font-size: 16px;
    line-height: 1.9;
    font-weight: 500;
    cursor: text;
    min-height: 80px;
  }

  #student-display .hl-n-tag { background: rgba(255,59,59,0.3); color: #ffcccc; border-radius: 3px; padding: 0 3px; }
  #student-display .hl-e-tag { background: rgba(255,149,0,0.3); color: #ffe0aa; border-radius: 3px; padding: 0 3px; }
  #student-display .hl-i-tag { background: rgba(57,255,20,0.25); color: #bbffaa; border-radius: 3px; padding: 0 3px; }

  /* ── VULNERABILITY ALERT ── */
  .vulnerability-alert {
    display: none;
    padding: 20px 24px;
    border: 1px solid var(--red);
    background: rgba(255,59,59,0.08);
    border-radius: 12px;
    animation: vuln-in 0.5s ease both;
  }

  .vulnerability-alert.show { display: block; }

  @keyframes vuln-in {
    from { transform: scale(0.95); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
  }

  .vuln-header {
    display: flex; align-items: center; gap: 10px;
    font-family: 'Orbitron', monospace;
    font-size: 13px;
    font-weight: 700;
    color: var(--red);
    margin-bottom: 12px;
  }

  .vuln-icon {
    width: 32px; height: 32px;
    border-radius: 50%;
    background: rgba(255,59,59,0.2);
    border: 1px solid var(--red);
    display: flex; align-items: center; justify-content: center;
    font-size: 16px;
    animation: pulse-red 1s ease-in-out infinite;
  }

  @keyframes pulse-red {
    0%,100% { box-shadow: 0 0 0 0 rgba(255,59,59,0.4); }
    50% { box-shadow: 0 0 0 8px rgba(255,59,59,0); }
  }

  .vuln-msg {
    font-family: 'Share Tech Mono', monospace;
    font-size: 13px;
    color: var(--text-primary);
    line-height: 1.7;
  }

  .vuln-msg strong { color: var(--red); }

  .success-alert {
    display: none;
    padding: 20px 24px;
    border: 1px solid var(--green);
    background: rgba(57,255,20,0.07);
    border-radius: 12px;
    animation: fade-in 0.5s ease both;
  }

  .success-alert.show { display: block; }

  .success-header {
    display: flex; align-items: center; gap: 10px;
    font-family: 'Orbitron', monospace;
    font-size: 13px;
    font-weight: 700;
    color: var(--green);
    margin-bottom: 12px;
  }

  .nei-tally {
    display: flex; gap: 12px; margin-top: 12px; flex-wrap: wrap;
  }

  .tally-chip {
    font-family: 'Share Tech Mono', monospace;
    font-size: 12px;
    padding: 6px 14px;
    border-radius: 20px;
    border: 1px solid;
  }

  .tally-n { border-color: var(--red); background: rgba(255,59,59,0.1); color: #ff8888; }
  .tally-e { border-color: var(--amber); background: rgba(255,149,0,0.1); color: #ffcc88; }
  .tally-i { border-color: var(--green); background: rgba(57,255,20,0.1); color: #aaff88; }

  /* ── SCENE 5: SUCCESS / BADGE ── */
  .success-scene {
    max-width: 700px; width: 100%;
    margin-top: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 32px;
  }

  .badge-container {
    position: relative;
    width: 200px; height: 200px;
    margin: 0 auto;
  }

  .badge-3d {
    width: 200px; height: 200px;
    border-radius: 50%;
    background: conic-gradient(var(--gold), var(--green), var(--gold), var(--green), var(--gold));
    display: flex; align-items: center; justify-content: center;
    animation: badge-spin 8s linear infinite, badge-float 3s ease-in-out infinite;
    box-shadow: 0 0 60px rgba(255,215,0,0.4), 0 0 120px rgba(57,255,20,0.2);
    cursor: pointer;
  }

  @keyframes badge-spin {
    from { filter: hue-rotate(0deg); }
    to { filter: hue-rotate(360deg); }
  }

  @keyframes badge-float {
    0%,100% { transform: translateY(0) rotate(0deg); }
    50% { transform: translateY(-12px) rotate(3deg); }
  }

  .badge-inner {
    width: 170px; height: 170px;
    border-radius: 50%;
    background: radial-gradient(circle, #1a2030, var(--void));
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 20px;
    box-shadow: inset 0 0 40px rgba(0,0,0,0.5);
  }

  .badge-icon { font-size: 48px; margin-bottom: 8px; }

  .badge-rank {
    font-family: 'Orbitron', monospace;
    font-size: 8px;
    letter-spacing: 2px;
    color: var(--gold);
    font-weight: 700;
  }

  .badge-name {
    font-family: 'Orbitron', monospace;
    font-size: 10px;
    font-weight: 900;
    color: var(--text-primary);
    letter-spacing: 1px;
    line-height: 1.3;
  }

  .success-card {
    padding: 32px;
    text-align: center;
    width: 100%;
  }

  .success-headline {
    font-family: 'Orbitron', monospace;
    font-size: clamp(20px, 4vw, 32px);
    font-weight: 900;
    color: var(--gold);
    text-shadow: 0 0 30px var(--gold-glow);
    margin-bottom: 12px;
    animation: fade-in 0.6s ease 0.3s both;
  }

  .success-sub {
    font-size: 16px;
    color: var(--text-dim);
    margin-bottom: 28px;
    animation: fade-in 0.6s ease 0.5s both;
  }

  .share-card {
    padding: 20px 24px;
    border-radius: 12px;
    background: linear-gradient(135deg, rgba(255,215,0,0.08), rgba(57,255,20,0.05));
    border: 1px solid rgba(255,215,0,0.25);
    font-family: 'Share Tech Mono', monospace;
    font-size: 15px;
    color: var(--gold);
    margin-bottom: 28px;
    animation: fade-in 0.6s ease 0.7s both;
  }

  .mission-report-btn {
    font-family: 'Orbitron', monospace;
    font-size: 11px;
    letter-spacing: 2px;
    padding: 12px 28px;
    background: rgba(255,215,0,0.1);
    border: 1px solid var(--gold);
    color: var(--gold);
    border-radius: 4px;
    cursor: pointer;
    display: flex; align-items: center; gap: 8px;
    transition: all 0.2s;
    margin: 0 auto;
  }

  .mission-report-btn:hover { background: rgba(255,215,0,0.2); }

  /* ── TEACHER DASHBOARD ── */
  .dashboard-scene {
    max-width: 1040px; width: 100%;
    margin-top: 20px;
  }

  .dashboard-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-top: 24px;
  }

  @media (max-width: 700px) { .dashboard-grid { grid-template-columns: 1fr; } }

  .dash-panel { padding: 24px; }

  .dash-title {
    font-family: 'Share Tech Mono', monospace;
    font-size: 11px;
    letter-spacing: 3px;
    color: var(--gold);
    margin-bottom: 20px;
  }

  .heatmap-grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 6px;
    margin-bottom: 16px;
  }

  .hm-cell {
    aspect-ratio: 1;
    border-radius: 6px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    font-family: 'Share Tech Mono', monospace;
    font-size: 9px;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
    padding: 4px;
  }

  .hm-cell:hover { transform: scale(1.1); z-index: 2; }

  .hm-cell.all-green { background: rgba(57,255,20,0.2); border: 1px solid rgba(57,255,20,0.4); }
  .hm-cell.stuck-e { background: rgba(255,149,0,0.2); border: 1px solid rgba(255,149,0,0.4); }
  .hm-cell.stuck-n { background: rgba(255,59,59,0.2); border: 1px solid rgba(255,59,59,0.4); }

  .hm-name { font-size: 8px; color: var(--text-dim); margin-top: 3px; text-align: center; }
  .hm-score { font-size: 12px; font-weight: bold; }
  .all-green .hm-score { color: var(--green); }
  .stuck-e .hm-score { color: var(--amber); }
  .stuck-n .hm-score { color: var(--red); }

  .heatmap-legend {
    display: flex; gap: 16px;
    font-family: 'Share Tech Mono', monospace;
    font-size: 10px;
    color: var(--text-dim);
    flex-wrap: wrap;
  }

  .legend-row { display: flex; align-items: center; gap: 6px; }
  .leg-sq { width: 12px; height: 12px; border-radius: 3px; }

  .friction-list { display: flex; flex-direction: column; gap: 10px; }

  .friction-item {
    padding: 14px 16px;
    border-radius: 10px;
    border: 1px solid;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 12px;
  }

  .friction-high { border-color: rgba(255,59,59,0.4); background: rgba(255,59,59,0.06); }
  .friction-med { border-color: rgba(255,149,0,0.4); background: rgba(255,149,0,0.06); }

  .friction-topic {
    font-family: 'Rajdhani', sans-serif;
    font-size: 14px;
    font-weight: 600;
  }

  .friction-pct {
    font-family: 'Orbitron', monospace;
    font-size: 16px;
    font-weight: 700;
    flex-shrink: 0;
  }

  .friction-high .friction-pct { color: var(--red); }
  .friction-med .friction-pct { color: var(--amber); }

  .assign-list { display: flex; flex-direction: column; gap: 10px; }

  .assign-item {
    padding: 14px 16px;
    border-radius: 10px;
    border: 1px solid var(--panel-border);
    background: rgba(255,255,255,0.03);
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 12px;
  }

  .assign-module {
    font-family: 'Rajdhani', sans-serif;
    font-size: 14px;
    font-weight: 600;
    flex: 1;
  }

  .assign-btn {
    font-family: 'Share Tech Mono', monospace;
    font-size: 10px;
    letter-spacing: 1px;
    padding: 8px 16px;
    border: 1px solid var(--green);
    background: transparent;
    color: var(--green);
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
  }

  .assign-btn:hover { background: rgba(57,255,20,0.12); }
  .assign-btn.pushed { background: rgba(57,255,20,0.2); border-color: var(--green); }

  /* ── CORNER DECORATIONS ── */
  .corner-tl, .corner-br {
    position: absolute;
    width: 16px; height: 16px;
    pointer-events: none;
  }

  .corner-tl { top: -1px; left: -1px; border-top: 2px solid var(--green); border-left: 2px solid var(--green); }
  .corner-br { bottom: -1px; right: -1px; border-bottom: 2px solid var(--green); border-right: 2px solid var(--green); }

  /* ── NAV TABS ── */
  .nav-tabs {
    display: flex;
    gap: 8px;
    position: fixed;
    bottom: 24px;
    right: 24px;
    z-index: 50;
    flex-direction: column;
    align-items: flex-end;
  }

  .nav-tab-btn {
    font-family: 'Share Tech Mono', monospace;
    font-size: 10px;
    letter-spacing: 1px;
    padding: 8px 16px;
    background: rgba(13,17,23,0.9);
    backdrop-filter: blur(10px);
    border: 1px solid var(--panel-border);
    color: var(--text-dim);
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .nav-tab-btn.active { border-color: var(--gold); color: var(--gold); }
  .nav-tab-btn:hover { border-color: var(--text-dim); color: var(--text-primary); }

  .nav-tab-btn.locked {
    border-color: rgba(255,59,59,0.2);
    color: rgba(232,237,243,0.2);
    cursor: not-allowed;
    position: relative;
  }

  .nav-tab-btn.locked:hover {
    border-color: rgba(255,59,59,0.4);
    color: rgba(255,59,59,0.5);
  }

  /* Shake animation for rejected click */
  @keyframes tab-reject {
    0%,100% { transform: translateX(0); }
    20%     { transform: translateX(-5px); }
    40%     { transform: translateX(5px); }
    60%     { transform: translateX(-3px); }
    80%     { transform: translateX(3px); }
  }

  .nav-tab-btn.rejecting { animation: tab-reject 0.35s ease; }

  /* Locked tooltip nudge */
  #lock-nudge {
    position: fixed;
    bottom: 28px;
    right: 180px;
    background: rgba(255,59,59,0.12);
    border: 1px solid rgba(255,59,59,0.4);
    border-radius: 6px;
    padding: 8px 14px;
    font-family: 'Share Tech Mono', monospace;
    font-size: 11px;
    color: var(--red);
    letter-spacing: 1px;
    white-space: nowrap;
    z-index: 200;
    opacity: 0;
    transform: translateX(8px);
    transition: opacity 0.2s, transform 0.2s;
    pointer-events: none;
  }

  #lock-nudge.show {
    opacity: 1;
    transform: translateX(0);
  }

  /* ── TOOLTIP ── */
  [data-tip] {
    position: relative;
  }

  [data-tip]::after {
    content: attr(data-tip);
    position: absolute;
    bottom: calc(100% + 8px);
    left: 50%;
    transform: translateX(-50%);
    background: rgba(13,17,23,0.95);
    border: 1px solid var(--panel-border);
    border-radius: 6px;
    padding: 8px 12px;
    font-family: 'Share Tech Mono', monospace;
    font-size: 11px;
    color: var(--text-primary);
    white-space: nowrap;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.2s;
    z-index: 200;
  }

  [data-tip]:hover::after { opacity: 1; }

  /* ── SECTION DIVIDER ── */
  .divider {
    width: 100%;
    height: 1px;
    background: linear-gradient(90deg, transparent, var(--green-dim), transparent);
    margin: 32px 0;
  }


  /* ── GLITCH TRANSITION OVERLAY ── */
  #glitch-overlay {
    position: fixed; inset: 0;
    background: var(--void);
    z-index: 999;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    pointer-events: none;
    opacity: 0;
    visibility: hidden;
    will-change: opacity, transform;
  }

  #glitch-overlay.active {
    visibility: visible;
    animation: glitch-sequence 1.8s ease-in-out forwards;
  }

  @keyframes glitch-sequence {
    0%   { opacity: 0; }
    8%   { opacity: 1; }
    15%  { opacity: 0.6; transform: skewX(-3deg); }
    18%  { opacity: 1; transform: skewX(0); }
    30%  { opacity: 1; transform: skewX(2deg) scaleY(1.01); }
    32%  { opacity: 0.7; transform: skewX(-1deg) scaleY(1); }
    55%  { opacity: 1; transform: none; }
    80%  { opacity: 1; }
    100% { opacity: 0; }
  }

  .glitch-scanlines {
    position: absolute; inset: 0;
    background: repeating-linear-gradient(
      0deg,
      transparent,
      transparent 3px,
      rgba(57,255,20,0.04) 3px,
      rgba(57,255,20,0.04) 4px
    );
    animation: scanlines-scroll 0.2s linear infinite;
    pointer-events: none;
  }

  @keyframes scanlines-scroll {
    from { background-position: 0 0; }
    to   { background-position: 0 8px; }
  }

  /* Coloured horizontal glitch bars */
  .glitch-block {
    position: absolute;
    left: 0; right: 0;
    height: 4px;
    mix-blend-mode: screen;
    animation: glitch-bar 1.8s ease-in-out forwards;
  }

  .g1 {
    background: var(--green);
    top: 30%;
    animation-delay: 0.1s;
    animation-name: glitch-bar-1;
  }
  .g2 {
    background: var(--gold);
    top: 52%;
    animation-name: glitch-bar-2;
    animation-delay: 0.25s;
    height: 2px;
  }
  .g3 {
    background: var(--red);
    top: 68%;
    animation-name: glitch-bar-3;
    animation-delay: 0.15s;
    height: 3px;
  }

  @keyframes glitch-bar-1 {
    0%,100% { opacity: 0; transform: translateX(0); }
    10% { opacity: 1; transform: translateX(-8%); }
    14% { opacity: 0; transform: translateX(12%); }
    22% { opacity: 1; transform: translateX(-4%); }
    28% { opacity: 0; }
    40% { opacity: 0.6; transform: translateX(0); }
    55% { opacity: 0; }
  }

  @keyframes glitch-bar-2 {
    0%,100% { opacity: 0; transform: translateX(0) scaleX(1); }
    18% { opacity: 1; transform: translateX(10%) scaleX(0.6); }
    24% { opacity: 0; }
    35% { opacity: 0.8; transform: translateX(-5%) scaleX(1.2); }
    42% { opacity: 0; }
  }

  @keyframes glitch-bar-3 {
    0%,100% { opacity: 0; }
    12% { opacity: 0; transform: translateX(0); }
    16% { opacity: 1; transform: translateX(6%); }
    20% { opacity: 0; transform: translateX(-10%); }
    30% { opacity: 0.5; transform: translateX(0); }
    38% { opacity: 0; }
  }

  .glitch-text {
    font-family: 'Orbitron', monospace;
    font-size: clamp(20px, 5vw, 36px);
    font-weight: 900;
    color: var(--green);
    text-shadow: 0 0 30px var(--green-glow), 0 0 60px var(--green-glow);
    letter-spacing: 6px;
    text-align: center;
    position: relative;
    animation: glitch-text-anim 1.8s ease-in-out forwards;
  }

  @keyframes glitch-text-anim {
    0%   { opacity: 0; transform: translateY(8px); clip-path: inset(0 0 100% 0); }
    10%  { opacity: 1; clip-path: inset(0 0 0 0); transform: translateY(0); }
    18%  { transform: translate(-4px, 0); filter: blur(1px); color: var(--gold); }
    20%  { transform: translate(4px, 0); filter: none; color: var(--green); }
    25%  { transform: none; }
    40%  { opacity: 1; letter-spacing: 6px; }
    55%  { opacity: 1; letter-spacing: 8px; color: var(--green); }
    78%  { opacity: 1; }
    90%  { opacity: 0; letter-spacing: 12px; transform: scale(1.04); }
    100% { opacity: 0; }
  }

  /* Ghost duplicate for RGB-split effect */
  .glitch-text::before,
  .glitch-text::after {
    content: 'SIGNAL REROUTING...';
    position: absolute;
    top: 0; left: 0; right: 0;
    font-family: inherit;
    font-size: inherit;
    font-weight: inherit;
    letter-spacing: inherit;
    text-align: center;
  }

  .glitch-text::before {
    color: var(--red);
    animation: rgb-split-r 1.8s ease-in-out forwards;
    clip-path: inset(20% 0 60% 0);
  }

  .glitch-text::after {
    color: #00ffff;
    animation: rgb-split-c 1.8s ease-in-out forwards;
    clip-path: inset(60% 0 15% 0);
  }

  @keyframes rgb-split-r {
    0%,100% { opacity: 0; transform: translateX(0); }
    15% { opacity: 0.9; transform: translateX(-6px); clip-path: inset(15% 0 55% 0); }
    20% { opacity: 0; transform: translateX(3px); }
    32% { opacity: 0.7; transform: translateX(-3px); clip-path: inset(40% 0 30% 0); }
    36% { opacity: 0; }
    50% { opacity: 0.4; transform: translateX(0); }
    58% { opacity: 0; }
  }

  @keyframes rgb-split-c {
    0%,100% { opacity: 0; transform: translateX(0); }
    15% { opacity: 0.9; transform: translateX(6px); clip-path: inset(55% 0 10% 0); }
    21% { opacity: 0; }
    34% { opacity: 0.7; transform: translateX(3px); clip-path: inset(25% 0 45% 0); }
    38% { opacity: 0; }
    52% { opacity: 0.4; transform: translateX(0); }
    60% { opacity: 0; }
  }

  .glitch-subtext {
    font-family: 'Share Tech Mono', monospace;
    font-size: 13px;
    letter-spacing: 5px;
    color: var(--gold);
    margin-top: 20px;
    text-align: center;
    animation: glitch-sub-anim 1.8s ease-in-out forwards;
  }

  @keyframes glitch-sub-anim {
    0%,12% { opacity: 0; }
    25%  { opacity: 1; }
    65%  { opacity: 1; }
    85%  { opacity: 0; }
    100% { opacity: 0; }
  }

  .glitch-coords {
    font-family: 'Share Tech Mono', monospace;
    font-size: 11px;
    letter-spacing: 3px;
    color: rgba(57,255,20,0.5);
    margin-top: 12px;
    text-align: center;
    animation: glitch-coords-anim 1.8s ease-in-out forwards;
  }

  @keyframes glitch-coords-anim {
    0%,30% { opacity: 0; }
    45%    { opacity: 1; }
    70%    { opacity: 0.6; }
    85%    { opacity: 0; }
    100%   { opacity: 0; }
  }

  /* ── MOBILE PERFORMANCE ── */
  @media (max-width: 600px) {
    /* Simplify glitch on small screens to prevent frame drops */
    .glitch-block { display: none; }
    .glitch-text::before, .glitch-text::after { display: none; }
    .glitch-scanlines { display: none; }
  }

  /* Respect OS-level reduced motion preference */
  @media (prefers-reduced-motion: reduce) {
    #glitch-overlay.active { animation: none; opacity: 1; }
    .glitch-text { animation: none; opacity: 1; }
    .glitch-subtext { animation: none; opacity: 1; }
    .glitch-coords { animation: none; opacity: 1; }
    .glitch-block, .glitch-scanlines,
    .glitch-text::before, .glitch-text::after { display: none; }
  }

  /* ── AXIOM-7 NEI API DECONSTRUCTION PANEL ── */
  #axiom-deconstruction { display:none; margin-top:20px; }
  .axd-header { display:flex; align-items:center; gap:10px; margin-bottom:14px; }
  .axd-title { font-family:'Orbitron',monospace; font-size:12px; font-weight:700; color:var(--green); letter-spacing:3px; }
  .axd-sub { font-family:'Share Tech Mono',monospace; font-size:10px; color:var(--text-dim); letter-spacing:1px; }
  .axd-badges { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:14px; }
  .axd-badge { font-family:'Share Tech Mono',monospace; font-size:11px; padding:6px 12px; border-radius:4px; border:1px solid; letter-spacing:1px; }
  .axd-badge.hit  { color:var(--green); border-color:rgba(57,255,20,0.35); background:rgba(57,255,20,0.06); }
  .axd-badge.miss { color:var(--text-dim); border-color:rgba(255,255,255,0.1); background:transparent; }
  .axd-badge.hit::before { content:'✓  '; }
  .axd-badge.miss::before { content:'○  '; }
  .axd-text-wrap { background:rgba(255,255,255,0.03); border:1px solid var(--panel-border); border-radius:8px; padding:16px 18px; font-family:'Rajdhani',sans-serif; font-size:15px; font-weight:500; line-height:1.8; color:var(--text-primary); }
  .axd-text-wrap .nei-n { background:rgba(255,59,59,0.25); color:#ffcccc; border-radius:3px; padding:1px 4px; }
  .axd-text-wrap .nei-e { background:rgba(255,149,0,0.25); color:#ffe0aa; border-radius:3px; padding:1px 4px; }
  .axd-text-wrap .nei-i { background:rgba(57,255,20,0.2); color:#bbffaa; border-radius:3px; padding:1px 4px; }
  .axd-legend { display:flex; gap:16px; flex-wrap:wrap; margin-top:12px; }
  .axd-legend-item { font-family:'Share Tech Mono',monospace; font-size:10px; color:var(--text-dim); display:flex; align-items:center; gap:6px; }
  .axd-dot { width:10px; height:10px; border-radius:2px; display:inline-block; }
  .axd-loading { font-family:'Share Tech Mono',monospace; font-size:11px; color:var(--text-dim); letter-spacing:2px; padding:16px 0; display:flex; align-items:center; gap:10px; }
  .axd-spinner { width:14px; height:14px; border:2px solid rgba(57,255,20,0.2); border-top-color:var(--green); border-radius:50%; animation:spin-axd 0.8s linear infinite; }
  @keyframes spin-axd { to { transform:rotate(360deg); } }
  .axd-error { font-family:'Share Tech Mono',monospace; font-size:11px; color:var(--amber); letter-spacing:1px; padding:12px 0; }
</style>
</head>
<body>

<!-- TOP BAR -->
<nav class="topbar">
  <div class="logo">MARK SCHEME <span>METHOD</span>®</div>
  <div class="progress-bar-wrap">
    <div class="step-dots">
      <div class="step-dot active" id="dot-1" title="Scene 1: Briefing"></div>
      <div class="step-dot" id="dot-2" title="Scene 2: Interactive Lesson"></div>
      <div class="step-dot" id="dot-3" title="Scene 3: Mission"></div>
      <div class="step-dot" id="dot-4" title="Scene 4: Self-Calibration"></div>
      <div class="step-dot" id="dot-5" title="Scene 5: Success"></div>
    </div>
  </div>
  <div style="display:flex;align-items:center;gap:16px;">
    <a href="../index.html" style="font-family:'Share Tech Mono',monospace;font-size:10px;letter-spacing:2px;color:rgba(232,237,243,0.4);text-decoration:none;border:1px solid rgba(255,255,255,0.08);border-radius:4px;padding:5px 12px;transition:all 0.2s;" onmouseover="this.style.borderColor='rgba(57,255,20,0.4)';this.style.color='#39FF14'" onmouseout="this.style.borderColor='rgba(255,255,255,0.08)';this.style.color='rgba(232,237,243,0.4)'">← HOME</a>
    <div class="sys-status">SYS://ONLINE</div>
  </div>
</nav>

<!-- ================================================================ -->
<!-- SCENE 1: OPERATIONAL BRIEFING                                     -->
<!-- ================================================================ -->
<section class="scene active" id="scene-1">
  <div class="briefing-container">
    <div class="mission-header">
      <span class="mission-tag">CONTENT AREA 6 // DATA // SPECIALIST BRIEFING</span>
      <h1 class="mission-title">
        THE <span class="green">N.E.I.</span><br>METHOD
      </h1>
    </div>

    <div class="avatar-briefing">
      <div class="glass avatar-card" style="position:relative;">
        <div class="corner-tl"></div>
        <div class="corner-br"></div>
        <div class="avatar-figure">🤖</div>
        <div class="avatar-name">AXIOM-7</div>
        <div class="avatar-title">// DATA ARCHITECT //</div>
        <br>
        <div style="display:flex;flex-direction:column;gap:6px;text-align:left;">
          <div style="font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--text-dim);">▸ CLEARANCE: SPECIALIST</div>
          <div style="font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--text-dim);">▸ MODULE: 6.1.1</div>
          <div style="font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--green);">▸ STATUS: LIVE</div>
        </div>
      </div>

      <div class="glass briefing-panel" style="position:relative;">
        <div class="corner-tl"></div>
        <div class="corner-br"></div>
        <div class="terminal-label">OPERATIONAL BRIEFING // AXIOM-7 TRANSMISSION</div>
        <div class="briefing-text">
          "Welcome, <span class="highlight-green">Specialist</span>. You're looking at a raw data stream. To most, this is just noise.<br><br>
          Examiners don't give marks for numbers. They give marks for the <span class="highlight-gold">Impact</span>.<br><br>
          In this mission, we use the <span class="highlight-green">N.E.I. Method</span> to turn noise into power:<br><br>
          <span class="highlight-red">Data</span> is the number.<br>
          <span class="highlight-gold">Information</span> is the story.<br>
          <span class="highlight-green">Knowledge</span> is the move.<br><br>
          <em>Let's get to work.</em>"
        </div>

        <div class="nei-trio">
          <div class="glass nei-card n-card" style="border:1px solid rgba(255,59,59,0.3);">
            <div class="nei-letter">N</div>
            <div class="nei-label">NAME</div>
            <div class="nei-desc">Identify the technical term or tool</div>
          </div>
          <div class="glass nei-card e-card" style="border:1px solid rgba(255,149,0,0.3);">
            <div class="nei-letter">E</div>
            <div class="nei-label">EXPLAIN</div>
            <div class="nei-desc">Describe the mechanism & how it works</div>
          </div>
          <div class="glass nei-card i-card" style="border:1px solid rgba(57,255,20,0.3);">
            <div class="nei-letter">I</div>
            <div class="nei-label">IMPACT</div>
            <div class="nei-desc">Describe the business value & outcome</div>
          </div>
        </div>
      </div>
    </div>

    <div class="btn-row">
      <button class="btn-primary" onclick="openKnowledgeCheck()"><span>⟶ BEGIN MISSION</span></button>
      <button class="nav-tab-btn" onclick="goScene(6)" style="position:static;">🏫 TEACHER VIEW</button>
    </div>
  </div>
</section>

<!-- ================================================================ -->
<!-- SCENE 2: INTERACTIVE LESSON — DRAG & DROP                        -->
<!-- ================================================================ -->
<section class="scene" id="scene-2">
  <div class="dd-container">
    <span class="scene-label">SCENE 02 // CONTENT AREA 6.1.1 // DATA SORTER — GATEKEEPER</span>
    <h2 class="scene-headline">Sort the <span style="color:var(--gold)">GPS Signal</span></h2>
    <p class="scene-sub" style="margin:0 auto 36px;">A logistics vehicle just pinged the system. Three pieces of information came back. Drag each one into the correct tier before you can access the Mission Terminal.</p>

    <div class="dd-area">
      <!-- CHIPS POOL -->
      <div class="glass dd-chips-area">
        <div class="dd-chips-title">// INCOMING SIGNAL — DRAG TO CLASSIFY //</div>
        <div class="chips-pool" id="chips-pool">
          <div class="data-chip" draggable="true" id="chip-a" data-answer="data"><span style="color:var(--gold);font-family:monospace;letter-spacing:1px;">51.5074, 0.1278</span></div>
          <div class="data-chip" draggable="true" id="chip-b" data-answer="information">"Oxford Circus, London"</div>
          <div class="data-chip" draggable="true" id="chip-c" data-answer="knowledge">"Turn left in 200m"</div>
        </div>
      </div>

      <!-- DROP TARGETS -->
      <div class="dd-targets">
        <div class="drop-zone glass" data-target="data">
          <div class="dz-badge" style="background:rgba(255,59,59,0.15);color:var(--red);border:1px solid rgba(255,59,59,0.4);">DATA</div>
          <div class="dz-label">
            <div style="font-family:'Share Tech Mono',monospace;font-size:10px;letter-spacing:1px;color:var(--text-dim);margin-bottom:4px;">Raw numbers — no context, no meaning</div>
            <div class="dz-answer dz-empty" id="drop-data">Drop here...</div>
          </div>
        </div>

        <div class="drop-zone glass" data-target="information">
          <div class="dz-badge" style="background:rgba(255,149,0,0.15);color:var(--amber);border:1px solid rgba(255,149,0,0.4);">INFO</div>
          <div class="dz-label">
            <div style="font-family:'Share Tech Mono',monospace;font-size:10px;letter-spacing:1px;color:var(--text-dim);margin-bottom:4px;">Data with context — now it has meaning</div>
            <div class="dz-answer dz-empty" id="drop-information">Drop here...</div>
          </div>
        </div>

        <div class="drop-zone glass" data-target="knowledge">
          <div class="dz-badge" style="background:rgba(57,255,20,0.1);color:var(--green);border:1px solid rgba(57,255,20,0.3);">KNOW</div>
          <div class="dz-label">
            <div style="font-family:'Share Tech Mono',monospace;font-size:10px;letter-spacing:1px;color:var(--text-dim);margin-bottom:4px;">Actionable instruction — the driver acts</div>
            <div class="dz-answer dz-empty" id="drop-knowledge">Drop here...</div>
          </div>
        </div>
      </div>
    </div>

    <div class="dd-feedback" id="dd-feedback"></div>

    <div class="btn-row">
      <button class="btn-ghost" onclick="goScene(1)">← BACK</button>
      <button class="btn-gold" id="check-dd-btn" onclick="checkDragDrop()"><span>⟶ CHECK ANSWERS</span></button>
    </div>
  </div>
</section>

<!-- ================================================================ -->
<!-- SCENE 3: THE MISSION — EXAM PRACTICE                             -->
<!-- ================================================================ -->
<section class="scene" id="scene-3">
  <div class="mission-layout">
    <!-- TERMINAL -->
    <div class="glass terminal-panel">
      <div class="terminal-header">
        <div class="terminal-dots">
          <div class="tdot r"></div>
          <div class="tdot y"></div>
          <div class="tdot g"></div>
        </div>
        <div class="terminal-path">msm://exam/content-6.1.1/gps-logistics.q1</div>
      </div>

      <div class="question-block">
        <div class="q-tag">// EXAM QUESTION // CONTENT AREA 6.1.1 // DATA → INFORMATION → KNOWLEDGE</div>
        <div class="q-text">
          A logistics company receives a raw data string <span style="color:var(--gold);font-family:monospace;font-size:15px;letter-spacing:1px;">'LAT:51.5074, LON:0.1278'</span>. Explain the process of turning this data into knowledge for the driver.
          <span class="q-marks">3 MARKS</span>
        </div>
      </div>

      <div class="answer-area">
        <div class="terminal-label" style="margin-bottom:12px;">YOUR RESPONSE // USE N.E.I. STRUCTURE</div>
        <textarea
          class="answer-textarea"
          id="student-answer"
          placeholder="Identify the raw coordinates, explain how the software processes them, and state the final instruction for the driver..."
          oninput="updateHUD(this.value); updateWordCount(this.value); resetIdleTimer(this.value)"
          onkeyup="updateHUD(this.value); updateWordCount(this.value); resetIdleTimer(this.value)"
          onpaste="setTimeout(()=>{ const v=this.value; updateHUD(v); updateWordCount(v); resetIdleTimer(v); },10)"
          rows="6"
        ></textarea>
        <div class="energy-bar-wrap">
          <div class="energy-bar-track">
            <div class="energy-bar-fill" id="energy-bar-fill"></div>
          </div>
          <div class="energy-bar-label" id="word-count-display">0 words — aim for 60+</div>
        </div>
        <div id="axiom-feedback" style="display:none;margin-top:14px;padding:14px 18px;border-radius:8px;font-family:'Share Tech Mono',monospace;font-size:12px;line-height:1.6;border:1px solid var(--amber);background:rgba(255,149,0,0.06);color:var(--amber);white-space:pre-line;animation:fade-in 0.4s ease both;"></div>
      </div>

      <div style="padding:0 20px 20px;">
        <div class="btn-row" style="margin-top:0;justify-content:flex-start;">
          <button class="btn-ghost" onclick="goScene(2)">← BACK</button>
          <button class="btn-primary" onclick="submitAnswer()"><span>⟶ SUBMIT FOR CALIBRATION</span></button>
        </div>
      </div>
    </div>

    <!-- METHOD RIBBON HUD -->
    <div class="glass method-ribbon">
      <div class="ribbon-title">METHOD RIBBON</div>

      <div class="nei-hud-item hud-n" id="hud-n">
        <span class="hud-letter">N</span>
        <div class="hud-label">NAME</div>
        <div class="hud-hint">Technical term or tool</div>
        <div class="hud-check" id="hud-n-check"></div>
      </div>

      <div class="nei-hud-item hud-e" id="hud-e">
        <span class="hud-letter">E</span>
        <div class="hud-label">EXPLAIN</div>
        <div class="hud-hint">How the mechanism works</div>
        <div class="hud-check" id="hud-e-check"></div>
      </div>

      <div class="nei-hud-item hud-i" id="hud-i">
        <span class="hud-letter">I</span>
        <div class="hud-label">IMPACT</div>
        <div class="hud-hint">Business value / outcome</div>
        <div class="hud-check" id="hud-i-check"></div>
      </div>

      <div style="padding-top:12px;border-top:1px solid var(--panel-border);font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--text-dim);line-height:1.7;">
        ▸ N+E = 2 marks<br>
        ▸ N+E+I = 3 marks<br>
        ▸ I alone = 0 marks
      </div>
    </div>
  </div>
</section>

<!-- ================================================================ -->
<!-- SCENE 4: SELF-CALIBRATION                                        -->
<!-- ================================================================ -->
<section class="scene" id="scene-4">
  <div class="calibration-layout">
    <div class="cal-main">
      <div>
        <span class="scene-label">SCENE 04 // SELF-CALIBRATION // NEI DECONSTRUCTION</span>
        <h2 class="scene-headline" style="text-align:left;">Mark Your <span style="color:var(--green)">Own Work</span></h2>
      </div>

      <!-- MODEL ANSWER -->
      <div class="glass model-answer-panel">
        <div class="ma-title">// MODEL ANSWER // 3 MARKS ACHIEVED</div>
        <div class="ma-text">
          <span class="ma-n">[N] <strong>Data:</strong> The raw coordinate string <span style="color:var(--gold);font-family:monospace;font-size:13px;">'51.5074, 0.1278'</span> acts as raw data because it lacks meaning or context to the driver.</span>
          &nbsp;
          <span class="ma-e">[E] <strong>Information:</strong> GPS software processes these coordinates by cross-referencing a road network database to provide the context that the vehicle is currently at Oxford Circus, London.</span>
          &nbsp;
          <span class="ma-i">[I] <strong>Knowledge:</strong> By applying traffic logic and routing algorithms to this information, the system provides actionable knowledge — such as <em>"Turn left in 200m"</em> — allowing the driver to complete the delivery on time.</span>
        </div>
        <div class="ma-legend">
          <div class="legend-item"><div class="legend-dot" style="background:rgba(255,59,59,0.5);"></div><span style="color:#ff8888;">[N] Name</span></div>
          <div class="legend-item"><div class="legend-dot" style="background:rgba(255,149,0,0.5);"></div><span style="color:#ffcc88;">[E] Explain</span></div>
          <div class="legend-item"><div class="legend-dot" style="background:rgba(57,255,20,0.4);"></div><span style="color:#aaff88;">[I] Impact</span></div>
        </div>
      </div>

      <!-- STUDENT ANSWER TO HIGHLIGHT -->
      <div class="glass student-answer-area">
        <div class="sa-title">// YOUR ANSWER // SELECT TEXT AND TAG WITH THE TOOLBAR →</div>
        <div id="student-display"></div>
      </div>

      <!-- AXIOM-7 API DECONSTRUCTION -->
      <div class="glass" id="axiom-deconstruction" style="padding:20px;">
        <div class="axd-header">
          <div>
            <div class="axd-title">AXIOM-7 // NEI DECONSTRUCTION</div>
            <div class="axd-sub">// AI-ASSISTED ANALYSIS — COMPARE WITH YOUR OWN TAGGING ABOVE</div>
          </div>
        </div>
        <div id="axd-content">
          <div class="axd-loading"><div class="axd-spinner"></div>SCANNING RESPONSE...</div>
        </div>
      </div>

      <!-- TALLY + ALERTS -->
      <div id="nei-tally-display" style="display:none;" class="glass" style="padding:20px;">
        <div style="padding:16px 20px;">
          <div style="font-family:'Share Tech Mono',monospace;font-size:10px;letter-spacing:3px;color:var(--text-dim);margin-bottom:12px;">// NEI PROFICIENCY SCAN</div>
          <div class="nei-tally" id="nei-tally"></div>
        </div>
      </div>

      <div class="vulnerability-alert" id="vuln-alert">
        <div class="vuln-header">
          <div class="vuln-icon">⚠</div>
          VULNERABILITY DETECTED
        </div>
        <div class="vuln-msg">
          <strong>Specialist — AXIOM-7 has detected an Impact statement in your answer, but you haven't tagged it yet.</strong><br><br>
          Scroll up to your answer, select the sentence that states what the driver can <em>do</em> or what the business <em>gains</em>, and tag it [I] using the toolbar on the right.<br><br>
          No [I] tag = no third mark confirmed.
        </div>
      </div>

      <div class="success-alert" id="success-check-alert">
        <div class="success-header">✓ FULL TECHNIQUE DETECTED</div>
        <div style="font-family:'Share Tech Mono',monospace;font-size:13px;color:var(--text-primary);line-height:1.7;">
          N.E.I. structure confirmed. You've tagged all three components. Your answer has the structure to achieve full marks.
        </div>
      </div>

      <div class="btn-row" style="justify-content:flex-start;">
        <button class="btn-ghost" onclick="goScene(3)">← REVISE ANSWER</button>
        <button class="btn-primary" id="calibrate-btn" onclick="runCalibration()"><span>⟶ RUN CALIBRATION</span></button>
        <button class="btn-gold" id="complete-btn" style="display:none;" onclick="goScene(5)"><span>⟶ COMPLETE MISSION</span></button>
      </div>
    </div>

    <!-- HIGHLIGHT TOOLBAR -->
    <div class="glass highlight-toolbar" style="position:sticky;top:80px;">
      <div class="toolbar-title">HIGHLIGHTER TOOLBAR</div>

      <button class="hl-btn hl-n" id="hl-n-btn" onclick="setHighlightMode('n')">
        <span class="hl-icon">🔴</span>
        <span>[N] NAME</span>
      </button>
      <button class="hl-btn hl-e" id="hl-e-btn" onclick="setHighlightMode('e')">
        <span class="hl-icon">🟠</span>
        <span>[E] EXPLAIN</span>
      </button>
      <button class="hl-btn hl-i" id="hl-i-btn" onclick="setHighlightMode('i')">
        <span class="hl-icon">🟢</span>
        <span>[I] IMPACT</span>
      </button>

      <div class="hl-instructions">
        1. Select a highlight mode above.<br><br>
        2. Click + drag over text in your answer to tag it.<br><br>
        3. Click "Run Calibration" when done.
      </div>

      <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--panel-border);">
        <div style="font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--text-dim);margin-bottom:12px;letter-spacing:2px;">// CURRENT MODE</div>
        <div id="mode-display" style="font-family:'Orbitron',monospace;font-size:14px;font-weight:700;color:var(--text-dim);">— SELECT —</div>
      </div>
    </div>
  </div>
</section>

<!-- ================================================================ -->
<!-- SCENE 5: SUCCESS STATE                                            -->
<!-- ================================================================ -->
<section class="scene" id="scene-5">
  <div class="success-scene">
    <span class="scene-label">MISSION COMPLETE // CONTENT AREA 6 // LEVEL: SPECIALIST</span>

    <div class="badge-container">
      <div class="badge-3d" title="Insight Architect Badge">
        <div class="badge-inner">
          <div class="badge-icon">🏛️</div>
          <div class="badge-rank">RANK: SPECIALIST</div>
          <div class="badge-name">INSIGHT<br>ARCHITECT</div>
        </div>
      </div>
    </div>

    <div class="glass success-card">
      <div class="success-headline">MISSION ACCOMPLISHED</div>
      <div class="success-sub">You have demonstrated the N.E.I. technique at Specialist level. Impact mark secured.</div>

      <div class="share-card">
        "I just bridged the Data–Knowledge Gap.<br>Level: <strong>Specialist.</strong> N.E.I. Method — Certified."
      </div>

      <div class="nei-trio" style="margin-bottom:32px;">
        <div class="glass nei-card n-card" style="border:1px solid rgba(255,59,59,0.3);">
          <div class="nei-letter">N</div>
          <div class="nei-label">NAME</div>
          <div class="nei-desc" style="color:var(--green);">✓ Tagged</div>
        </div>
        <div class="glass nei-card e-card" style="border:1px solid rgba(255,149,0,0.3);">
          <div class="nei-letter">E</div>
          <div class="nei-label">EXPLAIN</div>
          <div class="nei-desc" style="color:var(--green);">✓ Tagged</div>
        </div>
        <div class="glass nei-card i-card" style="border:1px solid rgba(57,255,20,0.3);">
          <div class="nei-letter">I</div>
          <div class="nei-label">IMPACT</div>
          <div class="nei-desc" style="color:var(--green);">✓ Tagged</div>
        </div>
      </div>

      <div style="display:flex;gap:16px;justify-content:center;flex-wrap:wrap;">
        <button class="mission-report-btn" onclick="exportReport()">
          📄 EXPORT MISSION REPORT
        </button>
        <button class="btn-ghost" onclick="goScene(1)" style="display:flex;align-items:center;gap:6px;">
          ↺ NEW MISSION
        </button>
        <a href="../index.html" style="text-decoration:none;"><button class="btn-ghost">⌂ COMMAND CENTRE</button></a>
        <a href="../6-1-2/index.html" style="text-decoration:none;"><button class="btn-ghost">MODULE 6.1.2 →</button></a>
      </div>
    </div>
  </div>
</section>

<!-- ================================================================ -->
<!-- SCENE 6: TEACHER DASHBOARD                                       -->
<!-- ================================================================ -->
<section class="scene" id="scene-6">
  <div class="dashboard-scene">
    <span class="scene-label">TEACHER TACTICAL OVERLAY // CLASS HEATMAP // CONTENT AREA 6</span>
    <h2 class="scene-headline" style="text-align:left;">Class <span style="color:var(--gold)">NEI Proficiency</span> Map</h2>

    <div class="dashboard-grid">
      <!-- HEATMAP -->
      <div class="glass dash-panel" style="grid-column:1/-1;">
        <div class="dash-title">// STUDENT HEATMAP — NEI PROFICIENCY GRID</div>
        <div class="heatmap-grid" id="heatmap-grid">
          <!-- Populated by JS -->
        </div>
        <div class="heatmap-legend">
          <div class="legend-row"><div class="leg-sq" style="background:rgba(57,255,20,0.3);border:1px solid rgba(57,255,20,0.5);"></div>Full N+E+I</div>
          <div class="legend-row"><div class="leg-sq" style="background:rgba(255,149,0,0.3);border:1px solid rgba(255,149,0,0.5);"></div>Stuck at E (missing I)</div>
          <div class="legend-row"><div class="leg-sq" style="background:rgba(255,59,59,0.3);border:1px solid rgba(255,59,59,0.5);"></div>Only N (missing E+I)</div>
        </div>
      </div>

      <!-- FRICTION ALERTS -->
      <div class="glass dash-panel">
        <div class="dash-title">// FRICTION ALERTS — IMPACT MISS > 50%</div>
        <div class="friction-list">
          <div class="friction-item friction-high">
            <div>
              <div class="friction-topic">Data → Knowledge Chain (6.1.1)</div>
              <div style="font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--text-dim);margin-top:3px;">Missing [I] marker — business outcome</div>
            </div>
            <div class="friction-pct">73%</div>
          </div>
          <div class="friction-item friction-high">
            <div>
              <div class="friction-topic">Data vs. Information (6.1.1)</div>
              <div style="font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--text-dim);margin-top:3px;">Confusing Information + Knowledge tier</div>
            </div>
            <div class="friction-pct">61%</div>
          </div>
          <div class="friction-item friction-med">
            <div>
              <div class="friction-topic">Knowledge → Decision (6.1.1)</div>
              <div style="font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--text-dim);margin-top:3px;">Weak business impact statements</div>
            </div>
            <div class="friction-pct">44%</div>
          </div>
          <div class="friction-item friction-med">
            <div>
              <div class="friction-topic">Value of Data Processing (6.1.1)</div>
              <div style="font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--text-dim);margin-top:3px;">Missing efficiency/profit outcome</div>
            </div>
            <div class="friction-pct">38%</div>
          </div>
        </div>
      </div>

      <!-- ASSIGNMENT ENGINE -->
      <div class="glass dash-panel">
        <div class="dash-title">// ASSIGNMENT ENGINE — PUSH BOOSTER MODULES</div>
        <div class="assign-list">
          <div class="assign-item">
            <div class="assign-module">
              <div>NEI Impact Booster — 6.1.1</div>
              <div style="font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--text-dim);margin-top:3px;">Focus: Writing the [I] business outcome</div>
            </div>
            <button class="assign-btn" onclick="pushModule(this)">⟶ PUSH TO CLASS</button>
          </div>
          <div class="assign-item">
            <div class="assign-module">
              <div>Data Hierarchy Drill — 6.1.1</div>
              <div style="font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--text-dim);margin-top:3px;">Focus: Classification accuracy D→I→K</div>
            </div>
            <button class="assign-btn" onclick="pushModule(this)">⟶ PUSH TO CLASS</button>
          </div>
          <div class="assign-item">
            <div class="assign-module">
              <div>Knowledge vs. Information — 6.1.1</div>
              <div style="font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--text-dim);margin-top:3px;">Focus: Distinguishing tiers 2 and 3</div>
            </div>
            <button class="assign-btn" onclick="pushModule(this)">⟶ PUSH TO CLASS</button>
          </div>
          <div class="assign-item">
            <div class="assign-module">
              <div>3-Mark Answer Blueprint</div>
              <div style="font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--text-dim);margin-top:3px;">Focus: Full N+E+I in one paragraph</div>
            </div>
            <button class="assign-btn" onclick="pushModule(this)">⟶ PUSH TO CLASS</button>
          </div>
        </div>
      </div>
    </div>

    <div class="btn-row">
      <button class="btn-ghost" onclick="goScene(1)">← STUDENT VIEW</button>
      <a href="../index.html" style="text-decoration:none;"><button class="btn-ghost">⌂ COMMAND CENTRE</button></a>
      <a href="../6-1-2/index.html" style="text-decoration:none;"><button class="btn-ghost">MODULE 6.1.2 →</button></a>
    </div>
  </div>
</section>

<!-- ================================================================ -->
<!-- GLITCH TRANSITION OVERLAY                                         -->
<!-- ================================================================ -->
<div id="glitch-overlay" aria-hidden="true">
  <div class="glitch-scanlines"></div>
  <div class="glitch-block g1"></div>
  <div class="glitch-block g2"></div>
  <div class="glitch-block g3"></div>
  <div class="glitch-text" id="glitch-text">SIGNAL REROUTING...</div>
  <div class="glitch-subtext">ACCESSING MISSION TERMINAL</div>
  <div class="glitch-coords">LAT:51.5074 // LON:0.1278 // LOCK CONFIRMED</div>
</div>
<div id="lock-nudge">⚡ COMPLETE THE DATA SORTER FIRST</div>
<div class="nav-tabs" id="floating-nav">
  <button class="nav-tab-btn active" onclick="goScene(1)" id="navbtn-1">01 BRIEF</button>
  <button class="nav-tab-btn" onclick="goScene(2)" id="navbtn-2">02 LESSON</button>
  <button class="nav-tab-btn locked" onclick="tryLockedTab(this)" id="navbtn-3" disabled>🔒 03 MISSION</button>
  <button class="nav-tab-btn locked" onclick="tryLockedTab(this)" id="navbtn-4" disabled>🔒 04 CALIBRATE</button>
  <button class="nav-tab-btn locked" onclick="tryLockedTab(this)" id="navbtn-5" disabled>🔒 05 BADGE</button>
</div>

<!-- ================================================================ -->
<!-- JAVASCRIPT                                                        -->
<!-- ================================================================ -->
<script>
/* ──────────────────────────────
   GATEKEEPER STATE
────────────────────────────── */
let sorterComplete = false;
let nudgeTimer = null;

// Disabled buttons don't fire click — use mousedown delegation for the nudge feedback
document.getElementById('floating-nav').addEventListener('mousedown', e => {
  const btn = e.target.closest('.nav-tab-btn.locked');
  if (!btn) return;
  btn.classList.remove('rejecting');
  void btn.offsetWidth;
  btn.classList.add('rejecting');
  btn.addEventListener('animationend', () => btn.classList.remove('rejecting'), { once: true });
  const nudge = document.getElementById('lock-nudge');
  nudge.classList.add('show');
  clearTimeout(nudgeTimer);
  nudgeTimer = setTimeout(() => nudge.classList.remove('show'), 2200);
});

function tryLockedTab(btn) {
  // Kept as no-op fallback — real handler is the mousedown delegation above
}

function unlockTabs() {
  if (sorterComplete) return; // idempotent — only unlock once
  sorterComplete = true;
  const config = [
    { id: 'navbtn-3', label: '03 MISSION',   scene: 3 },
    { id: 'navbtn-5', label: '05 BADGE',     scene: 5 },
  ];
  config.forEach(({ id, label, scene }) => {
    const btn = document.getElementById(id);
    btn.classList.remove('locked');
    btn.disabled = false;
    btn.textContent = label;
    btn.setAttribute('onclick', `goScene(${scene})`);
  });
}

/* ──────────────────────────────
   GLITCH TRANSITION
────────────────────────────── */
let glitchNavTimer = null;
let glitchCleanTimer = null;

function glitchToMission() {
  const overlay = document.getElementById('glitch-overlay');

  // Unlock tabs at the moment the glitch fires
  unlockTabs();

  // Reset animation by removing and re-adding class
  overlay.classList.remove('active');
  void overlay.offsetWidth; // force reflow
  overlay.classList.add('active');

  // Navigate to scene 3 at the peak of the glitch — store ref so it can be cancelled
  glitchNavTimer = setTimeout(() => {
    glitchNavTimer = null;
    goScene(3);
  }, 900);

  // Clean up overlay after full animation completes — store ref so it can be cancelled
  glitchCleanTimer = setTimeout(() => {
    glitchCleanTimer = null;
    overlay.classList.remove('active');
  }, 1900);
}

/* ──────────────────────────────
   SCENE NAVIGATION
────────────────────────────── */
let currentScene = 1;
const TOTAL_SCENES = 5;

function goScene(n) {
  // Cancel ALL in-flight glitch timers — prevents any delayed navigation overriding a manual scene change
  if (glitchTriggerTimer) { clearTimeout(glitchTriggerTimer); glitchTriggerTimer = null; }
  if (glitchNavTimer)     { clearTimeout(glitchNavTimer);     glitchNavTimer     = null; }
  if (glitchCleanTimer)   { clearTimeout(glitchCleanTimer);   glitchCleanTimer   = null; }
  document.getElementById('glitch-overlay').classList.remove('active');

  document.querySelectorAll('.scene').forEach(s => s.classList.remove('active'));
  document.getElementById('scene-' + n).classList.add('active');

  // Update dots
  document.querySelectorAll('.step-dot').forEach((d, i) => {
    d.classList.remove('active', 'done');
    if (i + 1 < n) d.classList.add('done');
    else if (i + 1 === n) d.classList.add('active');
  });

  // Update nav tabs — explicit by ID to avoid any closure/handler race
  [1, 2, 3, 4, 5].forEach(i => {
    const btn = document.getElementById('navbtn-' + i);
    if (btn) btn.classList.remove('active');
  });
  const activeBtn = document.getElementById('navbtn-' + n);
  if (activeBtn && !activeBtn.classList.contains('locked')) {
    activeBtn.classList.add('active');
  }

  // Show/hide floating nav (hide on teacher view)
  document.getElementById('floating-nav').style.display = n === 6 ? 'none' : 'flex';

  currentScene = n;
  window.scrollTo(0, 0);

  if (n === 3) {
    // Polling fallback — catches browsers where oninput/onkeyup don't fire reliably
    clearInterval(window._textPoll);
    window._textPoll = setInterval(() => {
      const ta = document.getElementById('student-answer');
      if (!ta) return;
      const v = ta.value;
      if (v !== (window._lastPolledValue || '')) {
        window._lastPolledValue = v;
        updateHUD(v);
        updateWordCount(v);
      }
    }, 400);
  } else {
    clearInterval(window._textPoll);
  }
  if (n === 4) prepCalibration();
  if (n === 6) buildHeatmap();
}

/* ──────────────────────────────
   SCENE 2: DRAG & DROP
────────────────────────────── */
const dropAnswers = {};

document.addEventListener('DOMContentLoaded', () => {
  const chips = document.querySelectorAll('.data-chip');
  const zones = document.querySelectorAll('.drop-zone');

  // ── SHARED DROP LOGIC ──────────────────────────────────────────────
  function dropChipOnZone(chip, zone) {
    const target = zone.dataset.target;
    const answerEl = document.getElementById('drop-' + target);

    // Remove chip from any previous zone
    document.querySelectorAll('.dz-answer').forEach(el => {
      if (el.dataset.chipId === chip.id) {
        el.textContent = 'Drop here...';
        el.classList.add('dz-empty');
        delete el.dataset.chipId;
        delete dropAnswers[el.id.replace('drop-', '')];
      }
    });

    answerEl.innerHTML = chip.innerHTML;
    answerEl.classList.remove('dz-empty');
    answerEl.dataset.chipId = chip.id;
    dropAnswers[target] = chip.dataset.answer;
  }

  function clearZoneHighlights() {
    zones.forEach(z => z.classList.remove('over'));
  }

  // ── MOUSE / DESKTOP DRAG ───────────────────────────────────────────
  chips.forEach(chip => {
    chip.setAttribute('draggable', 'true');
    chip.addEventListener('dragstart', e => {
      e.dataTransfer.setData('chipId', chip.id);
      chip.classList.add('dragging');
    });
    chip.addEventListener('dragend', () => chip.classList.remove('dragging'));
  });

  zones.forEach(zone => {
    zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('over'); });
    zone.addEventListener('dragleave', () => zone.classList.remove('over'));
    zone.addEventListener('drop', e => {
      e.preventDefault();
      clearZoneHighlights();
      const chip = document.getElementById(e.dataTransfer.getData('chipId'));
      if (chip) dropChipOnZone(chip, zone);
    });
  });

  // ── TOUCH / MOBILE DRAG ────────────────────────────────────────────
  let touchChip = null;
  let touchClone = null;

  chips.forEach(chip => {
    chip.addEventListener('touchstart', e => {
      touchChip = chip;
      chip.classList.add('dragging');

      // Create a floating visual clone that follows the finger
      touchClone = chip.cloneNode(true);
      touchClone.style.cssText = `
        position: fixed; pointer-events: none; z-index: 9999;
        opacity: 0.85; transform: scale(1.05);
        transition: none; margin: 0;
        width: ${chip.offsetWidth}px;
      `;
      document.body.appendChild(touchClone);
      moveTouchClone(e.touches[0]);
    }, { passive: true });

    chip.addEventListener('touchmove', e => {
      e.preventDefault();
      if (!touchClone) return;
      moveTouchClone(e.touches[0]);

      // Highlight the zone under the finger
      clearZoneHighlights();
      const el = document.elementFromPoint(e.touches[0].clientX, e.touches[0].clientY);
      const zone = el && el.closest('.drop-zone');
      if (zone) zone.classList.add('over');
    }, { passive: false });

    chip.addEventListener('touchend', e => {
      if (!touchChip || !touchClone) return;
      const touch = e.changedTouches[0];
      clearZoneHighlights();
      touchClone.remove();
      touchClone = null;
      touchChip.classList.remove('dragging');

      const el = document.elementFromPoint(touch.clientX, touch.clientY);
      const zone = el && el.closest('.drop-zone');
      if (zone) dropChipOnZone(touchChip, zone);
      touchChip = null;
    });
  });

  function moveTouchClone(touch) {
    if (!touchClone) return;
    touchClone.style.left = (touch.clientX - touchClone.offsetWidth / 2) + 'px';
    touchClone.style.top  = (touch.clientY - 24) + 'px';
  }
});

let glitchTriggerTimer = null;

function checkDragDrop() {
  const fb = document.getElementById('dd-feedback');
  const zones = document.querySelectorAll('.drop-zone');
  let correct = 0;

  zones.forEach(zone => {
    const target = zone.dataset.target;
    const chipId = document.getElementById('drop-' + target).dataset.chipId;
    zone.classList.remove('correct', 'incorrect');
    if (!chipId) return;
    const chip = document.getElementById(chipId);
    if (chip && chip.dataset.answer === target) {
      zone.classList.add('correct');
      correct++;
    } else {
      zone.classList.add('incorrect');
    }
  });

  fb.classList.add('show');
  if (correct === 3) {
    fb.className = 'dd-feedback show success';
    fb.innerHTML = '✓ SIGNAL CLASSIFIED — Correct. <span style="color:var(--gold);font-family:monospace;">51.5074, 0.1278</span> is raw Data, "Oxford Circus, London" is Information, "Turn left in 200m" is Knowledge. You understand the chain. Mission Terminal unlocking...';
    glitchTriggerTimer = setTimeout(() => { glitchTriggerTimer = null; glitchToMission(); }, 600);
  } else {
    fb.className = 'dd-feedback show error';
    fb.innerHTML = `✗ ${correct}/3 CORRECT — Re-examine the flagged zones. Ask yourself: does this item tell the driver <em>what to do</em> (Knowledge), <em>where they are</em> (Information), or is it just a <em>raw number</em> (Data)?`;
  }
}

/* ──────────────────────────────
   SCENE 3: HUD LIVE FEEDBACK
────────────────────────────── */
const N_KEYWORDS = ['coordinates', 'lat', 'lon', 'string', 'numbers', 'gps', 'data', 'raw', 'digits', 'values'];
const E_KEYWORDS = ['mapping', 'converts', 'satellite', 'street', 'location', 'database', 'processes', 'calculates', 'translates', 'cross-references', 'matches', 'algorithm', 'software'];
const I_KEYWORDS = ['route', 'driver', 'directions', 'fastest', 'delivery', 'arrives', 'efficient', 'on time', 'reduces', 'saves', 'increas', 'customer', 'satisfaction', 'profit', 'revenue', 'cost'];

function hasKeyword(text, keywords) {
  const lower = text.toLowerCase();
  return keywords.some(k => lower.includes(k));
}

function countWords(text) { return text.trim() === '' ? 0 : text.trim().split(/\s+/).length; }

/* ── ACE v2: PROGRESS BAR + IMPACT PULSE + IDLE POKE ── */

const IDLE_DELAY  = 10000;
const IDLE_PROMPT = 'Specialist — you\'ve identified the data. But so what?\nHow does knowing those coordinates actually help the driver arrive on time?';
let idleTimer = null;

function updateWordCount(text) {
  const count = countWords(text);
  const el    = document.getElementById('word-count-display');
  const fill  = document.getElementById('energy-bar-fill');
  if (!el || !fill) return;

  const pct = Math.min(100, Math.round((count / 60) * 100));
  fill.style.width = pct + '%';

  // Remove all state classes
  fill.classList.remove('eb-red', 'eb-amber', 'eb-green');

  if (count === 0) {
    el.textContent = '0 words — aim for 60+';
    el.style.color = '';
  } else if (count < 40) {
    fill.classList.add('eb-red');
    el.textContent = count + ' words — keep going';
    el.style.color = 'var(--red)';
  } else if (count < 60) {
    fill.classList.add('eb-amber');
    el.textContent = count + ' words — almost there';
    el.style.color = 'var(--amber)';
  } else {
    fill.classList.add('eb-green');
    el.textContent = count + ' words ✓';
    el.style.color = 'var(--green)';
  }

  // Trigger HUD glitch when impact keyword + 60 words
  if (hasKeyword(text, I_KEYWORDS) && count >= 60) triggerHUDGlitch();

  // Impact panel pulse — glow [I] softly at 50+ words if not yet detected
  const hudI = document.getElementById('hud-i');
  if (hudI) {
    if (count >= 50 && !hudI.classList.contains('active-i')) {
      hudI.style.animation = 'impact-pulse 1.8s ease infinite';
    } else {
      hudI.style.animation = '';
    }
  }
}

function resetIdleTimer(text) {
  clearTimeout(idleTimer);
  if (countWords(text) >= 60) return; // already enough — no poke needed
  idleTimer = setTimeout(() => {
    const fb = document.getElementById('axiom-feedback');
    if (!fb) return;
    // Only fire if no Tier 1/2 message currently showing AND under 60 words
    if (fb.style.display !== 'none') return;
    fb.style.display = 'block';
    fb.style.borderColor = 'rgba(57,255,20,0.4)';
    fb.style.background  = 'rgba(57,255,20,0.05)';
    fb.style.color       = 'var(--green)';
    fb.textContent       = 'AXIOM-7 // ' + IDLE_PROMPT;
  }, IDLE_DELAY);
}

/* ── ACE v2: REBOOT ANIMATION ── */
function triggerReboot() {
  const overlay = document.getElementById('reboot-overlay');
  const line1   = document.getElementById('rb-line1');
  const line2   = document.getElementById('rb-line2');
  const bar     = document.getElementById('rb-bar');
  overlay.style.display = 'flex';
  setTimeout(() => { line1.style.opacity = '1'; }, 200);
  setTimeout(() => { line2.style.opacity = '1'; }, 700);
  setTimeout(() => {
    bar.style.transition = 'width 1.2s ease-out';
    bar.style.width = '100%';
  }, 1000);
  setTimeout(() => {
    overlay.style.display = 'none';
    line1.style.opacity = '0';
    line2.style.opacity = '0';
    bar.style.transition = 'none';
    bar.style.width = '0%';
    goScene(4);
  }, 2400);

  // Fire API call in parallel — result will be ready by the time Scene 4 loads
  const answer = document.getElementById('student-answer').value.trim();
  window._neiApiPromise = analyzeWithNEIChecker(
    answer,
    'Focus on GPS logistics, coordinate data, data vs information vs knowledge hierarchy, and delivery outcomes'
  );
}

/* ── NEI CHECKER API ── */
async function analyzeWithNEIChecker(studentText, customPrompt = '') {
  const API_URL = 'https://neichecker.toolsforteaching.co.uk/nei-checker.php';
  const response = await fetch(API_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ studentText, prompt: customPrompt })
  });
  if (!response.ok) throw new Error(`HTTP ${response.status}`);
  const data = await response.json();
  if (!data.success) throw new Error(data.error || 'Analysis failed');
  return data;
}

function renderAxiomDeconstruction(result) {
  const panel = document.getElementById('axiom-deconstruction');
  const content = document.getElementById('axd-content');
  panel.style.display = 'block';

  const { hasName, hasExplain, hasImpact } = result.analysis;

  // Build colour-coded text from details arrays if highlightedHtml isn't usable
  // Use the API's highlightedHtml but restyle spans to match platform
  let html = result.highlightedHtml || result.originalText || '';
  // Remap any inline-styled spans to our CSS classes
  html = html.replace(/style=['"][^'"]*color\s*:\s*#ff6b6b[^'"]*['"]/gi, 'class="nei-n"');
  html = html.replace(/style=['"][^'"]*color\s*:\s*#ffa500[^'"]*['"]/gi, 'class="nei-e"');
  html = html.replace(/style=['"][^'"]*color\s*:\s*#51cf66[^'"]*['"]/gi, 'class="nei-i"');

  content.innerHTML = `
    <div class="axd-badges">
      <div class="axd-badge ${hasName    ? 'hit' : 'miss'}">[N] NAME</div>
      <div class="axd-badge ${hasExplain ? 'hit' : 'miss'}">[E] EXPLAIN</div>
      <div class="axd-badge ${hasImpact  ? 'hit' : 'miss'}">[I] IMPACT</div>
    </div>
    ${!hasImpact ? `<div style="font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--red);letter-spacing:1px;margin-bottom:12px;padding:10px 12px;border:1px solid rgba(255,59,59,0.25);border-radius:6px;background:rgba(255,59,59,0.05);">⚠ AXIOM-7 // NO IMPACT COMPONENT DETECTED — THIRD MARK AT RISK</div>` : ''}
    <div class="axd-text-wrap">${html}</div>
    <div class="axd-legend">
      <div class="axd-legend-item"><div class="axd-dot" style="background:rgba(255,59,59,0.5);"></div>[N] NAME</div>
      <div class="axd-legend-item"><div class="axd-dot" style="background:rgba(255,149,0,0.5);"></div>[E] EXPLAIN</div>
      <div class="axd-legend-item"><div class="axd-dot" style="background:rgba(57,255,20,0.4);"></div>[I] IMPACT</div>
    </div>
  `;
}

function triggerHUDGlitch() {
  const hudI = document.getElementById('hud-i');
  if (!hudI || hudI.dataset.glitched) return;
  hudI.dataset.glitched = '1';
  hudI.style.animation = 'hud-glitch 0.5s ease';
  setTimeout(() => { hudI.style.animation = ''; delete hudI.dataset.glitched; }, 600);
}

function updateHUD(text) {
  const nEl = document.getElementById('hud-n');
  const eEl = document.getElementById('hud-e');
  const iEl = document.getElementById('hud-i');
  const nCheck = document.getElementById('hud-n-check');
  const eCheck = document.getElementById('hud-e-check');
  const iCheck = document.getElementById('hud-i-check');

  if (hasKeyword(text, N_KEYWORDS)) {
    nEl.classList.add('active-n');
    nCheck.className = 'hud-check ok'; nCheck.textContent = '✓ DETECTED';
  } else {
    nEl.classList.remove('active-n');
    nCheck.className = text.length > 10 ? 'hud-check warn' : 'hud-check'; 
    nCheck.textContent = text.length > 10 ? '○ NAME IT' : '';
  }

  if (hasKeyword(text, E_KEYWORDS)) {
    eEl.classList.add('active-e');
    eCheck.className = 'hud-check ok'; eCheck.textContent = '✓ DETECTED';
  } else {
    eEl.classList.remove('active-e');
    eCheck.className = text.length > 30 ? 'hud-check warn' : 'hud-check';
    eCheck.textContent = text.length > 30 ? '○ EXPLAIN IT' : '';
  }

  if (hasKeyword(text, I_KEYWORDS)) {
    iEl.classList.add('active-i');
    iCheck.className = 'hud-check ok'; iCheck.textContent = '✓ DETECTED';
  } else {
    iEl.classList.remove('active-i');
    iCheck.className = text.length > 60 ? 'hud-check warn' : 'hud-check';
    iCheck.textContent = text.length > 60 ? '○ IMPACT?' : '';
  }
}

const TIER1_MSG = `⚠ AXIOM-7 // INSUFFICIENT SIGNAL DETECTED\n\nYour response is too brief. An examiner needs to see three things: the name of what the data is, how the system processes it, and what instruction or outcome it produces.\n\nExpand your answer — aim for at least 60 words. The third mark is always in your last sentence.`;

const TIER2_TEMPLATE = `Try this structure:\n\n[N] The GPS system uses raw data — specifically [NAME THE DATA TYPE]...\n[E] The software [EXPLAIN HOW IT PROCESSES OR CONVERTS THE DATA]...\n[I] This means the driver can [STATE THE OUTCOME — faster route, on-time delivery, reduced costs]...`;

let submitAttempts = 0;
let _tierWarningShown = false;

function submitAnswer() {
  const answer = document.getElementById('student-answer').value.trim();
  if (!answer) { alert('Please write your answer before submitting.'); return; }
  const words = countWords(answer);
  const fb = document.getElementById('axiom-feedback');
  submitAttempts++;

  if (words < 60) {
    fb.style.display = 'block';
    if (submitAttempts === 1) {
      fb.style.borderColor = 'var(--amber)';
      fb.style.background = 'rgba(255,149,0,0.06)';
      fb.style.color = 'var(--amber)';
      fb.textContent = TIER1_MSG;
    } else {
      fb.style.borderColor = 'var(--red)';
      fb.style.background = 'rgba(255,59,59,0.06)';
      fb.style.color = 'var(--text-primary)';
      fb.textContent = TIER2_TEMPLATE;
      document.getElementById('student-answer').placeholder = '[N] The GPS system uses raw coordinate data...\n[E] The software processes this by converting it into...\n[I] This means the driver can...';
    }
    _tierWarningShown = true;
    const btn = document.querySelector('#scene-3 .btn-primary');
    if (btn) { btn.style.animation = 'tab-reject 0.4s ease'; setTimeout(() => { btn.style.animation = ''; }, 450); }
    return;
  }

  fb.style.display = 'none';
  const btn4 = document.getElementById('navbtn-4');
  btn4.classList.remove('locked');
  btn4.disabled = false;
  btn4.textContent = '04 CALIBRATE';
  btn4.setAttribute('onclick', 'goScene(4)');
  triggerReboot();
}

/* ──────────────────────────────
   SCENE 4: SELF-CALIBRATION
────────────────────────────── */
let highlightMode = null;
let taggedN = false, taggedE = false, taggedI = false;

function setHighlightMode(mode) {
  highlightMode = mode;
  document.querySelectorAll('.hl-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('hl-' + mode + '-btn').classList.add('active');
  const labels = { n: '[N] NAME — Red', e: '[E] EXPLAIN — Amber', i: '[I] IMPACT — Green' };
  const colors = { n: 'var(--red)', e: 'var(--amber)', i: 'var(--green)' };
  document.getElementById('mode-display').textContent = labels[mode];
  document.getElementById('mode-display').style.color = colors[mode];
}

function prepCalibration() {
  const answer = document.getElementById('student-answer').value.trim();
  const disp = document.getElementById('student-display');
  disp.innerHTML = answer || '<em style="color:var(--text-dim);">No answer submitted yet. Go back and write your response.</em>';

  taggedN = false; taggedE = false; taggedI = false;
  document.getElementById('vuln-alert').classList.remove('show');
  document.getElementById('success-check-alert').classList.remove('show');
  document.getElementById('nei-tally-display').style.display = 'none';
  document.getElementById('complete-btn').style.display = 'none';
  document.getElementById('calibrate-btn').style.display = 'inline-flex';
  highlightMode = null;
  document.querySelectorAll('.hl-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('mode-display').textContent = '— SELECT —';
  document.getElementById('mode-display').style.color = 'var(--text-dim)';

  // Resolve AXIOM-7 API result
  const panel = document.getElementById('axiom-deconstruction');
  const content = document.getElementById('axd-content');
  panel.style.display = 'block';
  content.innerHTML = '<div class="axd-loading"><div class="axd-spinner"></div>SCANNING RESPONSE...</div>';

  if (window._neiApiPromise) {
    window._neiApiPromise
      .then(result => renderAxiomDeconstruction(result))
      .catch(() => {
        content.innerHTML = '<div class="axd-error">⚠ AXIOM-7 OFFLINE — Complete your self-tagging above.</div>';
      });
  } else {
    // No promise yet (e.g. navigated directly) — fire now
    if (answer) {
      analyzeWithNEIChecker(answer, 'Focus on GPS logistics, coordinate data, data vs information vs knowledge hierarchy, and delivery outcomes')
        .then(result => renderAxiomDeconstruction(result))
        .catch(() => {
          content.innerHTML = '<div class="axd-error">⚠ AXIOM-7 OFFLINE — Complete your self-tagging above.</div>';
        });
    } else {
      panel.style.display = 'none';
    }
  }
}

// Text selection highlighting
document.addEventListener('mouseup', () => {
  if (!highlightMode) return;
  const disp = document.getElementById('student-display');
  const sel = window.getSelection();
  if (!sel || sel.rangeCount === 0 || sel.isCollapsed) return;

  const range = sel.getRangeAt(0);
  // Only operate within the student display
  if (!disp.contains(range.commonAncestorContainer)) return;

  const span = document.createElement('span');
  const cls = { n: 'hl-n-tag', e: 'hl-e-tag', i: 'hl-i-tag' };
  span.className = cls[highlightMode];

  try {
    range.surroundContents(span);
    if (highlightMode === 'n') taggedN = true;
    if (highlightMode === 'e') taggedE = true;
    if (highlightMode === 'i') taggedI = true;
    sel.removeAllRanges();
  } catch(e) {
    // Partial selection across elements — skip
    sel.removeAllRanges();
  }
});

function runCalibration() {
  const tally = document.getElementById('nei-tally');
  const tallyWrap = document.getElementById('nei-tally-display');
  const vuln = document.getElementById('vuln-alert');
  const success = document.getElementById('success-check-alert');
  const calBtn = document.getElementById('calibrate-btn');
  const completeBtn = document.getElementById('complete-btn');

  tallyWrap.style.display = 'block';
  tallyWrap.className = 'glass';
  tallyWrap.style.padding = '0';

  const chips = [];
  if (taggedN) chips.push('<div class="tally-chip tally-n">✓ [N] Name Tagged</div>');
  else chips.push('<div class="tally-chip" style="border-color:rgba(255,59,59,0.3);color:var(--text-dim);">○ [N] Not Tagged</div>');

  if (taggedE) chips.push('<div class="tally-chip tally-e">✓ [E] Explain Tagged</div>');
  else chips.push('<div class="tally-chip" style="border-color:rgba(255,149,0,0.3);color:var(--text-dim);">○ [E] Not Tagged</div>');

  if (taggedI) chips.push('<div class="tally-chip tally-i">✓ [I] Impact Tagged</div>');
  else chips.push('<div class="tally-chip" style="border-color:rgba(57,255,20,0.2);color:var(--text-dim);">○ [I] Not Tagged</div>');

  tally.innerHTML = chips.join('');

  if (!taggedI) {
    vuln.classList.add('show');
    success.classList.remove('show');
    completeBtn.style.display = 'none';
    // Track that vulnerability was triggered (for Signal Recovered badge)
    window._msmVulnTriggered = true;
  } else {
    vuln.classList.remove('show');
    success.classList.add('show');
    calBtn.style.display = 'none';
    completeBtn.style.display = 'inline-flex';
    // Award badges based on calibration outcome
    msmCheckBadges_611();
  }
}

/* ──────────────────────────────
   SCENE 6: TEACHER DASHBOARD
────────────────────────────── */
const students = [
  { name: 'A.Patel', level: 'all-green', score: 'N+E+I' },
  { name: 'S.Chen', level: 'stuck-e', score: 'N+E' },
  { name: 'M.Okoro', level: 'all-green', score: 'N+E+I' },
  { name: 'J.Harri', level: 'stuck-n', score: 'N' },
  { name: 'F.Khan', level: 'stuck-e', score: 'N+E' },
  { name: 'T.Wilson', level: 'all-green', score: 'N+E+I' },
  { name: 'L.Brown', level: 'stuck-e', score: 'N+E' },
  { name: 'R.Ahmed', level: 'stuck-n', score: 'N' },
  { name: 'C.Lee', level: 'all-green', score: 'N+E+I' },
  { name: 'P.Singh', level: 'stuck-e', score: 'N+E' },
  { name: 'D.Nkosi', level: 'all-green', score: 'N+E+I' },
  { name: 'H.White', level: 'stuck-e', score: 'N+E' },
  { name: 'Y.Costa', level: 'stuck-n', score: 'N' },
  { name: 'E.James', level: 'all-green', score: 'N+E+I' },
  { name: 'B.Osei', level: 'stuck-e', score: 'N+E' },
];

function buildHeatmap() {
  const grid = document.getElementById('heatmap-grid');
  grid.innerHTML = '';
  students.forEach(s => {
    const cell = document.createElement('div');
    cell.className = 'hm-cell ' + s.level;
    cell.innerHTML = `<div class="hm-score">${s.score}</div><div class="hm-name">${s.name}</div>`;
    cell.title = s.name + ': ' + s.score;
    grid.appendChild(cell);
  });
}

function pushModule(btn) {
  btn.textContent = '✓ PUSHED';
  btn.classList.add('pushed');
  setTimeout(() => {
    btn.textContent = '⟶ PUSH TO CLASS';
    btn.classList.remove('pushed');
  }, 2500);
}

/* ──────────────────────────────
   EXPORT MISSION REPORT
────────────────────────────── */
function exportReport() {
  const answer = document.getElementById('student-answer').value || '(No answer recorded)';
  const date = new Date().toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });
  const html = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Mission Report — Mark Scheme Method®</title>
  <style>body{font-family:Georgia,serif;max-width:700px;margin:40px auto;padding:40px;background:#f8f9fa;color:#1a1a2e;}
  h1{color:#0D1117;font-size:28px;} h2{color:#333;font-size:16px;border-bottom:2px solid #FFD700;padding-bottom:8px;}
  .badge{display:inline-block;background:linear-gradient(135deg,#FFD700,#39FF14);color:#0D1117;font-weight:bold;padding:8px 20px;border-radius:20px;font-size:13px;}
  .answer-box{background:#fff;border:1px solid #ddd;padding:20px;border-radius:8px;line-height:1.8;}
  .n{background:#ffdddd;border-radius:3px;padding:0 4px;} .e{background:#ffe8c0;border-radius:3px;padding:0 4px;} .i{background:#d4ffd4;border-radius:3px;padding:0 4px;}
  .meta{color:#666;font-size:13px;} footer{margin-top:40px;font-size:11px;color:#999;text-align:center;}
  </style></head><body>
  <h1>📋 Mission Report</h1>
  <div class="badge">INSIGHT ARCHITECT — SPECIALIST</div>
  <p class="meta"><strong>Date:</strong> ${date} &nbsp;&nbsp; <strong>Content Area:</strong> 6.1.1 &nbsp;&nbsp; <strong>Status:</strong> COMPLETE</p>
  <h2>Exam Question</h2>
  <p style="background:#f0f0f0;padding:16px;border-radius:8px;line-height:1.7;margin-bottom:16px;">A logistics company receives a raw data string <span style="color:#cc8800;font-family:monospace;font-weight:bold;">'LAT:51.5074, LON:0.1278'</span>. Explain the process of turning this data into knowledge for the driver. <strong>(3 Marks)</strong></p>
  <h2>Model Answer (Colour-Coded N.E.I.)</h2>
  <div class="answer-box">
    <span class="n">[N] <strong>Data:</strong> The raw coordinate string <span style="color:#cc8800;font-family:monospace;">'51.5074, 0.1278'</span> acts as raw data because it lacks meaning or context to the driver.</span><br><br>
    <span class="e">[E] <strong>Information:</strong> GPS software processes these coordinates by cross-referencing a road network database to provide the context that the vehicle is currently at Oxford Circus, London.</span><br><br>
    <span class="i">[I] <strong>Knowledge:</strong> By applying traffic logic and routing algorithms to this information, the system provides actionable knowledge — such as "Turn left in 200m" — allowing the driver to complete the delivery on time.</span>
  </div>
  <h2>Your Answer</h2>
  <div class="answer-box">${answer.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</div>
  <h2>NEI Proficiency</h2>
  <p>N (Name): ${taggedN ? '✅ Tagged' : '❌ Not tagged'} &nbsp; E (Explain): ${taggedE ? '✅ Tagged' : '❌ Not tagged'} &nbsp; I (Impact): ${taggedI ? '✅ Tagged' : '❌ Not tagged'}</p>
  <h2>Technique Score</h2>
  <p><strong>${taggedI ? '3/3 — Full N.E.I. Technique Applied' : taggedE ? '2/3 — N+E Only (Impact Missing)' : '1/3 — Name Only'}</strong></p>
  <footer>The Mark Scheme Method® — Specialist Training Platform · Content Area 6: Data</footer>
  </body></html>`;
  const blob = new Blob([html], { type: 'text/html' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'MSM-Mission-Report.html';
  a.click();
}

// Initial build
buildHeatmap();

/* ── BADGE SYSTEM (Module 6.1.1) ── */
const MSM_LS = 'msm_badges';

function msmEarnBadge(key) {
  try {
    const b = JSON.parse(localStorage.getItem(MSM_LS)) || {};
    if (b[key]) return false;
    b[key] = { earned: true, ts: Date.now() };
    localStorage.setItem(MSM_LS, JSON.stringify(b));
    return true;
  } catch(e) { return false; }
}

function msmCheckBadges_611() {
  // Module completion
  msmEarnBadge('raw_signal');

  // First Strike — no Tier 1 or 2 prompts shown (submitted 60+ words on first valid attempt)
  if (!_tierWarningShown) {
    msmEarnBadge('first_strike');
  }

  // Signal Recovered — vulnerability was triggered and then student fixed it
  if (window._msmVulnTriggered) {
    msmEarnBadge('signal_recovered');
    window._msmVulnTriggered = false;
  }

  // Impact Specialist — all three HUD panels were lit at some point this session
  if (window._msmAllHUDActive) {
    msmEarnBadge('impact_specialist');
  }

  // Resilient Analyst — submitted 3+ times
  if (submitAttempts >= 3) {
    msmEarnBadge('resilient_analyst');
  }

  // Precision Writer — 60-70 words with all HUD panels
  if (window._msmPrecisionWriter) {
    msmEarnBadge('precision_writer');
  }

  // Full Clearance — both modules complete
  try {
    const b = JSON.parse(localStorage.getItem(MSM_LS)) || {};
    if (b['raw_signal'] && b['market_intelligence'] && b['signal_mapper']) msmEarnBadge('full_clearance');
    // Method Mastery — impact specialist in both modules
    if (b['impact_specialist'] && window._msmImpactSpecialist612) msmEarnBadge('method_mastery');
  } catch(e) {}
}

// Track all-HUD active state in updateHUD
const _origUpdateHUD_611 = updateHUD;
function updateHUD(text) {
  _origUpdateHUD_611(text);
  const nA = hasKeyword(text, N_KEYWORDS);
  const eA = hasKeyword(text, E_KEYWORDS);
  const iA = hasKeyword(text, I_KEYWORDS);
  if (nA && eA && iA) window._msmAllHUDActive = true;
  // Precision Writer: 60-70 words + all panels
  const wc = countWords(text);
  if (nA && eA && iA && wc >= 60 && wc <= 70) window._msmPrecisionWriter = true;
}
</script>

<!-- ── ACE v2: REBOOT OVERLAY ── -->
<div id="reboot-overlay">
  <div class="rb-line1" id="rb-line1">CRITICAL INSIGHT DETECTED</div>
  <div class="rb-line2" id="rb-line2">CALIBRATING SPECIALIST GRADE</div>
  <div class="rb-bar-wrap"><div class="rb-bar" id="rb-bar"></div></div>
</div>

<!-- ================================================================ -->
<!-- KNOWLEDGE CHECK ENGINE                                            -->
<!-- ================================================================ -->
<script>
/* ─────────────────────────────────────────────────────────────────
   KNOWLEDGE CHECK ENGINE — renders entire body HTML fresh each call
───────────────────────────────────────────────────────────────────*/
const KC_QUESTIONS = [
  {
    q: 'A GPS sensor records the value <code style="color:var(--gold);font-family:monospace;">51.5074, -0.1278</code>. What type of value is this?',
    options: [
      'Information — it tells us where the driver is',
      'Knowledge — the system can act on it immediately',
      'Data — raw coordinates with no context or meaning yet',
      'A report generated by the GPS software',
    ],
    correct: 2,
    remedy: {
      label: 'Q1 — Data, Information or Knowledge?',
      text: '<strong>Data</strong> is raw, unprocessed facts — numbers or values with no context attached. The coordinates <em>51.5074, -0.1278</em> mean nothing on their own until software processes them into a readable location. That processed result (e.g. "Oxford Circus, London") becomes <strong>Information</strong>.'
    }
  },
  {
    q: 'The GPS app displays <code style="color:var(--gold);font-family:monospace;">"Oxford Circus, London"</code> on screen. Which term best describes this output?',
    options: [
      'Data — it is still just a number in the system',
      'Information — data has been processed and given context',
      'Knowledge — the driver can now make a decision',
      'A database record stored server-side',
    ],
    correct: 1,
    remedy: {
      label: 'Q2 — When does data become information?',
      text: '<strong>Information</strong> is data that has been processed, organised, or given context so it carries meaning. The raw coordinates become information when the software converts them into a human-readable location. The key word is <em>context</em> — information answers "what does this mean?"'
    }
  },
  {
    q: 'Based on the location, the app announces: <code style="color:var(--gold);font-family:monospace;">"Turn left in 200m to reach your destination 4 minutes faster."</code> What is this?',
    options: [
      'Data — the system is recording a new value',
      'Information — it describes where the driver is',
      'Knowledge — actionable instruction derived from processed information',
      'A sensor reading from the vehicle',
    ],
    correct: 2,
    remedy: {
      label: 'Q3 — What makes something Knowledge?',
      text: '<strong>Knowledge</strong> is information that has been analysed and turned into an <em>actionable decision or instruction</em>. The sat-nav tells you what to <em>do</em> and what the <em>outcome</em> is (save 4 minutes). In exam answers, the Knowledge layer is always your Impact statement.'
    }
  },
  {
    q: 'In the N.E.I. Method, the <strong style="color:var(--green);">[I] Impact</strong> mark corresponds to which layer of the data hierarchy?',
    options: [
      'Data — identifying the raw input',
      'Information — explaining what the data means',
      'Knowledge — stating the business outcome or decision made',
      'The [E] Explain layer — describing the mechanism',
    ],
    correct: 2,
    remedy: {
      label: 'Q4 — NEI and the data hierarchy',
      text: 'The [I] Impact mark is always the <strong>Knowledge layer</strong> — it answers "what does the business gain?" Examiners award the third mark for a stated business outcome: saved time, reduced cost, increased revenue, prevented loss. Without it you have N+E but no Knowledge, and you lose the mark most students drop.'
    }
  }
];

let kcCurrentQ = 0;
let kcScore    = 0;
let kcWrongQs  = [];
let kcPipState = ['active','','','']; // 'active' | 'done' | 'wrong' | ''

/* ─── OPEN ───────────────────────────────────────────────────────── */
function openKnowledgeCheck() {
  kcCurrentQ  = 0;
  kcScore     = 0;
  kcWrongQs   = [];
  kcPipState  = ['active','','',''];
  document.getElementById('kc-overlay').classList.add('active');
  kcRenderQuestion();
}

function closeKnowledgeCheck() {
  document.getElementById('kc-overlay').classList.remove('active');
}

/* ─── RENDER QUESTION (full innerHTML rebuild) ───────────────────── */
function kcRenderQuestion() {
  const q      = KC_QUESTIONS[kcCurrentQ];
  const letters = ['A','B','C','D'];

  const pipsHtml = kcPipState.map((state, i) =>
    `<div class="kc-pip ${state}" id="kc-pip-${i}"></div>`
  ).join('');

  const optionsHtml = q.options.map((text, idx) =>
    `<div class="kc-option" onclick="kcSelectAnswer(${idx})">
       <span class="kc-opt-letter">${letters[idx]}</span>${text}
     </div>`
  ).join('');

  document.getElementById('kc-body').innerHTML = `
    <div class="kc-progress-row">
      <div class="kc-pips">${pipsHtml}</div>
      <div class="kc-q-counter">QUESTION ${kcCurrentQ + 1} / 4</div>
    </div>
    <div class="kc-question">
      <span class="kc-q-label">Q${kcCurrentQ + 1} //</span>
      ${q.q}
    </div>
    <div class="kc-options" id="kc-options-wrap">
      ${optionsHtml}
    </div>
    <div id="kc-fb" style="display:none;" class="kc-instant-feedback"></div>
    <button class="kc-next-btn" id="kc-next-btn" style="display:none;" onclick="kcNextQuestion()">
      ${kcCurrentQ < 3 ? 'NEXT QUESTION ⟶' : 'SEE RESULTS ⟶'}
    </button>
  `;
}

/* ─── SELECT ANSWER ──────────────────────────────────────────────── */
function kcSelectAnswer(selectedIdx) {
  const q      = KC_QUESTIONS[kcCurrentQ];
  const isRight = selectedIdx === q.correct;
  const letters = ['A','B','C','D'];

  // Lock all options + style them
  const opts = document.querySelectorAll('#kc-options-wrap .kc-option');
  opts.forEach((el, i) => {
    el.onclick = null;
    el.style.cursor = 'default';
    if (i === selectedIdx)   el.classList.add(isRight ? 'correct' : 'wrong');
    if (!isRight && i === q.correct) el.classList.add('reveal-correct');
  });

  // Update pip state
  kcPipState[kcCurrentQ] = isRight ? 'done' : 'wrong';
  const pip = document.getElementById(`kc-pip-${kcCurrentQ}`);
  if (pip) { pip.className = `kc-pip ${kcPipState[kcCurrentQ]}`; }

  // Score tracking
  if (isRight) {
    kcScore++;
  } else {
    kcWrongQs.push(kcCurrentQ);
  }

  // Feedback
  const fb = document.getElementById('kc-fb');
  const correct_confirmations = [
    '✓ Correct — that\'s the examiner\'s definition.',
    '✓ Correct — you understand the distinction.',
    '✓ Correct — that\'s exactly how examiners frame it.',
    '✓ Correct — and that\'s your Impact mark secured.'
  ];
  fb.style.display = 'block';
  if (isRight) {
    fb.className = 'kc-instant-feedback correct-fb';
    fb.textContent = correct_confirmations[kcCurrentQ];
  } else {
    fb.className = 'kc-instant-feedback wrong-fb';
    fb.innerHTML = `✗ Not quite. The correct answer was <strong style="color:var(--green);">${letters[q.correct]}: ${q.options[q.correct]}</strong>. AXIOM-7 will debrief you after all four questions.`;
  }

  // Show next button
  document.getElementById('kc-next-btn').style.display = 'inline-block';
}

/* ─── NEXT QUESTION ──────────────────────────────────────────────── */
function kcNextQuestion() {
  kcCurrentQ++;
  if (kcCurrentQ < KC_QUESTIONS.length) {
    kcPipState[kcCurrentQ] = 'active';
    kcRenderQuestion();
  } else {
    kcShowResult();
  }
}

/* ─── SHOW RESULT ────────────────────────────────────────────────── */
function kcShowResult() {
  const passed = kcScore >= 3;

  let remediationHtml = '';
  if (!passed && kcWrongQs.length > 0) {
    const cards = kcWrongQs.map(idx => {
      const r = KC_QUESTIONS[idx].remedy;
      return `<div class="kc-remedy-card">
        <div class="remedy-q">▸ ${r.label}</div>
        <div class="remedy-text">${r.text}</div>
      </div>`;
    }).join('');
    remediationHtml = `
      <div class="kc-remediation">
        <div class="kc-remediation-title">▸ AXIOM-7 // TARGETED BRIEFING — GAPS IDENTIFIED</div>
        ${cards}
      </div>`;
  }

  document.getElementById('kc-body').innerHTML = `
    <div class="kc-result active">
      <div class="kc-result-icon">${passed ? '✅' : '⚠️'}</div>
      <div class="kc-result-title ${passed ? 'pass' : 'fail'}">
        ${passed ? 'PRIOR KNOWLEDGE CONFIRMED' : 'KNOWLEDGE GAP DETECTED'}
      </div>
      <div class="kc-result-score">
        SCORE: <span>${kcScore} / 4</span> — ${passed
          ? 'Proceeding to mission.'
          : `AXIOM-7 has identified ${kcWrongQs.length} gap${kcWrongQs.length > 1 ? 's' : ''} to address.`}
      </div>
      ${remediationHtml}
      <button class="kc-proceed-btn ${passed ? '' : 'gold-btn'}" onclick="kcProceed()">
        ${passed ? '⟶ ENTER THE MISSION' : '⟶ UNDERSTOOD — PROCEED TO MISSION'}
      </button>
    </div>
  `;
}

/* ─── PROCEED ────────────────────────────────────────────────────── */
function kcProceed() {
  const passed = kcScore >= 3;
  closeKnowledgeCheck();

  const overlay = document.getElementById('reboot-overlay');
  const line1   = document.getElementById('rb-line1');
  const line2   = document.getElementById('rb-line2');
  const bar     = document.getElementById('rb-bar');

  line1.style.opacity = '0';
  line2.style.opacity = '0';
  bar.style.transition = 'none';
  bar.style.width = '0%';

  line1.textContent = passed ? 'PRIOR KNOWLEDGE CONFIRMED' : 'GAPS ADDRESSED — KNOWLEDGE UPDATED';
  line2.textContent = passed ? 'CLEARANCE GRANTED — ENTERING MISSION' : 'PROCEEDING TO MISSION TERMINAL';

  overlay.style.display = 'flex';
  setTimeout(() => { line1.style.opacity = '1'; }, 100);
  setTimeout(() => { line2.style.opacity = '1'; }, 500);
  setTimeout(() => {
    bar.style.transition = `width ${passed ? '0.8s' : '1.0s'} ease`;
    bar.style.width = '100%';
  }, 700);
  setTimeout(() => {
    overlay.style.display = 'none';
    line1.style.opacity = '0';
    line2.style.opacity = '0';
    bar.style.transition = 'none';
    bar.style.width = '0%';
    goScene(2);
  }, passed ? 1600 : 1900);
}
</script>

<!-- ================================================================ -->
<div id="kc-overlay">
  <div class="kc-panel">
    <div class="corner-tl"></div>
    <div class="corner-br"></div>

    <!-- HEADER -->
    <div class="kc-header">
      <div class="kc-avatar">🤖</div>
      <div class="kc-header-text">
        <div class="kc-title">AXIOM-7 // DIAGNOSTIC CHECK</div>
        <div class="kc-sub">▸ CONTENT AREA 6.1.1 // PRIOR KNOWLEDGE SCAN // 4 QUESTIONS</div>
      </div>
    </div>
    <hr class="kc-divider">

    <!-- JS renders everything inside here -->
    <div id="kc-body"></div>

  </div>
</div>

</body>
</html>
